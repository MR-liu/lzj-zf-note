
        <h2 id="t0第1章 搭建开发环境">第1章 搭建开发环境 <a href="#t0第1章 搭建开发环境"> # </a></h2>
<h3 id="t11.1 本节目录">1.1 本节目录 <a href="#t11.1 本节目录"> # </a></h3>
<pre><code class="lang-js">-- client
    |-- package.json
    |-- public
    |   |-- index.html
    |-- src
    |   |-- index.tsx
    |-- tsconfig.json
    |-- webpack.config.js
</code></pre>
<h3 id="t21.2 初始化项目">1.2 初始化项目 <a href="#t21.2 初始化项目"> # </a></h3>
<pre><code class="lang-js">mkdir zfkt2020
cd zfkt2020
cnpm init -y
touch .gitignore
</code></pre>
<h3 id="t31.3 安装依赖">1.3 安装依赖 <a href="#t31.3 安装依赖"> # </a></h3>
<ul>
<li>@types开头的包都是typeScript的声明文件，可以进入node_modules/@types/XX/index.d.ts进行查看</li>
<li><a href="https://github.com/DefinitelyTyped/DefinitelyTyped">常见的声明文件</a></li>
<li><a href="https://ant.design/components/overview-cn/">ant.design</a></li>
</ul>
<pre><code class="lang-js">cnpm install react react-dom @types/react @types/react-dom react-router-dom @types/react-router-dom @ant-design/icons antd redux react-redux @types/react-redux redux-thunk  redux-logger @types/redux-logger redux-promise @types/redux-promise connected-react-router  classnames @types/classnames react-transition-group @types/react-transition-group express express-session body-parser cors axios  redux-persist immer redux-immer --save

cnpm install webpack webpack-cli webpack-dev-server html-webpack-plugin babel-loader typescript @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript  babel-plugin-<span class="hljs-keyword">import</span> style-loader css-loader postcss-loader less-loader less autoprefixer px2rem-loader  lib-flexible eslint @types/eslint --save-dev
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">模块名</th>
<th style="text-align:left">英文</th>
<th style="text-align:left">中文</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">react</td>
<td style="text-align:left">React is a JavaScript library for creating user interfaces.</td>
<td style="text-align:left">React 是一个用于创建用户界面的 JavaScript 库</td>
</tr>
<tr>
<td style="text-align:left">@types/react</td>
<td style="text-align:left">This package contains type definitions for React</td>
<td style="text-align:left">包含 React 的类型定义</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">react-dom</td>
<td style="text-align:left">This package serves as the entry point to the DOM and server renderers for React. It is intended to be paired with the generic React package, which is shipped as react to npm</td>
<td style="text-align:left">把 React 渲染到 DOM 上</td>
</tr>
<tr>
<td style="text-align:left">@types/react-dom</td>
<td style="text-align:left">This package contains type definitions for React (react-dom)</td>
<td style="text-align:left">包含 React (react-dom)的类型定义</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">react-router-dom</td>
<td style="text-align:left">DOM bindings for React Router</td>
<td style="text-align:left">React 路由的 DOM 渲染</td>
</tr>
<tr>
<td style="text-align:left">@types/react-router-dom</td>
<td style="text-align:left">This package contains type definitions for React Router</td>
<td style="text-align:left">React Router 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">react-transition-group</td>
<td style="text-align:left">A set of components for managing component states (including mounting and unmounting) over time, specifically designed with animation in mind</td>
<td style="text-align:left">一组用于随时间管理组件状态（包括安装和卸载）的组件，特别设计时考虑了动画</td>
</tr>
<tr>
<td style="text-align:left">@types/react-transition-group</td>
<td style="text-align:left">This package contains type definitions for react-transition-group</td>
<td style="text-align:left">react-transition-group 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">react-swipe</td>
<td style="text-align:left">Brad Birdsall's Swipe.js as a React component</td>
<td style="text-align:left">React 轮播图组件</td>
</tr>
<tr>
<td style="text-align:left">@types/react-swipe</td>
<td style="text-align:left">This package contains type definitions for react-swipe</td>
<td style="text-align:left">React 轮播图组件的类型定义</td>
</tr>
<tr>
<td style="text-align:left">antd</td>
<td style="text-align:left">An enterprise-class UI design language and React UI library</td>
<td style="text-align:left">企业级 UI 设计语言和 React UI 库</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">qs</td>
<td style="text-align:left">A querystring parsing and stringifying library with some added security</td>
<td style="text-align:left">一个带有一些附加安全性的 querystring 解析和字符串化库</td>
</tr>
<tr>
<td style="text-align:left">@types/qs</td>
<td style="text-align:left">This package contains type definitions for qs</td>
<td style="text-align:left">该软件包包含 qs 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">webpack</td>
<td style="text-align:left">webpack is a module bundler. Its main purpose is to bundle JavaScript files for usage in a browser, yet it is also capable of transforming, bundling, or packaging just about any resource or asset.</td>
<td style="text-align:left">webpack 是一个模块打包器。它的主要目的是打包 JavaScript 文件以在浏览器中使用，但它也能够转换或打包几乎任何资源</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">webpack-cli</td>
<td style="text-align:left">webpack CLI provides a flexible set of commands for developers to increase speed when setting up a custom webpack project. As of webpack v4, webpack is not expecting a configuration file, but often developers want to create a more custom webpack configuration based on their use-cases and needs. webpack CLI addresses these needs by providing a set of tools to improve the setup of custom webpack configuration.</td>
<td style="text-align:left">webpack cli 提供了一组灵活的命令，供开发人员在设置自定义 webpack 项目时提高速度</td>
</tr>
<tr>
<td style="text-align:left">webpack-dev-server</td>
<td style="text-align:left">Use webpack with a development server that provides live reloading. This should be used for development only</td>
<td style="text-align:left">将 webpack 与提供实时重载的开发服务器一起使用。 这应该仅用于开发</td>
</tr>
<tr>
<td style="text-align:left">html-webpack-plugin</td>
<td style="text-align:left">Plugin that simplifies creation of HTML files to serve your bundles</td>
<td style="text-align:left">简化 HTML 文件的创建插件</td>
</tr>
<tr>
<td style="text-align:left">ts-import-plugin</td>
<td style="text-align:left">Modular import plugin for TypeScript, compatible with antd, antd-mobile and so on</td>
<td style="text-align:left">用于 TypeScript 的模块化导入插件，与 antd，antd-mobile 等兼容</td>
</tr>
<tr>
<td style="text-align:left">typescript</td>
<td style="text-align:left">TypeScript is a language for application-scale JavaScript</td>
<td style="text-align:left">TypeScript 是用于应用程序级 JavaScript 的语言</td>
</tr>
<tr>
<td style="text-align:left">ts-loader</td>
<td style="text-align:left">TypeScript loader for webpack</td>
<td style="text-align:left">用于 Webpack 的 TypeScript 加载器</td>
</tr>
<tr>
<td style="text-align:left">source-map-loader</td>
<td style="text-align:left">Extracts source maps from existing source files (from their sourceMappingURL)</td>
<td style="text-align:left">从现有源文件(从其 sourceMappingURL)中提取源映射</td>
</tr>
<tr>
<td style="text-align:left">style-loader</td>
<td style="text-align:left">Inject CSS into the DOM</td>
<td style="text-align:left">将 CSS 注入 DOM</td>
</tr>
<tr>
<td style="text-align:left">css-loader</td>
<td style="text-align:left">The css-loader interprets @import and url() like import/require() and will resolve them</td>
<td style="text-align:left">css-loader 会像 importt()/require()一样解释@import 和 url 并将解析它们</td>
<td>把 less 编译成 CSS</td>
</tr>
<tr>
<td style="text-align:left">less-loader</td>
<td style="text-align:left">A Less loader for webpack. Compiles Less to CSS</td>
<td style="text-align:left">把 less 编译成 CSS</td>
</tr>
<tr>
<td style="text-align:left">less</td>
<td style="text-align:left">This is the JavaScript, official, stable version of Less</td>
<td style="text-align:left">这是 Less 的 JavaScript 官方稳定版本</td>
</tr>
<tr>
<td style="text-align:left">url-loader</td>
<td style="text-align:left">A loader for webpack which transforms files into base64 URIs</td>
<td style="text-align:left">Webpack 的加载程序，可将文件转换为 base64 URI</td>
</tr>
<tr>
<td style="text-align:left">file-loader</td>
<td style="text-align:left">The file-loader resolves import/require() on a file into a url and emits the file into the output directory</td>
<td style="text-align:left">将文件上的 import()/require()解析为 url 并将文件写入到输出目录中</td>
</tr>
<tr>
<td style="text-align:left">autoprefixer</td>
<td style="text-align:left">PostCSS plugin to parse CSS and add vendor prefixes to CSS rules using values from Can I Use. It is recommended by Google and used in Twitter and Alibaba</td>
<td style="text-align:left">根据<code>can i use</code>网站的 CSS 规则给 CSS 规则添加厂商前缀</td>
</tr>
<tr>
<td style="text-align:left">px2rem-loader</td>
<td style="text-align:left">a webpack loader for px2rem</td>
<td style="text-align:left">px2rem 的 Webpack 加载器</td>
</tr>
<tr>
<td style="text-align:left">postcss-loader</td>
<td style="text-align:left">Loader for webpack to process CSS with PostCSS</td>
<td style="text-align:left">用于 webpack 的 Loader 以使用 PostCSS 处理 CSS</td>
</tr>
<tr>
<td style="text-align:left">lib-flexible</td>
<td style="text-align:left">可伸缩布局解决方案</td>
</tr>
<tr>
<td style="text-align:left">redux</td>
<td style="text-align:left">Redux is a predictable state container for JavaScript apps</td>
<td style="text-align:left">Redux 是 JavaScript 应用程序的可预测状态容器</td>
</tr>
<tr>
<td style="text-align:left">react-redux</td>
<td style="text-align:left">Official React bindings for Redux</td>
<td style="text-align:left">Redux 的官方 React 绑定</td>
</tr>
<tr>
<td style="text-align:left">@types/react-redux</td>
<td style="text-align:left">his package contains type definitions for react-redux</td>
<td style="text-align:left">该软件包包含 react-redux 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">redux-thunk</td>
<td style="text-align:left">Thunk middleware for Redux</td>
<td style="text-align:left">用于 Redux 的 Thunk 中间件</td>
</tr>
<tr>
<td style="text-align:left">redux-logger</td>
<td style="text-align:left">Logger for Redux</td>
<td style="text-align:left">用于 Redux 的 logger 中间件</td>
</tr>
<tr>
<td style="text-align:left">@types/redux-logger</td>
<td style="text-align:left">This package contains type definitions for redux-logger</td>
<td style="text-align:left">该软件包包含 redux-logger 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">redux-promise</td>
<td style="text-align:left">FSA-compliant promise middleware for Redux.</td>
<td style="text-align:left">符合 FSA 的 Redux 的 promise 中间件</td>
</tr>
<tr>
<td style="text-align:left">@types/redux-promise</td>
<td style="text-align:left">This package contains type definitions for redux-promise</td>
<td style="text-align:left">该软件包包含 redux-promise 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">immer</td>
<td style="text-align:left">Create the next immutable state tree by simply modifying the current tree</td>
<td style="text-align:left">通过简单地修改当前树来创建下一个不可变状态树</td>
</tr>
<tr>
<td style="text-align:left">redux-immer</td>
<td style="text-align:left">redux-immer is used to create an equivalent function of Redux combineReducers that works with immer state.</td>
<td style="text-align:left">redux-immer 用于创建<code>Redux combineReducers</code>的等效功能，该功能可与<code>immer</code>状态一起使用</td>
</tr>
<tr>
<td style="text-align:left">connected-react-router</td>
<td style="text-align:left">A Redux binding for React Router v4 and v5</td>
<td style="text-align:left">用于 React Router v4 和 v5 的 Redux 绑定</td>
</tr>
</tbody>
</table>
<h3 id="t41.4 支持 typescript">1.4 支持 typescript <a href="#t41.4 支持 typescript"> # </a></h3>
<ul>
<li>需要生成一个tsconfig.json文件来告诉ts-loader如何编译代码TypeScript代码</li>
</ul>
<pre><code class="lang-js">tsc --init
</code></pre>
<pre><code class="lang-json">{
  <span class="hljs-attr">"compilerOptions"</span>: {
    <span class="hljs-attr">"moduleResolution"</span>:<span class="hljs-string">"Node"</span>,
    <span class="hljs-attr">"outDir"</span>: <span class="hljs-string">"./dist"</span>,
    <span class="hljs-attr">"sourceMap"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"noImplicitAny"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"module"</span>: <span class="hljs-string">"ESNext"</span>,
    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"es5"</span>,
    <span class="hljs-attr">"jsx"</span>: <span class="hljs-string">"react"</span>,
    <span class="hljs-attr">"esModuleInterop"</span>:<span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">"include"</span>: [
    <span class="hljs-string">"./src/**/*"</span>
  ]
}
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">项目</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">outDir</td>
<td style="text-align:left">指定输出目录</td>
</tr>
<tr>
<td style="text-align:left">sourceMap</td>
<td style="text-align:left">把 ts 文件编译成 js 文件的时候，同时生成对应的 sourceMap 文件</td>
</tr>
<tr>
<td style="text-align:left">noImplicitAny</td>
<td style="text-align:left">如果为 true 的话，TypeScript 编译器无法推断出类型时，它仍然会生成 JavaScript 文件，但是它也会报告一个错误</td>
</tr>
<tr>
<td style="text-align:left">module：代码规范</td>
<td style="text-align:left">target：转换成 es5</td>
</tr>
<tr>
<td style="text-align:left">jsx</td>
<td style="text-align:left">react 模式会生成 React.createElement，在使用前不需要再进行转换操作了，输出文件的扩展名为.js</td>
</tr>
<tr>
<td style="text-align:left">include</td>
<td style="text-align:left">需要编译的目录</td>
</tr>
<tr>
<td style="text-align:left">allowSyntheticDefaultImports</td>
<td style="text-align:left">允许从没有设置默认导出的模块中默认导入。这并不影响代码的输出，仅为了类型检查。</td>
</tr>
<tr>
<td style="text-align:left">esModuleInterop</td>
<td style="text-align:left">设置 esModuleInterop: true 使 typescript 来兼容所有模块方案的导入</td>
</tr>
</tbody>
</table>
<blockquote>
<p>在 TypeScript 中，有多种 import 的方式，分别对应了 JavaScript 中不同的 export</p>
</blockquote>
<pre><code class="lang-js"><span class="hljs-comment">// commonjs 模块</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> xx <span class="hljs-keyword">from</span> <span class="hljs-string">"xx"</span>;
<span class="hljs-comment">// 标准 es6 模块</span>
<span class="hljs-keyword">import</span> xx <span class="hljs-keyword">from</span> <span class="hljs-string">"xx"</span>;
</code></pre>
<h3 id="t51.5 编写 webpack 配置文件">1.5 编写 webpack 配置文件 <a href="#t51.5 编写 webpack 配置文件"> # </a></h3>
<p>webpack.config.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);
<span class="hljs-keyword">const</span> HtmlWebpackPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"html-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-comment">//process.env.NODE_ENV == 'production' ? 'production' : 'development';</span>
<span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">mode</span>: process.env.NODE_ENV == <span class="hljs-string">"production"</span> ? <span class="hljs-string">"production"</span> : <span class="hljs-string">"development"</span>, <span class="hljs-comment">//默认是开发模块</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.tsx"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.join(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"main.js"</span>,
  },
  <span class="hljs-attr">devtool</span>: <span class="hljs-string">"source-map"</span>,
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">hot</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//热更新插件</span>
    <span class="hljs-attr">contentBase</span>: path.join(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">historyApiFallback</span>: {
      <span class="hljs-comment">//browserHistory的时候，刷新会报404. 自动重定向到index.html</span>
      <span class="hljs-attr">index</span>: <span class="hljs-string">"./index.html"</span>,
    },
  },
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">"@"</span>: path.resolve(__dirname, <span class="hljs-string">"src"</span>),
      <span class="hljs-string">"~"</span>: path.resolve(__dirname, <span class="hljs-string">"node_modules"</span>),
    },
    <span class="hljs-comment">//当你加载一个文件的时候,没有指定扩展名的时候，会自动寻找哪些扩展名</span>
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">".ts"</span>, <span class="hljs-string">".tsx"</span>, <span class="hljs-string">".js"</span>, <span class="hljs-string">".json"</span>],
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(j|t)sx?$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">"babel-loader"</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-attr">presets</span>:[
            <span class="hljs-string">'@babel/preset-env'</span>,
            <span class="hljs-string">'@babel/preset-react'</span>,
            <span class="hljs-string">'@babel/preset-typescript'</span>
          ],
          <span class="hljs-attr">plugins</span>: [<span class="hljs-comment">//默认引less,我们引css</span>
            [<span class="hljs-string">'import'</span>, { <span class="hljs-attr">libraryName</span>: <span class="hljs-string">'antd'</span>, <span class="hljs-attr">style</span>: <span class="hljs-string">'css'</span> }]
          ]
        },
        <span class="hljs-attr">include</span>:path.resolve(<span class="hljs-string">'src'</span>),
        <span class="hljs-attr">exclude</span>:<span class="hljs-regexp">/node_modules/</span>
      },
      {<span class="hljs-comment">//引入antdesign中用的css</span>
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">"style-loader"</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">"css-loader"</span>,
            <span class="hljs-attr">options</span>: { <span class="hljs-attr">importLoaders</span>: <span class="hljs-number">0</span> },
          }
        ]
      },
      {<span class="hljs-comment">//我们自己的代码都是less</span>
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.less$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">"style-loader"</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">"css-loader"</span>,
            <span class="hljs-attr">options</span>: { <span class="hljs-attr">importLoaders</span>: <span class="hljs-number">3</span> },
          },
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">"postcss-loader"</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">postcssOptions</span>: {
                <span class="hljs-attr">plugins</span>: [
                  <span class="hljs-string">"autoprefixer"</span>
                ],
              }
            },
          },
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">"px2rem-loader"</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">remUnit</span>: <span class="hljs-number">75</span>,
              <span class="hljs-attr">remPrecesion</span>: <span class="hljs-number">8</span>,
            },
          },
          <span class="hljs-string">"less-loader"</span>,
        ],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(jpg|png|gif|svg|jpeg)$/</span>,
        <span class="hljs-attr">type</span>:<span class="hljs-string">'asset'</span>
      },
    ],
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> HtmlWebpackPlugin({
      <span class="hljs-attr">template</span>: <span class="hljs-string">"./public/index.html"</span>,
    }),
    <span class="hljs-keyword">new</span> webpack.HotModuleReplacementPlugin(),
  ],
};
</code></pre>
<h3 id="t61.6 src\index.tsx">1.6 src\index.tsx <a href="#t61.6 src\index.tsx"> # </a></h3>
<p>src\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom"</span>;
ReactDOM.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>,<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"root"</span>));
</code></pre>
<h3 id="t71.7 public\index.html">1.7 public\index.html <a href="#t71.7 public\index.html"> # </a></h3>
<p>public\index.html</p>
<pre><code class="lang-html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>珠峰课堂<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-keyword">let</span> docEle = <span class="hljs-built_in">document</span>.documentElement;
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setRemUnit</span>(<span class="hljs-params"></span>) </span>{
        docEle.style.fontSize = docEle.clientWidth / <span class="hljs-number">10</span> + <span class="hljs-string">"px"</span>;
      }
      setRemUnit();
      <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">"resize"</span>, setRemUnit);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 id="t81.8 package.json">1.8 package.json <a href="#t81.8 package.json"> # </a></h3>
<pre><code class="lang-json">  "scripts": {
    "build": "webpack",
    "dev": "webpack serve",
    "lint": "eslint --ext .tsx src --fix",
  }
</code></pre>
<h2 id="t9第2天 实现底部路由">第2天 实现底部路由 <a href="#t9第2天 实现底部路由"> # </a></h2>
<ul>
<li>这一章我们开始配置路由,我们的应用在尾部有三个页签,分别对应首页,购物车和个人中心三个页面</li>
<li>在本章节我们实践以下内容<ul>
<li><ol>
<li>如何使用 react 全家桶配置路由</li>
</ol>
</li>
<li><ol start="2">
<li>如何按需加载<code>antd</code>并使用图标组件</li>
</ol>
</li>
<li><ol start="3">
<li>如何在 react 样式中使用<code>less</code>编写样式</li>
</ol>
</li>
<li><ol start="4">
<li>如何在移动端中使用 <code>rem</code> 实现布局以及如何使用 <code>flex</code>布局</li>
</ol>
</li>
<li><ol start="5">
<li>如何使用 typescript 编写 react 代码</li>
</ol>
</li>
</ul>
</li>
</ul>
<p>本章目录</p>
<pre><code class="lang-js">├── package.json
├── public
│   └── index.html
├── src
│   ├── assets
│   │   └── css
│   │       └── common.less
│   ├── components
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   └── Profile
│   │       └── index.tsx
│   └── store
│       ├── action-types.tsx
│       ├── history.tsx
│       ├── index.tsx
│       └── reducers
│           ├── home.tsx
│           ├── index.tsx
│           ├── mine.tsx
│           └── profile.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<p>本章效果预览</p>
<p><img src="http://img.zhufengpeixun.cn/zhufengketang_day1.gif" alt="day1"></p>
<p>页面布局
<img src="https://img.zhufengpeixun.com/tabs.png" alt="tabs"></p>
<h3 id="t102.1 src\index.tsx">2.1 src\index.tsx <a href="#t102.1 src\index.tsx"> # </a></h3>
<p>src\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom"</span>;
<span class="hljs-keyword">import</span> { Switch, Route, Redirect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> { Provider } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">"./store"</span>;
<span class="hljs-keyword">import</span> { ConfigProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> zh_CN <span class="hljs-keyword">from</span> <span class="hljs-string">"antd/lib/locale-provider/zh_CN"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./assets/css/common.less"</span>;
<span class="hljs-keyword">import</span> Tabs <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/Tabs"</span>;
<span class="hljs-keyword">import</span> Home <span class="hljs-keyword">from</span> <span class="hljs-string">"./routes/Home"</span>;
<span class="hljs-keyword">import</span> Mine <span class="hljs-keyword">from</span> <span class="hljs-string">"./routes/Mine"</span>;
<span class="hljs-keyword">import</span> Profile <span class="hljs-keyword">from</span> <span class="hljs-string">"./routes/Profile"</span>;
<span class="hljs-keyword">import</span> { ConnectedRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">"connected-react-router"</span>;
<span class="hljs-keyword">import</span> history <span class="hljs-keyword">from</span> <span class="hljs-string">"./store/history"</span>;
ReactDOM.render(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ConnectedRouter</span> <span class="hljs-attr">history</span>=<span class="hljs-string">{history}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">{zh_CN}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"main-container"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Switch</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">exact</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{Home}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/Mine"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{Mine}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/profile"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{Profile}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Switch</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ConnectedRouter</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>,
  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"root"</span>)
);
</code></pre>
<h3 id="t112.2 common.less">2.2 common.less <a href="#t112.2 common.less"> # </a></h3>
<p>src\assets\css\common.less</p>
<pre><code class="lang-less">*{
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
}
<span class="hljs-selector-tag">ul</span>,<span class="hljs-selector-tag">li</span>{
    <span class="hljs-attribute">list-style</span>: none;
}
<span class="hljs-selector-id">#root</span>{
    <span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> auto;
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">750px</span>;
    <span class="hljs-attribute">box-sizing</span>: border-box;
}
<span class="hljs-selector-class">.main-container</span>{
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">100px</span> <span class="hljs-number">0</span> <span class="hljs-number">120px</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 id="t122.3 Tabs\index.tsx">2.3 Tabs\index.tsx <a href="#t122.3 Tabs\index.tsx"> # </a></h3>
<p>src\components\Tabs\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { withRouter, NavLink } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> {HomeOutlined,ShoppingCartOutlined,UserOutlined} <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/icons"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Tabs</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> <span class="hljs-attr">exact</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HomeOutlined</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/cart"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ShoppingCartOutlined</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>购物车<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/profile"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">UserOutlined</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>个人中心<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span></span>
  );
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> withRouter(Tabs);
</code></pre>
<h3 id="t132.4 Tabs\index.less">2.4 Tabs\index.less <a href="#t132.4 Tabs\index.less"> # </a></h3>
<p>src\components\Tabs\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-tag">footer</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">120px</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#d5d5d5</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#000</span>;
    <span class="hljs-selector-tag">span</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-class">.anticon</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">50px</span>;
      }
    }
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">color</span>: blue;
      <span class="hljs-attribute">font-weight</span>: bold;
    }
  }
}
</code></pre>
<h3 id="t142.5 history.tsx">2.5 history.tsx <a href="#t142.5 history.tsx"> # </a></h3>
<p>src\store\history.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">"history"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createHashHistory();
</code></pre>
<h3 id="t152.6 action-types.tsx">2.6 action-types.tsx <a href="#t152.6 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ADD = <span class="hljs-string">"ADD"</span>;
</code></pre>
<h3 id="t162.7 reducers\home.tsx">2.7 reducers\home.tsx <a href="#t162.7 reducers\home.tsx"> # </a></h3>
<p>src\store\reducers\home.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"redux"</span>;
<span class="hljs-keyword">export</span> interface HomeState {}
<span class="hljs-keyword">let</span> initialState: HomeState = {};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  state: HomeState = initialState,
  action: AnyAction
</span>): <span class="hljs-title">HomeState</span> </span>{
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}
</code></pre>
<h3 id="t172.8 reducers\mine.tsx">2.8 reducers\mine.tsx <a href="#t172.8 reducers\mine.tsx"> # </a></h3>
<p>src\store\reducers\mine.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"redux"</span>;
<span class="hljs-keyword">export</span> interface MineState {}
<span class="hljs-keyword">let</span> initialState: MineState = {};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  state: MineState = initialState,
  action: AnyAction
</span>): <span class="hljs-title">MineState</span> </span>{
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}
</code></pre>
<h3 id="t182.9 reducers\profile.tsx">2.9 reducers\profile.tsx <a href="#t182.9 reducers\profile.tsx"> # </a></h3>
<p>src\store\reducers\profile.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"redux"</span>;
<span class="hljs-keyword">export</span> interface ProfileState {}
<span class="hljs-keyword">let</span> initialState: ProfileState = {};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  state: ProfileState = initialState,
  action: AnyAction
</span>): <span class="hljs-title">ProfileState</span> </span>{
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}
</code></pre>
<h3 id="t192.10 reducers\index.tsx">2.10 reducers\index.tsx <a href="#t192.10 reducers\index.tsx"> # </a></h3>
<p>src\store\reducers\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { combineReducers, ReducersMapObject, Reducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>;
<span class="hljs-keyword">import</span> { connectRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'connected-react-router'</span>;
<span class="hljs-keyword">import</span> history <span class="hljs-keyword">from</span> <span class="hljs-string">'../history'</span>;
<span class="hljs-keyword">import</span> home <span class="hljs-keyword">from</span> <span class="hljs-string">'./home'</span>;
<span class="hljs-keyword">import</span> mine <span class="hljs-keyword">from</span> <span class="hljs-string">'./mine'</span>;
<span class="hljs-keyword">import</span> profile <span class="hljs-keyword">from</span> <span class="hljs-string">'./profile'</span>;
<span class="hljs-keyword">let</span> reducers: ReducersMapObject = {
    <span class="hljs-attr">router</span>: connectRouter(history),
    home,
    mine,
    profile,
};
type CombinedState = {
    [key <span class="hljs-keyword">in</span> keyof <span class="hljs-keyword">typeof</span> reducers]: ReturnType&lt;<span class="hljs-keyword">typeof</span> reducers[key]&gt;
}
<span class="hljs-keyword">let</span> reducer: Reducer&lt;CombinedState&gt; = combineReducers&lt;CombinedState&gt;(reducers);

<span class="hljs-keyword">export</span> { CombinedState }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> reducer;
</code></pre>
<h3 id="t202.11 store\index.tsx">2.11 store\index.tsx <a href="#t202.11 store\index.tsx"> # </a></h3>
<p>src\store\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createStore, applyMiddleware, Store, AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>;
<span class="hljs-keyword">import</span> reducers <span class="hljs-keyword">from</span> <span class="hljs-string">'./reducers'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-logger'</span>;
<span class="hljs-keyword">import</span> thunk <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-thunk'</span>;
<span class="hljs-keyword">import</span> promise <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-promise'</span>;
<span class="hljs-keyword">import</span> { routerMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'connected-react-router'</span>;
<span class="hljs-keyword">import</span> history <span class="hljs-keyword">from</span> <span class="hljs-string">'./history'</span>;
<span class="hljs-keyword">let</span> store = applyMiddleware(thunk, routerMiddleware(history), promise, logger)(createStore)(reducers);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store;
</code></pre>
<h3 id="t212.12 Home\index.tsx">2.12 Home\index.tsx <a href="#t212.12 Home\index.tsx"> # </a></h3>
<p>src\routes\Home\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { PropsWithChildren } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
interface Params {}
type Props = PropsWithChildren&lt;RouteComponentProps&lt;Params&gt;&gt;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Home</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect()(Home);
</code></pre>
<h3 id="t222.13 Mine\index.tsx">2.13 Mine\index.tsx <a href="#t222.13 Mine\index.tsx"> # </a></h3>
<p>src\routes\Mine\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { PropsWithChildren } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
interface Params {}
type Props = PropsWithChildren&lt;RouteComponentProps&lt;Params&gt;&gt;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Mine</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Mine<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect()(Mine);
</code></pre>
<h3 id="t232.14 Profile\index.tsx">2.14 Profile\index.tsx <a href="#t232.14 Profile\index.tsx"> # </a></h3>
<p>src\routes\Profile\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { PropsWithChildren } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
interface Params {}
type Props = PropsWithChildren&lt;RouteComponentProps&lt;Params&gt;&gt;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Profile</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Profile<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect()(Profile);
</code></pre>
<h2 id="t24第3章 实现首页头部导航">第3章 实现首页头部导航 <a href="#t24第3章 实现首页头部导航"> # </a></h2>
<ul>
<li>本章我们将要实现首页的头部导航</li>
<li>本章我们要掌握的知识点<ul>
<li>配置 ts 能识别的路径别名</li>
<li>如何在 ts 中导入图片</li>
<li>React 动画库的使用</li>
<li>如何创建 redux 仓库以及如何关联组件</li>
</ul>
</li>
</ul>
<h3 id="t253.1 资料">3.1 资料 <a href="#t253.1 资料"> # </a></h3>
<h4 id="t263.1.1 文档">3.1.1 文档 <a href="#t263.1.1 文档"> # </a></h4>
<ul>
<li><a href="https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/react/index.d.ts">react类型声明</a></li>
</ul>
<h4 id="t273.1.2 logo图">3.1.2 logo图 <a href="#t273.1.2 logo图"> # </a></h4>
<p><img src="https://img.zhufengpeixun.com/logo.png" alt="logo"></p>
<h4 id="t283.1.3 本章代码">3.1.3 本章代码 <a href="#t283.1.3 本章代码"> # </a></h4>
<pre><code class="lang-js">├── package.json
├── public
│   └── index.html
├── src
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   └── HomeHeader
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   └── Profile
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   └── home.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   └── typings
│       └── images.d.ts
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t293.1.4 效果预览">3.1.4 效果预览 <a href="#t293.1.4 效果预览"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/homenavigation.gif" alt="homenavigation"></p>
<h4 id="t303.1.5 本章布局">3.1.5 本章布局 <a href="#t303.1.5 本章布局"> # </a></h4>
<p><img src="https://img.zhufengpeixun.com/home-header.png" alt="home-header.png"></p>
<h3 id="t313.2 tsconfig.json">3.2 tsconfig.json <a href="#t313.2 tsconfig.json"> # </a></h3>
<ul>
<li>使用 typescript 开发项目时，为了提高开发体验，经常会配置<code>paths</code>映射模块路径</li>
</ul>
<p>tsconfig.json</p>
<pre><code class="lang-diff">  "compilerOptions": {
<span class="hljs-addition">+    "baseUrl": ".",  // 解析非相对模块的基地址，默认是当前目录</span>
<span class="hljs-addition">+    "paths": {       // 路径映射，相对于baseUrl</span>
<span class="hljs-addition">+      "@/*": ["./src/*" ] //把@映射为src目录</span>
<span class="hljs-addition">+    }</span>
  },
</code></pre>
<h3 id="t323.3 images.d.ts">3.3 images.d.ts <a href="#t323.3 images.d.ts"> # </a></h3>
<p>src\typings\images.d.ts</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * 如果在js中引入本地静态资源图片时使用import img from './img/logo.png'这种写法是没有问题的
 * 但是在typescript中是无法识别非代码资源的，所以会报错TS2307: cannot find module '.png'
 * 因此，我们需要主动的去声明这个module
 * 新建一个ts声明文件如：images.d.ts就可以了,这样ts就可以识别svg、png、jpg等等图片类型文件
 * 项目编译过程中会自动去读取.d.ts这种类型的文件，所以不需要我们手动地加载他们
 * 当然.d.ts文件也不能随便放置在项目中，这类文件和ts文件一样需要被typescript编译，所以一样只能放置在tsconfig.json中include属性所配置的文件夹下
 * 
 */</span>
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.svg'</span>;
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.png'</span>;
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.jpg'</span>;
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.jpeg'</span>;
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.gif'</span>;
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.bmp'</span>;
declare <span class="hljs-built_in">module</span> <span class="hljs-string">'*.tiff'</span>;
</code></pre>
<h3 id="t333.4 HomeHeader\index.tsx">3.4 HomeHeader\index.tsx <a href="#t333.4 HomeHeader\index.tsx"> # </a></h3>
<p>src\routes\Home\components\HomeHeader\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { useState, CSSProperties } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> {BarsOutlined} <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/icons'</span>;
<span class="hljs-keyword">import</span> classnames <span class="hljs-keyword">from</span> <span class="hljs-string">'classnames'</span>;
<span class="hljs-keyword">import</span> { Transition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-transition-group'</span>;
<span class="hljs-comment">//ts默认不支持png格式,需要添加images.d.ts声明文件以支持加载png</span>
<span class="hljs-keyword">import</span> logo <span class="hljs-keyword">from</span> <span class="hljs-string">'@/assets/images/logo.png'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.less'</span>;
<span class="hljs-keyword">const</span> duration = <span class="hljs-number">1000</span>;
<span class="hljs-comment">//默认样式</span>
<span class="hljs-keyword">const</span> defaultStyle = {
    <span class="hljs-attr">transition</span>: <span class="hljs-string">`opacity <span class="hljs-subst">${duration}</span>ms ease-in-out`</span>,
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>,
}
interface TransitionStyles {
    <span class="hljs-attr">entering</span>: CSSProperties;<span class="hljs-comment">//进入时的样式</span>
    entered: CSSProperties;<span class="hljs-comment">//进入成功时的样式</span>
    exiting: CSSProperties;<span class="hljs-comment">//退出时的样式</span>
    exited: CSSProperties;<span class="hljs-comment">//退出成功时的样式</span>
}
<span class="hljs-keyword">const</span> transitionStyles: TransitionStyles = {
    <span class="hljs-attr">entering</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span> },<span class="hljs-comment">//不透明度为1</span>
    <span class="hljs-attr">entered</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span> }, <span class="hljs-comment">//不透明度为1</span>
    <span class="hljs-attr">exiting</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span> }, <span class="hljs-comment">//不透明度为0</span>
    <span class="hljs-attr">exited</span>: { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span> },  <span class="hljs-comment">//不透明度为0</span>
};


interface Props {
    <span class="hljs-attr">currentCategory</span>: string;<span class="hljs-comment">//当前选中的分类 此数据会放在redux仓库中</span>
    setCurrentCategory: <span class="hljs-function">(<span class="hljs-params">currentCategory: string</span>) =&gt;</span> any;<span class="hljs-comment">// 改变仓库中的分类</span>
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">HomeHeader</span>(<span class="hljs-params">props: Props</span>) </span>{
    <span class="hljs-keyword">let</span> [isMenuVisible, setIsMenuVisible] = useState(<span class="hljs-literal">false</span>);<span class="hljs-comment">//设定标识位表示菜单是否显示</span>
    <span class="hljs-comment">//设置当前分类,把当前选中的分类传递给redux仓库</span>
    <span class="hljs-keyword">const</span> setCurrentCategory = <span class="hljs-function">(<span class="hljs-params">event: React.MouseEvent&lt;HTMLUListElement&gt;</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> target: HTMLUListElement = event.target <span class="hljs-keyword">as</span> HTMLUListElement;
        <span class="hljs-keyword">let</span> category = target.dataset.category;<span class="hljs-comment">//获取用户选择的分类名称</span>
        props.setCurrentCategory(category);<span class="hljs-comment">//设置分类名称</span>
        setIsMenuVisible(<span class="hljs-literal">false</span>);<span class="hljs-comment">//关闭分类选择层</span>
    }
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"home-header"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"logo-header"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{logo}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">BarsOutlined</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsMenuVisible(!isMenuVisible)} /&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Transition</span> <span class="hljs-attr">in</span>=<span class="hljs-string">{isMenuVisible}</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">{duration}</span>&gt;</span>
                {
                    (state: keyof TransitionStyles) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>
                            <span class="hljs-attr">className</span>=<span class="hljs-string">"category"</span>
                            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{setCurrentCategory}</span>
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
                                <span class="hljs-attr">...defaultStyle</span>,
                                <span class="hljs-attr">...transitionStyles</span>[<span class="hljs-attr">state</span>]
                            }}
                        &gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"all"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{classnames({</span> <span class="hljs-attr">active:</span> <span class="hljs-attr">props.currentCategory</span> === <span class="hljs-string">'all'</span> })}&gt;</span>全部课程<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"react"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{classnames({</span> <span class="hljs-attr">active:</span> <span class="hljs-attr">props.currentCategory</span> === <span class="hljs-string">'react'</span> })}&gt;</span>React课程<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">data-category</span>=<span class="hljs-string">"vue"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{classnames({</span> <span class="hljs-attr">active:</span> <span class="hljs-attr">props.currentCategory</span> === <span class="hljs-string">'vue'</span> })}&gt;</span>Vue课程<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                    )
                }
            <span class="hljs-tag">&lt;/<span class="hljs-name">Transition</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> HomeHeader;
</code></pre>
<h3 id="t343.5 HomeHeader\index.less">3.5 HomeHeader\index.less <a href="#t343.5 HomeHeader\index.less"> # </a></h3>
<p>src\routes\Home\components\HomeHeader\index.less</p>
<pre><code class="lang-less"><span class="hljs-variable">@BG:</span> <span class="hljs-number">#2a2a2a</span>;
<span class="hljs-selector-class">.home-header</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">999</span>;
  <span class="hljs-selector-class">.logo-header</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-variable">@BG</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: space-between;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-selector-tag">img</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;
    }
    <span class="hljs-selector-tag">span</span><span class="hljs-selector-class">.anticon</span><span class="hljs-selector-class">.anticon-bars</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">20px</span>;
    }
  }
  <span class="hljs-selector-class">.category</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-variable">@BG</span>;
    <span class="hljs-selector-tag">li</span> {
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid lighten(<span class="hljs-variable">@BG</span>, <span class="hljs-number">20%</span>);
      <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-class">.active</span> {
        <span class="hljs-attribute">color</span>: red;
      }
    }
  }
}
</code></pre>
<h3 id="t353.6 action-types.tsx">3.6 action-types.tsx <a href="#t353.6 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">//设置当前分类的名称
<span class="hljs-addition">+export const SET_CURRENT_CATEGORY = 'SET_CURRENT_CATEGORY';</span>
</code></pre>
<h3 id="t363.7 reducers\home.tsx">3.7 reducers\home.tsx <a href="#t363.7 reducers\home.tsx"> # </a></h3>
<p>src\store\reducers\home.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from 'redux';
<span class="hljs-addition">+import * as TYPES from "../action-types";</span>
export interface HomeState {
<span class="hljs-addition">+    currentCategory: string;</span>
}
let initialState: HomeState = {
<span class="hljs-addition">+    currentCategory: 'all'//默认当前的分类是显示全部类型的课程</span>
};
export default function (state: HomeState = initialState, action: AnyAction): HomeState {
    switch (action.type) {
<span class="hljs-addition">+        case TYPES.SET_CURRENT_CATEGORY://修改当前分类</span>
<span class="hljs-addition">+            return { ...state, currentCategory: action.payload };</span>
        default:
            return state;
    }
}
</code></pre>
<h3 id="t373.8 actions\home.tsx">3.8 actions\home.tsx <a href="#t373.8 actions\home.tsx"> # </a></h3>
<p>src\store\actions\home.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> TYPES <span class="hljs-keyword">from</span> <span class="hljs-string">"../action-types"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  setCurrentCategory(currentCategory: string) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">type</span>: TYPES.SET_CURRENT_CATEGORY, <span class="hljs-attr">payload</span>: currentCategory };
  },
};
</code></pre>
<h3 id="t383.9 Home\index.tsx">3.9 Home\index.tsx <a href="#t383.9 Home\index.tsx"> # </a></h3>
<p>src\routes\Home\index.tsx</p>
<pre><code class="lang-diff">import React, { PropsWithChildren } from 'react';
import { connect } from 'react-redux';
import { RouteComponentProps } from 'react-router-dom';
<span class="hljs-addition">+import actions from '@/store/actions/home';</span>
<span class="hljs-addition">+import HomeHeader from './components/HomeHeader';</span>
<span class="hljs-addition">+import { CombinedState } from '@/store/reducers';</span>
<span class="hljs-addition">+import { HomeState } from '@/store/reducers/home';</span>
<span class="hljs-addition">+import './index.less';</span>
<span class="hljs-addition">+type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;</span>
<span class="hljs-addition">+type DispatchProps = typeof actions;</span>
<span class="hljs-addition">+interface Params { }</span>
<span class="hljs-addition">+type Props = PropsWithChildren&lt;RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps&gt;;</span>
<span class="hljs-addition">+function Home(props: Props) {</span>
<span class="hljs-addition">+    return (</span>
<span class="hljs-addition">+        &lt;&gt;</span>
<span class="hljs-addition">+            &lt;HomeHeader</span>
<span class="hljs-addition">+                currentCategory={props.currentCategory}</span>
<span class="hljs-addition">+                setCurrentCategory={props.setCurrentCategory}</span>
<span class="hljs-addition">+            /&gt;</span>
<span class="hljs-addition">+        &lt;/&gt;</span>
<span class="hljs-addition">+    )</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+let mapStateToProps = (state: CombinedState): HomeState =&gt; state.home;</span>
<span class="hljs-addition">+export default connect(</span>
<span class="hljs-addition">+    mapStateToProps,</span>
<span class="hljs-addition">+    actions</span>
<span class="hljs-addition">+)(Home);</span>
</code></pre>
<h3 id="t393.10 Home\index.less">3.10 Home\index.less <a href="#t393.10 Home\index.less"> # </a></h3>
<p>src\routes\Home\index.less</p>
<pre><code class="lang-less">
</code></pre>
<h2 id="t40第4章 创建服务器端项目">第4章 创建服务器端项目 <a href="#t40第4章 创建服务器端项目"> # </a></h2>
<ul>
<li><a href="https://robomongo.org/download">安装客户端工具 Robo 3T</a></li>
<li><a href="https://insomnia.rest/download/#windows">安装 api 测试工具 Insomnia Core</a></li>
</ul>
<p>目录结构</p>
<pre><code class="lang-js">.
├── package.json
├── src
│   └── index.ts
└── tsconfig.json
</code></pre>
<h3 id="t414.1 生成项目">4.1 生成项目 <a href="#t414.1 生成项目"> # </a></h3>
<pre><code class="lang-js">mkdir zfkt2020-api
cd zfkt2020-api
cnpm init -y
</code></pre>
<h3 id="t424.2 安装依赖">4.2 安装依赖 <a href="#t424.2 安装依赖"> # </a></h3>
<pre><code class="lang-js">cnpm i express mongoose body-parser bcryptjs jsonwebtoken morgan cors validator helmet dotenv multer http-status-codes -S
cnpm i typescript  @types/node @types/express @types/mongoose @types/bcryptjs @types/jsonwebtoken  @types/morgan @types/cors @types/validator ts-node-dev nodemon  @types/helmet @types/multer cross-env -D
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left">模块名</th>
<th style="text-align:left">英文</th>
<th style="text-align:left">中文</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">express</td>
<td style="text-align:left">Fast, unopinionated, minimalist web framework for node.</td>
<td style="text-align:left">基于 Node.js 平台，快速、开放、极简的 Web 开发框架</td>
</tr>
<tr>
<td style="text-align:left">@types/express</td>
<td style="text-align:left">This package contains type definitions for Express</td>
<td style="text-align:left">express 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">mongoose</td>
<td style="text-align:left">Mongoose is a MongoDB object modeling tool designed to work in an asynchronous environment. Mongoose supports both promises and callbacks.</td>
<td style="text-align:left">Mongoose 为模型提供了一种直接的，基于 scheme 结构去定义你的数据模型。它内置数据验证， 查询构建，业务逻辑钩子等，开箱即用</td>
</tr>
<tr>
<td style="text-align:left">@types/mongoose</td>
<td style="text-align:left">This package contains type definitions for Mongoose</td>
<td style="text-align:left">mongoose 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">body-parser</td>
<td style="text-align:left">Node.js body parsing middleware.</td>
<td style="text-align:left">body-parser 是一个 HTTP 请求体解析中间件，使用这个模块可以解析 JSON、Raw、文本、URL-encoded 格式的请求体，Express 框架中就是使用这个模块做为请求体解析中间件</td>
</tr>
<tr>
<td style="text-align:left">bcryptjs</td>
<td style="text-align:left">Optimized bcrypt in JavaScript with zero dependencies. Compatible to the C++ bcrypt binding on node.js and also working in the browser.</td>
<td style="text-align:left">bcryptjs 是一个第三方加密库，用来实现在 Node 环境下的 bcrypt 加密</td>
</tr>
<tr>
<td style="text-align:left">@types/bcryptjs</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">jsonwebtoken</td>
<td style="text-align:left">An implementation of JSON Web Tokens</td>
<td style="text-align:left">JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用 JWT 在用户和服务器之间传递安全可靠的信息</td>
</tr>
<tr>
<td style="text-align:left">@types/jsonwebtoken</td>
<td style="text-align:left">This package contains type definitions for jsonwebtoken</td>
<td style="text-align:left">jsonwebtoken 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">morgan</td>
<td style="text-align:left">HTTP request logger middleware for node.js</td>
<td style="text-align:left">morgan 是 express 默认的日志中间件，也可以脱离 express，作为 node.js 的日志组件单独使用</td>
</tr>
<tr>
<td style="text-align:left">@types/morgan</td>
<td style="text-align:left">This package contains type definitions for morgan</td>
<td style="text-align:left">morgan 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">cors</td>
<td style="text-align:left">CORS is a node.js package for providing a Connect/Express middleware that can be used to enable CORS with various options.</td>
<td style="text-align:left">CORS 是用于提供 Connect / Express 中间件的 node.js 程序包，可用于启用具有各种选项的 CORS</td>
</tr>
<tr>
<td style="text-align:left">@types/cors</td>
<td style="text-align:left">This package contains type definitions for cors</td>
<td style="text-align:left">cors 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">validator</td>
<td style="text-align:left">A library of string validators and sanitizers</td>
<td style="text-align:left">一个用于字符串验证和净化的库</td>
</tr>
<tr>
<td style="text-align:left">@types/validator</td>
<td style="text-align:left">This package contains type definitions for validator.js</td>
<td style="text-align:left">validator 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">helmet</td>
<td style="text-align:left">Helmet helps you secure your Express apps by setting various HTTP headers. It's not a silver bullet, but it can help!</td>
<td style="text-align:left">Helmet 可通过设置各种 HTTP 标头来帮助您保护 Express 应用程序</td>
</tr>
<tr>
<td style="text-align:left">@types/helmet</td>
<td style="text-align:left">This package contains type definitions for helmet</td>
<td style="text-align:left">helmet 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">dotenv</td>
<td style="text-align:left">Dotenv is a zero-dependency module that loads environment variables from a .env file into process.env. Storing configuration in the environment separate from code is based on The Twelve-Factor App methodology.</td>
<td style="text-align:left">Dotenv 是一个零依赖模块，可将环境变量从.env 文件加载到 process.env 中</td>
</tr>
<tr>
<td style="text-align:left">multer</td>
<td style="text-align:left">Multer is a node.js middleware for handling multipart/form-data, which is primarily used for uploading files. It is written on top of busboy for maximum efficiency.</td>
<td style="text-align:left">Multer 是用于处理<code>multyparty/formdata</code>类型请求体的 node.js 中间件，主要用于上传文件。 它是在 busboy 之上编写的，以实现最大效率。</td>
</tr>
<tr>
<td style="text-align:left">@types/multer</td>
<td style="text-align:left">This package contains type definitions for multer</td>
<td style="text-align:left">multer 的类型声明</td>
</tr>
<tr>
<td style="text-align:left">typescript</td>
<td style="text-align:left">TypeScript is a language for application-scale JavaScript</td>
<td style="text-align:left">ypeScript 是用于应用程序级 JavaScript 的语言</td>
</tr>
<tr>
<td style="text-align:left">@types/node</td>
<td style="text-align:left">This package contains type definitions for Node.js</td>
<td style="text-align:left">该软件包包含 Node.js 的类型定义</td>
</tr>
<tr>
<td style="text-align:left">ts-node-dev</td>
<td style="text-align:left">Tweaked version of node-dev that uses ts-node under the hood.</td>
<td style="text-align:left">调整后的版本，在后台使用 ts-node</td>
</tr>
<tr>
<td style="text-align:left">nodemon</td>
<td style="text-align:left">nodemon is a tool that helps develop node.js based applications by automatically restarting the node application when file changes in the directory are detected.</td>
<td style="text-align:left">nodemon 是一种工具，可在检测到目录中的文件更改时通过自动重新启动应用程序来帮助开发基于 node.js 的应用程序。</td>
</tr>
</tbody>
</table>
<h3 id="t434.3 初始化 tsconfig.json">4.3 初始化 tsconfig.json <a href="#t434.3 初始化 tsconfig.json"> # </a></h3>
<ul>
<li>执行以下命令并选择<code>node</code></li>
</ul>
<pre><code class="lang-json">npx tsconfig.json
</code></pre>
<h3 id="t444.4 .gitignore">4.4 .gitignore <a href="#t444.4 .gitignore"> # </a></h3>
<pre><code class="lang-js">node_modules
src/public/upload/
.env
</code></pre>
<h3 id="t454.5 .env">4.5 .env <a href="#t454.5 .env"> # </a></h3>
<pre><code class="lang-js">JWT_SECRET_KEY=zhufeng
MONGODB_URL=mongodb:<span class="hljs-comment">//localhost/zhufengketang</span>
</code></pre>
<h3 id="t464.6 src\index.ts">4.6 src\index.ts <a href="#t464.6 src\index.ts"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> express, { Express } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">const</span> app: Express = express();
<span class="hljs-keyword">const</span> PORT: number = (process.env.PORT &amp;&amp; <span class="hljs-built_in">parseInt</span>(process.env.PORT)) || <span class="hljs-number">8000</span>;
app.listen(PORT, () =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</code></pre>
<h3 id="t474.7 package.json">4.7 package.json <a href="#t474.7 package.json"> # </a></h3>
<pre><code class="lang-diff"><span class="hljs-addition">+  "scripts": {</span>
<span class="hljs-addition">+    "build": "tsc",</span>
<span class="hljs-addition">+    "start": "cross-env PORT=8000  ts-node-dev --respawn src/index.ts",</span>
<span class="hljs-addition">+    "dev": "cross-env PORT=8000 nodemon --exec ts-node --files src/index.ts"</span>
<span class="hljs-addition">+  }</span>
</code></pre>
<h3 id="t484.8 测试">4.8 测试 <a href="#t484.8 测试"> # </a></h3>
<pre><code class="lang-js">npm run build
npm run dev 
npm run start
</code></pre>
<h2 id="t49第5章 用户管理">第5章 用户管理 <a href="#t49第5章 用户管理"> # </a></h2>
<ul>
<li>本章的是编写用户管理相关的接口</li>
<li>本章需要编写以下接口<ul>
<li>用户注册</li>
<li>用户登录</li>
<li>验证用户是否登录</li>
<li>上传头像</li>
</ul>
</li>
</ul>
<p>本章目录</p>
<pre><code class="lang-js">.
├── package.json
├── src
│   ├── controller
│   │   ├── slider.ts
│   │   └── user.ts
│   ├── exceptions
│   │   └── HttpException.ts
│   ├── index.ts
│   ├── middlewares
│   │   └── errorMiddleware.ts
│   ├── models
│   │   ├── index.ts
│   │   ├── slider.ts
│   │   └── user.ts
│   ├── public
│   ├── typings
│   │   ├── express.d.ts
│   │   └── jwt.ts
│   └── utils
│       └── validator.ts
└── tsconfig.json
</code></pre>
<p>本章效果</p>
<p><img src="http://img.zhufengpeixun.cn/userinterface.gif" alt="userinterface"></p>
<h4 id="t505.1 src/index.ts">5.1 src/index.ts <a href="#t505.1 src/index.ts"> # </a></h4>
<p>src/index.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> express, { Express, Request, Response, NextFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">"mongoose"</span>;
<span class="hljs-keyword">import</span> HttpException <span class="hljs-keyword">from</span> <span class="hljs-string">"./exceptions/HttpException"</span>;
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">"cors"</span>;
<span class="hljs-keyword">import</span> morgan <span class="hljs-keyword">from</span> <span class="hljs-string">"morgan"</span>;
<span class="hljs-keyword">import</span> helmet <span class="hljs-keyword">from</span> <span class="hljs-string">"helmet"</span>;
<span class="hljs-keyword">import</span> errorMiddleware <span class="hljs-keyword">from</span> <span class="hljs-string">"./middlewares/errorMiddleware"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> userController <span class="hljs-keyword">from</span> <span class="hljs-string">"./controller/user"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;
<span class="hljs-keyword">import</span> multer <span class="hljs-keyword">from</span> <span class="hljs-string">"multer"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">const</span> storage = multer.diskStorage({
  <span class="hljs-attr">destination</span>: path.join(__dirname, <span class="hljs-string">"public"</span>, <span class="hljs-string">"uploads"</span>),
  filename(_req: Request, <span class="hljs-attr">file</span>: Express.Multer.File, cb) {
    cb(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Date</span>.now() + path.extname(file.originalname));
  },
});
<span class="hljs-keyword">const</span> upload = multer({ storage });
<span class="hljs-keyword">const</span> app: Express = express();
app.use(morgan(<span class="hljs-string">"dev"</span>));
app.use(cors());
app.use(helmet());
app.use(express.static(path.resolve(__dirname, <span class="hljs-string">"public"</span>)));
app.use(express.json());
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> }));
app.get(<span class="hljs-string">"/"</span>, (_req: Request, <span class="hljs-attr">res</span>: Response) =&gt; {
  res.json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"hello world"</span> });
});
app.get(<span class="hljs-string">"/user/validate"</span>, userController.validate);
app.post(<span class="hljs-string">"/user/register"</span>, userController.register);
app.post(<span class="hljs-string">"/user/login"</span>, userController.login);
app.post(
  <span class="hljs-string">"/user/uploadAvatar"</span>,
  upload.single(<span class="hljs-string">"avatar"</span>),
  userController.uploadAvatar
);
app.use(<span class="hljs-function">(<span class="hljs-params">_req: Request, _res: Response, next: NextFunction</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> error: HttpException = <span class="hljs-keyword">new</span> HttpException(<span class="hljs-number">404</span>, <span class="hljs-string">"Route not found"</span>);
  next(error);
});
app.use(errorMiddleware);
<span class="hljs-keyword">const</span> PORT: number = (process.env.PORT &amp;&amp; <span class="hljs-built_in">parseInt</span>(process.env.PORT)) || <span class="hljs-number">8000</span>;
(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  mongoose.set(<span class="hljs-string">"useNewUrlParser"</span>, <span class="hljs-literal">true</span>);
  mongoose.set(<span class="hljs-string">"useUnifiedTopology"</span>, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">await</span> mongoose.connect(<span class="hljs-string">"mongodb://localhost/zhufengketang"</span>);
  app.listen(PORT, () =&gt; {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Running on http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  });
})();
</code></pre>
<h4 id="t515.2 src/exceptions/HttpException.ts">5.2 src/exceptions/HttpException.ts <a href="#t515.2 src/exceptions/HttpException.ts"> # </a></h4>
<p>src/exceptions/HttpException.ts</p>
<pre><code class="lang-js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Error</span> </span>{
    <span class="hljs-keyword">constructor</span>(public status: number, public message: string, public errors?: any) {
        <span class="hljs-keyword">super</span>(message);
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> HttpException;
</code></pre>
<h4 id="t525.3 src/middlewares/errorMiddleware.ts">5.3 src/middlewares/errorMiddleware.ts <a href="#t525.3 src/middlewares/errorMiddleware.ts"> # </a></h4>
<p>src/middlewares/errorMiddleware.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> HttpException <span class="hljs-keyword">from</span> <span class="hljs-string">"../exceptions/HttpException"</span>;
<span class="hljs-keyword">import</span> { Request, Response, NextFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> statusCodes <span class="hljs-keyword">from</span> <span class="hljs-string">"http-status-codes"</span>;
<span class="hljs-keyword">const</span> errorMiddleware = (
  error: HttpException,
  <span class="hljs-attr">_request</span>: Request,
  <span class="hljs-attr">response</span>: Response,
  <span class="hljs-attr">_next</span>: NextFunction
) =&gt; {
  response.status(error.status || statusCodes.INTERNAL_SERVER_ERROR).send({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">message</span>: error.message,
    <span class="hljs-attr">errors</span>: error.errors,
  });
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> errorMiddleware;
</code></pre>
<h4 id="t535.4 src/utils/validator.ts">5.4 src/utils/validator.ts <a href="#t535.4 src/utils/validator.ts"> # </a></h4>
<p>src/utils/validator.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> validator <span class="hljs-keyword">from</span> <span class="hljs-string">"validator"</span>;
<span class="hljs-keyword">import</span> { IUserDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">"../models/user"</span>;

<span class="hljs-keyword">export</span> interface RegisterInput extends Partial&lt;IUserDocument&gt; {
  confirmPassword?: string;
}

<span class="hljs-keyword">export</span> interface RegisterInputValidateResult {
  <span class="hljs-attr">errors</span>: RegisterInput;
  valid: boolean;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> validateRegisterInput = (
  username: string,
  <span class="hljs-attr">password</span>: string,
  <span class="hljs-attr">confirmPassword</span>: string,
  <span class="hljs-attr">email</span>: string
): <span class="hljs-function"><span class="hljs-params">RegisterInputValidateResult</span> =&gt;</span> {
  <span class="hljs-keyword">let</span> errors: RegisterInput = {};
  <span class="hljs-keyword">if</span> (username == <span class="hljs-literal">undefined</span> || validator.isEmpty(username)) {
    errors.username = <span class="hljs-string">"用户名不能为空"</span>;
  }
  <span class="hljs-keyword">if</span> (password == <span class="hljs-literal">undefined</span> || validator.isEmpty(password)) {
    errors.password = <span class="hljs-string">"密码不能为空"</span>;
  }
  <span class="hljs-keyword">if</span> (confirmPassword == <span class="hljs-literal">undefined</span> || validator.isEmpty(confirmPassword)) {
    errors.password = <span class="hljs-string">"确认密码不能为空"</span>;
  }
  <span class="hljs-keyword">if</span> (!validator.equals(password, confirmPassword)) {
    errors.confirmPassword = <span class="hljs-string">"确认密码和密码不相等"</span>;
  }
  <span class="hljs-keyword">if</span> (email == <span class="hljs-literal">undefined</span> || validator.isEmpty(password)) {
    errors.email = <span class="hljs-string">"邮箱不能为空"</span>;
  }
  <span class="hljs-keyword">if</span> (!validator.isEmail(email)) {
    errors.email = <span class="hljs-string">"邮箱格式必须合法"</span>;
  }
  <span class="hljs-keyword">return</span> { errors, <span class="hljs-attr">valid</span>: <span class="hljs-built_in">Object</span>.keys(errors).length == <span class="hljs-number">0</span> };
};
</code></pre>
<h4 id="t545.5 src/typings/jwt.ts">5.5 src/typings/jwt.ts <a href="#t545.5 src/typings/jwt.ts"> # </a></h4>
<p>src/typings/jwt.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { IUserDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">"../models/user"</span>;

<span class="hljs-keyword">export</span> interface UserPayload {
    <span class="hljs-attr">id</span>: IUserDocument[<span class="hljs-string">'_id'</span>]
}
</code></pre>
<h4 id="t555.6 src\models\index.ts">5.6 src\models\index.ts <a href="#t555.6 src\models\index.ts"> # </a></h4>
<p>src\models\index.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">"./user"</span>;
</code></pre>
<h4 id="t565.7 src/models/user.ts">5.7 src/models/user.ts <a href="#t565.7 src/models/user.ts"> # </a></h4>
<p>src/models/user.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> mongoose, { Schema, Model, Document, HookNextFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;
<span class="hljs-keyword">import</span> validator <span class="hljs-keyword">from</span> <span class="hljs-string">'validator'</span>;
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;
<span class="hljs-keyword">import</span> { UserPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'../typings/jwt'</span>;
<span class="hljs-keyword">import</span> bcrypt <span class="hljs-keyword">from</span> <span class="hljs-string">'bcryptjs'</span>;
<span class="hljs-keyword">export</span> interface IUserDocument extends Document {
    <span class="hljs-attr">username</span>: string,
    <span class="hljs-attr">password</span>: string,
    <span class="hljs-attr">email</span>: string;
    avatar: string;
    generateToken: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> string
}
<span class="hljs-keyword">const</span> UserSchema: Schema&lt;IUserDocument&gt; = <span class="hljs-keyword">new</span> Schema({
    <span class="hljs-attr">username</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
        <span class="hljs-attr">required</span>: [<span class="hljs-literal">true</span>, <span class="hljs-string">'用户名不能为空'</span>],
        <span class="hljs-attr">minlength</span>: [<span class="hljs-number">6</span>, <span class="hljs-string">'最小长度不能少于6位'</span>],
        <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">12</span>, <span class="hljs-string">'最大长度不能大于12位'</span>]
    },
    <span class="hljs-attr">password</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">String</span>,
    <span class="hljs-attr">email</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
        <span class="hljs-attr">validate</span>: {
            <span class="hljs-attr">validator</span>: validator.isEmail
        },
        <span class="hljs-attr">trim</span>: <span class="hljs-literal">true</span>,
    }
}, { <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>,<span class="hljs-attr">toJSON</span>:{
    transform(_doc,ret){
        ret.id=ret._id;
        <span class="hljs-keyword">delete</span> ret._id;
        <span class="hljs-keyword">delete</span> ret.__v;
        <span class="hljs-keyword">delete</span> ret.password;
        <span class="hljs-keyword">return</span> ret;
    }
} });

UserSchema.methods.generateToken = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">let</span> payload: UserPayload = ({ <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>._id });
    <span class="hljs-keyword">return</span> jwt.sign(payload, process.env.JWT_SECRET_KEY!, { <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">'1h'</span> });
}
UserSchema.pre&lt;IUserDocument&gt;(<span class="hljs-string">'save'</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next: HookNextFunction</span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isModified(<span class="hljs-string">'password'</span>)) {
        <span class="hljs-keyword">return</span> next();
    }
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.password = <span class="hljs-keyword">await</span> bcrypt.hash(<span class="hljs-keyword">this</span>.password, <span class="hljs-number">10</span>);
        next();
    } <span class="hljs-keyword">catch</span> (error) {
        next(error);
    }
});
UserSchema.static(<span class="hljs-string">'login'</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">this: any, username: string, password: string</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">IUserDocument</span> | <span class="hljs-title">null</span>&gt; </span>{
    <span class="hljs-keyword">let</span> user: IUserDocument | <span class="hljs-literal">null</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.model(<span class="hljs-string">'User'</span>).findOne({ username });
    <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-keyword">const</span> matched = <span class="hljs-keyword">await</span> bcrypt.compare(password, user.password);
        <span class="hljs-keyword">if</span> (matched) {
            <span class="hljs-keyword">return</span> user;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
    <span class="hljs-keyword">return</span> user;
});
interface IUserModel&lt;T extends Document&gt; extends Model&lt;T&gt; {
    <span class="hljs-attr">login</span>: <span class="hljs-function">(<span class="hljs-params">username: string, password: string</span>) =&gt;</span> IUserDocument | <span class="hljs-literal">null</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> User: IUserModel&lt;IUserDocument&gt; = mongoose.model&lt;IUserDocument, IUserModel&lt;IUserDocument&gt;&gt;(<span class="hljs-string">'User'</span>, UserSchema);
</code></pre>
<h4 id="t575.8 src\controller\user.ts">5.8 src\controller\user.ts <a href="#t575.8 src\controller\user.ts"> # </a></h4>
<p>src\controller\user.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Request, Response, NextFunction } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { validateRegisterInput } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/validator'</span>;
<span class="hljs-keyword">import</span> HttpException <span class="hljs-keyword">from</span> <span class="hljs-string">'../exceptions/HttpException'</span>;
<span class="hljs-keyword">import</span> StatusCodes <span class="hljs-keyword">from</span> <span class="hljs-string">'http-status-codes'</span>;
<span class="hljs-keyword">import</span> { IUserDocument, User } <span class="hljs-keyword">from</span> <span class="hljs-string">'../models/user'</span>;
<span class="hljs-keyword">import</span> { UserPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'../typings/jwt'</span>;
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> validate = <span class="hljs-keyword">async</span> (req: Request, <span class="hljs-attr">res</span>: Response, <span class="hljs-attr">next</span>: NextFunction) =&gt; {
    <span class="hljs-keyword">const</span> authorization = req.headers[<span class="hljs-string">'authorization'</span>];
    <span class="hljs-keyword">if</span> (authorization) {
        <span class="hljs-keyword">const</span> token = authorization.split(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">if</span> (token) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> payload: UserPayload = jwt.verify(token, process.env.JWT_SECRET_KEY!) <span class="hljs-keyword">as</span> UserPayload;
                <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.findById(payload.id);
                <span class="hljs-keyword">if</span> (user) {
                    res.json({
                        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
                        <span class="hljs-attr">data</span>: user.toJSON()
                    });
                } <span class="hljs-keyword">else</span> {
                    next(<span class="hljs-keyword">new</span> HttpException(StatusCodes.UNAUTHORIZED, <span class="hljs-string">`用户不合法!`</span>));
                }
            } <span class="hljs-keyword">catch</span> (error) {
                next(<span class="hljs-keyword">new</span> HttpException(StatusCodes.UNAUTHORIZED, <span class="hljs-string">`token不合法!`</span>));
            }

        } <span class="hljs-keyword">else</span> {
            next(<span class="hljs-keyword">new</span> HttpException(StatusCodes.UNAUTHORIZED, <span class="hljs-string">`token未提供!`</span>));
        }
    } <span class="hljs-keyword">else</span> {
        next(<span class="hljs-keyword">new</span> HttpException(StatusCodes.UNAUTHORIZED, <span class="hljs-string">`authorization未提供!`</span>));
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> register = <span class="hljs-keyword">async</span> (req: Request, <span class="hljs-attr">res</span>: Response, <span class="hljs-attr">next</span>: NextFunction) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> { username, password, confirmPassword, email, addresses } = req.body;
        <span class="hljs-keyword">const</span> { valid, errors } = validateRegisterInput(username, password, confirmPassword, email);
        <span class="hljs-keyword">if</span> (!valid) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpException(StatusCodes.UNPROCESSABLE_ENTITY, <span class="hljs-string">`参数验证失败!`</span>, errors);
        }
        <span class="hljs-keyword">let</span> user: IUserDocument = <span class="hljs-keyword">new</span> User({
            username,
            email,
            password,
            addresses
        });
        <span class="hljs-keyword">let</span> oldUser: IUserDocument | <span class="hljs-literal">null</span> = <span class="hljs-keyword">await</span> User.findOne({ <span class="hljs-attr">username</span>: user.username });
        <span class="hljs-keyword">if</span> (oldUser) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpException(StatusCodes.UNPROCESSABLE_ENTITY, <span class="hljs-string">`用户名重复!`</span>);
        }
        <span class="hljs-keyword">await</span> user.save();
        <span class="hljs-keyword">let</span> token = user.generateToken();
        res.json({
            <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">data</span>: { token }
        });
    } <span class="hljs-keyword">catch</span> (error) {
        next(error);
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> login = <span class="hljs-keyword">async</span> (req: Request, <span class="hljs-attr">res</span>: Response, <span class="hljs-attr">next</span>: NextFunction) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> { username, password } = req.body;
        <span class="hljs-keyword">let</span> user = <span class="hljs-keyword">await</span> User.login(username, password);
        <span class="hljs-keyword">if</span> (user) {
            <span class="hljs-keyword">let</span> token = user.generateToken();
            res.json({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">data</span>: {
                    token
                }
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> HttpException(StatusCodes.UNAUTHORIZED, <span class="hljs-string">`登录失败`</span>);
        }
    } <span class="hljs-keyword">catch</span> (error) {
        next(error);
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> uploadAvatar = <span class="hljs-keyword">async</span> (req: Request, <span class="hljs-attr">res</span>: Response, <span class="hljs-attr">_next</span>: NextFunction) =&gt; {
    <span class="hljs-keyword">let</span> { userId } = req.body;
    <span class="hljs-keyword">let</span> domain = process.env.DOMAIN || <span class="hljs-string">`<span class="hljs-subst">${req.protocol}</span>://<span class="hljs-subst">${req.headers.host}</span>`</span>;
    <span class="hljs-keyword">let</span> avatar = <span class="hljs-string">`<span class="hljs-subst">${domain}</span>/uploads/<span class="hljs-subst">${req.file.filename}</span>`</span>;
    <span class="hljs-keyword">await</span> User.updateOne({ <span class="hljs-attr">_id</span>: userId }, { avatar });
    res.send({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: avatar });
}
</code></pre>
<h4 id="t585.9 typings\express.d.ts">5.9 typings\express.d.ts <a href="#t585.9 typings\express.d.ts"> # </a></h4>
<p>src\typings\express.d.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { IUserDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">"../models/user"</span>;
declare global {
    namespace Express {
        <span class="hljs-keyword">export</span> interface Request {
            currentUser?: IUserDocument | <span class="hljs-literal">null</span>;
            file: Multer.File
        }
    }
}
</code></pre>
<h4 id="t595.10 .env">5.10 .env <a href="#t595.10 .env"> # </a></h4>
<p>.env</p>
<pre><code class="lang-js">JWT_SECRET_KEY=zhufeng
MONGODB_URL=mongodb:<span class="hljs-comment">//localhost:27017/zhufengketang</span>
PORT=<span class="hljs-number">8899</span>
DOMAIN=http:<span class="hljs-comment">//localhost:8899</span>
</code></pre>
<h2 id="t60第6章 个人中心">第6章 个人中心 <a href="#t60第6章 个人中心"> # </a></h2>
<ul>
<li>本章主要编写<code>Profile</code>组件,就是切换到个人中心页的时候,先发起一个 ajax 请求判断此用户是否登录,如果已经登录的话显示用户信息,如果未登录的请提示跳转到登录和注册页</li>
<li>本章实践的内容<ul>
<li>路由的切换</li>
<li>如何在 hooks 中发起 ajax 请求</li>
<li>如何保存及发送时携带 jwt 和 token</li>
<li>如何根据环境不同加载不同的接口地址</li>
<li>如何编写<code>axios</code>拦截器</li>
</ul>
</li>
</ul>
<h3 id="t616.1  资料">6.1  资料 <a href="#t616.1  资料"> # </a></h3>
<h4 id="t626.1.1 本章目录">6.1.1 本章目录 <a href="#t626.1.1 本章目录"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── src
│   ├── api
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   └── HomeHeader
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   └── Profile
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   └── typings
│       ├── images.d.ts
│       └── login-types.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t636.1.2 本章效果">6.1.2 本章效果 <a href="#t636.1.2 本章效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/profileroute.gif" alt="profileroute"></p>
<h3 id="t646.2 Profile\index.tsx">6.2 Profile\index.tsx <a href="#t646.2 Profile\index.tsx"> # </a></h3>
<p>src\routes\Profile\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { PropsWithChildren, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { CombinedState } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/reducers"</span>;
<span class="hljs-keyword">import</span> { ProfileState } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/reducers/profile"</span>;
<span class="hljs-keyword">import</span> actions <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/actions/profile"</span>;
<span class="hljs-keyword">import</span> LOGIN_TYPES <span class="hljs-keyword">from</span> <span class="hljs-string">"../../typings/login-types"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router"</span>;
<span class="hljs-keyword">import</span> { Descriptions, Button, Alert, message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> NavHeader <span class="hljs-keyword">from</span> <span class="hljs-string">"../../components/NavHeader"</span>;
<span class="hljs-keyword">import</span> { AxiosError } <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-comment">//当前的组件有三个属性来源</span>
<span class="hljs-comment">//1.mapStateToProps的返回值 2.actions对象类型 3. 来自路由 4.用户传入进来的其它属性</span>
type StateProps = ReturnType&lt;<span class="hljs-keyword">typeof</span> mapStateToProps&gt;;
type DispatchProps = <span class="hljs-keyword">typeof</span> actions;
interface Params {}
type RouteProps = RouteComponentProps&lt;Params&gt;;
type Props = PropsWithChildren&lt;StateProps &amp; DispatchProps &amp; RouteProps&gt;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Profile</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-comment">//组件加载后直接 发起验证请求,查看此用户是否已经登录过了,如果没有登录则提示错误</span>
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    props.validate().catch(<span class="hljs-function">(<span class="hljs-params">error: AxiosError</span>) =&gt;</span> message.error(error.message));
  }, []);
  <span class="hljs-keyword">let</span> content; <span class="hljs-comment">//里存放着要渲染的内容</span>
  <span class="hljs-keyword">if</span> (props.loginState == LOGIN_TYPES.UN_VALIDATE) {
    <span class="hljs-comment">//如果未验证则内容为null</span>
    content = <span class="hljs-literal">null</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (props.loginState == LOGIN_TYPES.LOGINED) {
    <span class="hljs-comment">//如果已经登录显示用户信息</span>
    content = (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Descriptions</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"当前登录用户"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Descriptions.Item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span>&gt;</span>珠峰架构<span class="hljs-tag">&lt;/<span class="hljs-name">Descriptions.Item</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Descriptions.Item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"手机号"</span>&gt;</span>15718856132<span class="hljs-tag">&lt;/<span class="hljs-name">Descriptions.Item</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Descriptions.Item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"邮箱"</span>&gt;</span>zhangsan@qq.com<span class="hljs-tag">&lt;/<span class="hljs-name">Descriptions.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Descriptions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>退出登录<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//如果没有登录,则显示注册和登录按钮</span>
    content = (
      <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Alert</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"warning"</span>
          <span class="hljs-attr">message</span>=<span class="hljs-string">"当前未登录"</span>
          <span class="hljs-attr">description</span>=<span class="hljs-string">"亲爱的用户你好，你当前尚未登录，请你选择注册或者登录"</span>
        /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> "<span class="hljs-attr">center</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">50px</span>" }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"dashed"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> props.history.push("/login")}&gt;
            登录
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"dashed"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginLeft:</span> "<span class="hljs-attr">50px</span>" }}
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> props.history.push("/register")}
          &gt;
            注册
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/&gt;</span></span>
    );
  }
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavHeader</span> <span class="hljs-attr">history</span>=<span class="hljs-string">{props.history}</span>&gt;</span>个人中心<span class="hljs-tag">&lt;/<span class="hljs-name">NavHeader</span>&gt;</span>
      {content}
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">let</span> mapStateToProps = (state: CombinedState): <span class="hljs-function"><span class="hljs-params">ProfileState</span> =&gt;</span> state.profile;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(mapStateToProps, actions)(Profile);
</code></pre>
<h3 id="t656.3 routes\Profile\index.less">6.3 routes\Profile\index.less <a href="#t656.3 routes\Profile\index.less"> # </a></h3>
<p>src\routes\Profile\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-class">.user-info</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<h3 id="t666.4 action-types.tsx">6.4 action-types.tsx <a href="#t666.4 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = 'ADD';
//设置当前分类的名称
export const SET_CURRENT_CATEGORY = 'SET_CURRENT_CATEGORY';
//发起验证用户是否登录的请求
<span class="hljs-addition">+export const VALIDATE = 'VALIDATE';</span>
</code></pre>
<h3 id="t676.5 typings\login-types.tsx">6.5 typings\login-types.tsx <a href="#t676.5 typings\login-types.tsx"> # </a></h3>
<p>src\typings\login-types.tsx</p>
<pre><code class="lang-js">enum LOGIN_TYPES {
    UN_VALIDATE, <span class="hljs-comment">//未验证过</span>
    LOGINED,     <span class="hljs-comment">//登录</span>
    UNLOGIN      <span class="hljs-comment">//未登录</span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> LOGIN_TYPES;
</code></pre>
<h3 id="t686.6 reducers\profile.tsx">6.6 reducers\profile.tsx <a href="#t686.6 reducers\profile.tsx"> # </a></h3>
<p>src\store\reducers\profile.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"redux"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> TYPES <span class="hljs-keyword">from</span> <span class="hljs-string">"../action-types"</span>;
<span class="hljs-keyword">import</span> LOGIN_TYPES <span class="hljs-keyword">from</span> <span class="hljs-string">"../../typings/login-types"</span>;
<span class="hljs-keyword">export</span> interface ProfileState {
  <span class="hljs-attr">loginState</span>: LOGIN_TYPES; <span class="hljs-comment">//当前用户的登录状态</span>
  user: any; <span class="hljs-comment">//当前已经登录的用户信息</span>
  error: string | <span class="hljs-literal">null</span>; <span class="hljs-comment">//错误信息</span>
}
<span class="hljs-keyword">let</span> initialState: ProfileState = {
  <span class="hljs-comment">//初始状态</span>
  <span class="hljs-attr">loginState</span>: LOGIN_TYPES.UN_VALIDATE, <span class="hljs-comment">//当前用户的登录状态</span>
  <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">//当前已经登录的用户信息</span>
  <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">//错误信息</span>
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  state: ProfileState = initialState,
  action: AnyAction
</span>): <span class="hljs-title">ProfileState</span> </span>{
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> TYPES.VALIDATE:
      <span class="hljs-keyword">if</span> (action.payload.success) {
        <span class="hljs-comment">//如果此用户已经登录了</span>
        <span class="hljs-keyword">return</span> {
          ...state,
          <span class="hljs-attr">loginState</span>: LOGIN_TYPES.LOGINED,
          <span class="hljs-attr">user</span>: action.payload.data, <span class="hljs-comment">//设置用户名</span>
          <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">//没有错误</span>
        };
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> {
          ...state,
          <span class="hljs-attr">loginState</span>: LOGIN_TYPES.UNLOGIN,
          <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">//用户名为空</span>
          <span class="hljs-attr">error</span>: action.payload, <span class="hljs-comment">//错误对象赋值</span>
        };
      }
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}
</code></pre>
<h3 id="t696.7 actions\profile.tsx">6.7 actions\profile.tsx <a href="#t696.7 actions\profile.tsx"> # </a></h3>
<p>src\store\actions\profile.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"redux"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> TYPES <span class="hljs-keyword">from</span> <span class="hljs-string">"../action-types"</span>;
<span class="hljs-keyword">import</span> { validate } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../api/profile"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">//https://github.com/redux-utilities/redux-promise/blob/master/src/index.js</span>
  validate(): AnyAction {
    <span class="hljs-comment">//发起判断当前用户是否登录的请求</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">type</span>: TYPES.VALIDATE,
      <span class="hljs-attr">payload</span>: validate(),
    };
  },
};
</code></pre>
<h3 id="t706.8 api\index.tsx">6.8 api\index.tsx <a href="#t706.8 api\index.tsx"> # </a></h3>
<p>src\api\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;
<span class="hljs-comment">//设置AJAX请求的基准路径,如果是开发环境就指向 http://localhost:8000</span>
axios.defaults.baseURL =
  process.env.NODE_ENV === <span class="hljs-string">"production"</span> ? <span class="hljs-string">"/"</span> : <span class="hljs-string">"http://localhost:8000"</span>;
<span class="hljs-comment">//设置请求体类型为 application/json</span>
axios.defaults.headers.post[<span class="hljs-string">"Content-Type"</span>] = <span class="hljs-string">"application/json;charset=UTF-8"</span>;
axios.interceptors.request.use(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">//在发送请求前把sessionStorage中的token写到请求头里</span>
    <span class="hljs-keyword">let</span> access_token = sessionStorage.getItem(<span class="hljs-string">"access_token"</span>);
    config.headers = {
      <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${access_token}</span>`</span>,
    };
    <span class="hljs-keyword">return</span> config;
  },
  (error) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);
  }
);
axios.interceptors.response.use(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.data,
  (error) =&gt; <span class="hljs-built_in">Promise</span>.reject(error)
);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> axios;
</code></pre>
<h3 id="t716.10 src\api\profile.tsx">6.10 src\api\profile.tsx <a href="#t716.10 src\api\profile.tsx"> # </a></h3>
<p>src\api\profile.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"./index"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> axios.get(<span class="hljs-string">"/user/validate"</span>);
}
</code></pre>
<h3 id="t726.11 NavHeader\index.tsx">6.11 NavHeader\index.tsx <a href="#t726.11 NavHeader\index.tsx"> # </a></h3>
<p>src\components\NavHeader\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-keyword">import</span> { LeftOutlined } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/icons"</span>;
interface Props {
  <span class="hljs-attr">history</span>: any;
  children: any;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NavHeader</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">LeftOutlined</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> props.history.goBack()} /&gt;
      {props.children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 id="t736.12 NavHeader\index.less">6.12 NavHeader\index.less <a href="#t736.12 NavHeader\index.less"> # </a></h3>
<p>src\components\NavHeader\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-class">.nav-header</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2a2a2a</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-selector-tag">span</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">100px</span>;
  }
}
</code></pre>
<h2 id="t74第7章 注册登陆">第7章 注册登陆 <a href="#t74第7章 注册登陆"> # </a></h2>
<ul>
<li>本章我们主要是实现注册登录的功能</li>
<li>本章主要要实践的内容<ul>
<li>如何使用<code>antd4</code>中的表单功能</li>
</ul>
</li>
</ul>
<h3 id="t757.1 参考">7.1 参考 <a href="#t757.1 参考"> # </a></h3>
<h4 id="t767.1.1 目录结构">7.1.1 目录结构 <a href="#t767.1.1 目录结构"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── src
│   ├── api
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   └── HomeHeader
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   └── typings
│       ├── images.d.ts
│       ├── login-types.tsx
│       └── user.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t777.1.2 本章效果">7.1.2 本章效果 <a href="#t777.1.2 本章效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/registerlogin.gif" alt="registerlogin"></p>
<h3 id="t787.2 src\index.tsx">7.2 src\index.tsx <a href="#t787.2 src\index.tsx"> # </a></h3>
<p>src\index.tsx</p>
<pre><code class="lang-diff">import React from "react";
import ReactDOM from "react-dom";
import { Switch, Route, Redirect } from "react-router-dom";//三个路由组件
import { Provider } from "react-redux";//负责把属性中的store传递给子组件
import store from "./store";//引入仓库
import { ConfigProvider } from "antd";//配置
import zh_CN from "antd/lib/locale-provider/zh_CN";//国际化中文
import "./assets/css/common.less";//通用的样式
import Tabs from "./components/Tabs";//引入底部的页签导航
import Home from "./routes/Home";//首页
import Mine from "./routes/Mine";//我的课程
import Profile from "./routes/Profile";//个人中心
<span class="hljs-addition">+import Register from "./routes/Register";</span>
<span class="hljs-addition">+import Login from "./routes/Login";</span>
import { ConnectedRouter } from 'connected-react-router';//redux绑定路由
import history from './store/history';
ReactDOM.render(
    &lt;Provider store={store}&gt;
        &lt;ConnectedRouter history={history}&gt;
            &lt;ConfigProvider locale={zh_CN}&gt;
                &lt;main className="main-container"&gt;
                    &lt;Switch&gt;
                        &lt;Route path="/" exact component={Home} /&gt;
                        &lt;Route path="/mine" component={Mine} /&gt;
                        &lt;Route path="/profile" component={Profile} /&gt;
<span class="hljs-addition">+                        &lt;Route path="/register" component={Register} /&gt;</span>
<span class="hljs-addition">+                        &lt;Route path="/login" component={Login} /&gt;</span>
                        &lt;Redirect to="/" /&gt;
                    &lt;/Switch&gt;
                &lt;/main&gt;
                &lt;Tabs /&gt;
            &lt;/ConfigProvider&gt;
        &lt;/ConnectedRouter&gt;
    &lt;/Provider&gt;,
    document.getElementById("root")
);
</code></pre>
<h3 id="t797.3 api\profile.tsx">7.3 api\profile.tsx <a href="#t797.3 api\profile.tsx"> # </a></h3>
<p>src\api\profile.tsx</p>
<pre><code class="lang-diff">import axios from './index';
<span class="hljs-addition">+import { RegisterPayload, LoginPayload } from '../typings/user';</span>
export function validate() {
    return axios.get('/user/validate');
}
<span class="hljs-addition">+export function register&lt;T&gt;(values: RegisterPayload) {</span>
<span class="hljs-addition">+        return axios.post&lt;T, T&gt;('/user/register', values);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+export function login&lt;T&gt;(values: LoginPayload) {</span>
<span class="hljs-addition">+    return axios.post&lt;T, T&gt;('/user/login', values);</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t807.4 routes\Profile\index.tsx">7.4 routes\Profile\index.tsx <a href="#t807.4 routes\Profile\index.tsx"> # </a></h3>
<p>src\routes\Profile\index.tsx</p>
<pre><code class="lang-diff">import React, { PropsWithChildren, useEffect } from 'react';
import { connect } from 'react-redux';
import { CombinedState } from '../../store/reducers';
import { ProfileState } from '../../store/reducers/profile';
import actions from '../../store/actions/profile';
import LOGIN_TYPES from '../../typings/login-types';
import { RouteComponentProps } from 'react-router';
import { Descriptions, Button, Alert, message } from 'antd';
import NavHeader from '../../components/NavHeader';
import { AxiosError } from 'axios';
import './index.less';
//当前的组件有三个属性来源
//1.mapStateToProps的返回值 2.actions对象类型 3. 来自路由 4.用户传入进来的其它属性
type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;
type DispatchProps = typeof actions;
interface Params { }
type RouteProps = RouteComponentProps&lt;Params&gt;;
type Props = PropsWithChildren&lt;StateProps &amp; DispatchProps &amp; RouteProps&gt;
function Profile(props: Props) {
    //组件加载后直接 发起验证请求,查看此用户是否已经登录过了,如果没有登录则提示错误
    useEffect(() =&gt; {
        props.validate().catch((error: AxiosError) =&gt; message.error(error.message));
    }, []);
    let content;//里存放着要渲染的内容
    if (props.loginState == LOGIN_TYPES.UN_VALIDATE) {//如果未验证则内容为null
        content = null;
    } else if (props.loginState == LOGIN_TYPES.LOGINED) {//如果已经登录显示用户信息
        content = (
            &lt;div className="user-info"&gt;
                &lt;Descriptions title="当前登录用户"&gt;
<span class="hljs-addition">+                &lt;Descriptions.Item label="用户名"&gt;{props.user.username}&lt;/Descriptions.Item&gt;</span>
<span class="hljs-addition">+                &lt;Descriptions.Item label="邮箱"&gt;{props.user.email}&lt;/Descriptions.Item&gt;</span>
                &lt;/Descriptions&gt;
<span class="hljs-addition">+                &lt;Button type={"primary"} onClick={async () =&gt; {</span>
<span class="hljs-addition">+                    await props.logout();</span>
<span class="hljs-addition">+                    props.history.push('/login');</span>
<span class="hljs-addition">+                }}&gt;退出登录&lt;/Button&gt;</span>
            &lt;/div&gt;
        )
    } else {//如果没有登录,则显示注册和登录按钮
        content = (
            &lt;&gt;
                &lt;Alert type="warning" message="当前未登录" description="亲爱的用户你好，你当前尚未登录，请你选择注册或者登录" /&gt;
                &lt;div style={{ textAlign: 'center', padding: '50px' }}&gt;
                    &lt;Button type="dashed" onClick={() =&gt; props.history.push('/login')}&gt;登录&lt;/Button&gt;
                    &lt;Button type="dashed" style={{ marginLeft: '50px' }} onClick={() =&gt; props.history.push('/register')}&gt;注册&lt;/Button&gt;
                &lt;/div&gt;
            &lt;/&gt;
        )
    }
    return (
        (
            &lt;section&gt;
                &lt;NavHeader history={props.history}&gt;个人中心&lt;/NavHeader&gt;
                {content}
            &lt;/section&gt;
        )
    )
}

let mapStateToProps = (state: CombinedState): ProfileState =&gt; state.profile
export default connect(
    mapStateToProps,
    actions
)(Profile);
</code></pre>
<h3 id="t817.5 action-types.tsx">7.5 action-types.tsx <a href="#t817.5 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = 'ADD';
//设置当前分类的名称
export const SET_CURRENT_CATEGORY = 'SET_CURRENT_CATEGORY';
//发起验证用户是否登录的请求
export const VALIDATE = 'VALIDATE';

<span class="hljs-addition">+export const LOGOUT = 'LOGOUT';</span>
</code></pre>
<h3 id="t827.6 actions\profile.tsx">7.6 actions\profile.tsx <a href="#t827.6 actions\profile.tsx"> # </a></h3>
<p>src\store\actions\profile.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from 'redux';
import * as TYPES from '../action-types';
<span class="hljs-addition">+import { validate, register, login } from '@/api/profile';</span>
<span class="hljs-addition">+import { push } from 'connected-react-router';</span>
<span class="hljs-addition">+import { RegisterPayload, LoginPayload, RegisterResult, LoginResult } from '@/typings/user';</span>
<span class="hljs-addition">+import { message } from "antd";</span>
export default {
    //https://github.com/redux-utilities/redux-promise/blob/master/src/index.js
    validate(): AnyAction {//发起判断当前用户是否登录的请求
        return {
            type: TYPES.VALIDATE,
            payload: validate()
        }
    },
<span class="hljs-addition">+    register(values: RegisterPayload) {</span>
<span class="hljs-addition">+        return function (dispatch: any) {</span>
<span class="hljs-addition">+            (async function () {</span>
<span class="hljs-addition">+                try {</span>
<span class="hljs-addition">+                    let result: RegisterResult = await register&lt;RegisterResult&gt;(values);</span>
<span class="hljs-addition">+                    if (result.success) {</span>
<span class="hljs-addition">+                        dispatch(push('/login'));</span>
<span class="hljs-addition">+                    } else {</span>
<span class="hljs-addition">+                        message.error(result.message);</span>
<span class="hljs-addition">+                    }</span>
<span class="hljs-addition">+                } catch (error) {</span>
<span class="hljs-addition">+                    message.error('注册失败');</span>
<span class="hljs-addition">+                }</span>
<span class="hljs-addition">+            })();</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    },</span>
<span class="hljs-addition">+    login(values: LoginPayload) {</span>
<span class="hljs-addition">+        return function (dispatch: any) {</span>
<span class="hljs-addition">+            (async function () {</span>
<span class="hljs-addition">+                try {</span>
<span class="hljs-addition">+                    let result: LoginResult = await login&lt;LoginResult&gt;(values);</span>
<span class="hljs-addition">+                    if (result.success) {</span>
<span class="hljs-addition">+                        sessionStorage.setItem('access_token', result.data.token);</span>
<span class="hljs-addition">+                        dispatch(push('/profile'));</span>
<span class="hljs-addition">+                    } else {</span>
<span class="hljs-addition">+                        message.error(result.message);</span>
<span class="hljs-addition">+                    }</span>
<span class="hljs-addition">+                } catch (error) {</span>
<span class="hljs-addition">+                    message.error('登录失败');</span>
<span class="hljs-addition">+                }</span>
<span class="hljs-addition">+            })();</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    },</span>
<span class="hljs-addition">+    logout() {</span>
<span class="hljs-addition">+            return function (dispatch: any) {</span>
<span class="hljs-addition">+                sessionStorage.removeItem('access_token');</span>
<span class="hljs-addition">+                dispatch({ type: TYPES.LOGOUT });</span>
<span class="hljs-addition">+                dispatch(push('/login'));</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t837.7 src\typings\user.tsx">7.7 src\typings\user.tsx <a href="#t837.7 src\typings\user.tsx"> # </a></h3>
<p>src\typings\user.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> interface RegisterPayload {
    <span class="hljs-attr">username</span>: string,
    <span class="hljs-attr">password</span>: string,
    <span class="hljs-attr">email</span>: string;
    confirmPassword: string;
}
<span class="hljs-keyword">export</span> interface LoginPayload {
    <span class="hljs-attr">username</span>: string,
    <span class="hljs-attr">password</span>: string,
}
<span class="hljs-keyword">export</span> interface RegisterResult {
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">token</span>: string }
    <span class="hljs-attr">success</span>: boolean,
    message?: any
}
<span class="hljs-keyword">export</span> interface LoginResult {
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">token</span>: string }
    <span class="hljs-attr">success</span>: boolean,
    message?: any
}
</code></pre>
<h3 id="t847.8 Register\index.tsx">7.8 Register\index.tsx <a href="#t847.8 Register\index.tsx"> # </a></h3>
<p>src\routes\Register\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> actions <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/actions/profile"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps, Link } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> NavHeader <span class="hljs-keyword">from</span> <span class="hljs-string">"../../components/NavHeader"</span>;
<span class="hljs-keyword">import</span> { Form, Input, Button, message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { CombinedState } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/reducers"</span>;
<span class="hljs-keyword">import</span> { ProfileState } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/reducers/profile"</span>;
<span class="hljs-keyword">import</span> { UserAddOutlined, LockOutlined, MailOutlined } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/icons"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
type StateProps = ReturnType&lt;<span class="hljs-keyword">typeof</span> mapStateToProps&gt;;
type DispatchProps = <span class="hljs-keyword">typeof</span> actions;
interface Params {}
type Props = RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Register</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">const</span> onFinish = <span class="hljs-function">(<span class="hljs-params">values: any</span>) =&gt;</span> {
    props.register(values);
  };
  <span class="hljs-keyword">const</span> onFinishFailed = <span class="hljs-function">(<span class="hljs-params">errorInfo: any</span>) =&gt;</span> {
    message.error(<span class="hljs-string">"表单验证失败! "</span> + errorInfo);
  };
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavHeader</span> <span class="hljs-attr">history</span>=<span class="hljs-string">{props.history}</span>&gt;</span>用户注册<span class="hljs-tag">&lt;/<span class="hljs-name">NavHeader</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Form</span>
        <span class="hljs-attr">onFinish</span>=<span class="hljs-string">{onFinish}</span>
        <span class="hljs-attr">onFinishFailed</span>=<span class="hljs-string">{onFinishFailed}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"login-form"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>
          <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>
          <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> "请输入你的用户名!" }]}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">UserAddOutlined</span> /&gt;</span>} placeholder="用户名" /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>
          <span class="hljs-attr">label</span>=<span class="hljs-string">"密码"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> "请输入你的密码!" }]}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LockOutlined</span> /&gt;</span>} type="password" placeholder="密码" /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>
          <span class="hljs-attr">label</span>=<span class="hljs-string">"确认密码"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"confirmPassword"</span>
          <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> "请输入你的确认密码!" }]}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span>
            <span class="hljs-attr">prefix</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LockOutlined</span> /&gt;</span>}
            type="password"
            placeholder="确认密码"
          /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>
          <span class="hljs-attr">label</span>=<span class="hljs-string">"邮箱"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span>
          <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> "请输入你的邮箱!" }]}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">MailOutlined</span> /&gt;</span>} type="email" placeholder="邮箱" /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">htmlType</span>=<span class="hljs-string">"submit"</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"login-form-button"</span>
          &gt;</span>
            注册
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          或者 <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span>&gt;</span>立刻登录!<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">let</span> mapStateToProps = (state: CombinedState): <span class="hljs-function"><span class="hljs-params">ProfileState</span> =&gt;</span> state.profile;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(mapStateToProps, actions)(Register);
</code></pre>
<p>routes\Register\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-class">.login-form</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<h3 id="t857.9 Login\index.tsx">7.9 Login\index.tsx <a href="#t857.9 Login\index.tsx"> # </a></h3>
<p>src\routes\Login\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> actions <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/actions/profile"</span>;
<span class="hljs-keyword">import</span> { Link, RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> NavHeader <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/NavHeader"</span>;
<span class="hljs-keyword">import</span> { Form, Input, Button, message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-keyword">import</span> { CombinedState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/reducers"</span>;
<span class="hljs-keyword">import</span> { ProfileState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/reducers/profile"</span>;
<span class="hljs-keyword">import</span> { UserAddOutlined, LockOutlined, MailOutlined } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/icons"</span>;
type StateProps = ReturnType&lt;<span class="hljs-keyword">typeof</span> mapStateToProps&gt;;
type DispatchProps = <span class="hljs-keyword">typeof</span> actions;
interface Params {}
type Props = RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Register</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">const</span> onFinish = <span class="hljs-function">(<span class="hljs-params">values: any</span>) =&gt;</span> {
    props.login(values);
  };
  <span class="hljs-keyword">const</span> onFinishFailed = <span class="hljs-function">(<span class="hljs-params">errorInfo: any</span>) =&gt;</span> {
    message.error(<span class="hljs-string">"表单验证失败! "</span> + errorInfo);
  };
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavHeader</span> <span class="hljs-attr">history</span>=<span class="hljs-string">{props.history}</span>&gt;</span>用户登录<span class="hljs-tag">&lt;/<span class="hljs-name">NavHeader</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Form</span>
        <span class="hljs-attr">onFinish</span>=<span class="hljs-string">{onFinish}</span>
        <span class="hljs-attr">onFinishFailed</span>=<span class="hljs-string">{onFinishFailed}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"login-form"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>
          <span class="hljs-attr">label</span>=<span class="hljs-string">"用户名"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>
          <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> "请输入你的用户名!" }]}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">UserAddOutlined</span> /&gt;</span>} placeholder="用户名" /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>
          <span class="hljs-attr">label</span>=<span class="hljs-string">"密码"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> "请输入你的密码!" }]}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LockOutlined</span> /&gt;</span>} type="password" placeholder="密码" /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">htmlType</span>=<span class="hljs-string">"submit"</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"login-form-button"</span>
          &gt;</span>
            登录
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          或者 <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/register"</span>&gt;</span>立刻注册!<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> mapStateToProps = (state: CombinedState): <span class="hljs-function"><span class="hljs-params">ProfileState</span> =&gt;</span> state.profile;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(mapStateToProps, actions)(Register);
</code></pre>
<h3 id="t867.10 Login\index.less">7.10 Login\index.less <a href="#t867.10 Login\index.less"> # </a></h3>
<p>src\routes\Login\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-class">.login-form</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.2rem</span>;
}
</code></pre>
<h2 id="t87第8章 上传头像">第8章 上传头像 <a href="#t87第8章 上传头像"> # </a></h2>
<ul>
<li>本章节我们学习如何向服务器端上传头像</li>
<li>本章学习如下内容<ul>
<li>如何使用 antdesign 的图片上传组件<h3 id="t888.1 参考">8.1 参考 <a href="#t888.1 参考"> # </a></h3>
<h4 id="t898.1.1 本章目录">8.1.1 本章目录 <a href="#t898.1.1 本章目录"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── src
│   ├── api
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   └── HomeHeader
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   └── typings
│       ├── images.d.ts
│       ├── login-types.tsx
│       └── user.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 id="t908.1.2 本章效果">8.1.2 本章效果 <a href="#t908.1.2 本章效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/uploadavatar.gif" alt="uploadavatar.gif"></p>
<h3 id="t918.2 Profile\index.tsx">8.2 Profile\index.tsx <a href="#t918.2 Profile\index.tsx"> # </a></h3>
<p>src\routes\Profile\index.tsx</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import React, { PropsWithChildren, useEffect, useState } from "react";</span>
import { connect } from "react-redux";
import { CombinedState } from "../../store/reducers";
import { ProfileState } from "../../store/reducers/profile";
import actions from "../../store/actions/profile";
import LOGIN_TYPES from "../../typings/login-types";
import { RouteComponentProps } from "react-router";
<span class="hljs-addition">+import { Descriptions, Button, Alert, message, Upload } from "antd";</span>
import NavHeader from "../../components/NavHeader";
import { AxiosError } from "axios";
import "./index.less";
<span class="hljs-addition">+import { LoadingOutlined, UploadOutlined } from "@ant-design/icons";</span>
//当前的组件有三个属性来源
//1.mapStateToProps的返回值 2.actions对象类型 3. 来自路由 4.用户传入进来的其它属性
type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;
type DispatchProps = typeof actions;
interface Params {}
type RouteProps = RouteComponentProps&lt;Params&gt;;
type Props = PropsWithChildren&lt;StateProps &amp; DispatchProps &amp; RouteProps&gt;;
<span class="hljs-addition">+const mapStateToProps = (initialState: CombinedState): ProfileState =&gt;initialState.profile;</span>
function Profile(props: Props) {
<span class="hljs-addition">+  let [loading, setLoading] = useState(false);</span>
  //组件加载后直接 发起验证请求,查看此用户是否已经登录过了,如果没有登录则提示错误
  useEffect(() =&gt; {
    props.validate().catch((error: AxiosError) =&gt; message.error(error.message));
  }, []);
<span class="hljs-addition">+  const handleChange = (info: any) =&gt; {</span>
<span class="hljs-addition">+    if (info.file.status === "uploading") {</span>
<span class="hljs-addition">+      setLoading(true);</span>
<span class="hljs-addition">+    } else if (info.file.status === "done") {</span>
<span class="hljs-addition">+      let { success, data, message } = info.file.response;</span>
<span class="hljs-addition">+      if (success) {</span>
<span class="hljs-addition">+        setLoading(false);</span>
<span class="hljs-addition">+        props.changeAvatar(data);</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        message.error(message);</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  };</span>
  let content; //里存放着要渲染的内容
  if (props.loginState == LOGIN_TYPES.UN_VALIDATE) {
    //如果未验证则内容为null
    content = null;
  } else if (props.loginState == LOGIN_TYPES.LOGINED) {
<span class="hljs-addition">+    const uploadButton = (</span>
<span class="hljs-addition">+      &lt;div&gt;</span>
<span class="hljs-addition">+        {loading ? &lt;LoadingOutlined /&gt; : &lt;UploadOutlined /&gt;}</span>
<span class="hljs-addition">+        &lt;div className="ant-upload-text"&gt;上传&lt;/div&gt;</span>
<span class="hljs-addition">+      &lt;/div&gt;</span>
<span class="hljs-addition">+    );</span>
    //如果已经登录显示用户信息
    content = (
      &lt;div className="user-info"&gt;
        &lt;Descriptions title="当前登录用户"&gt;
          &lt;Descriptions.Item label="用户名"&gt;
            {props.user.username}
          &lt;/Descriptions.Item&gt;
          &lt;Descriptions.Item label="邮箱"&gt;{props.user.email}&lt;/Descriptions.Item&gt;
<span class="hljs-addition">+          &lt;Descriptions.Item label="头像"&gt;</span>
<span class="hljs-addition">+            &lt;Upload</span>
<span class="hljs-addition">+              name="avatar"</span>
<span class="hljs-addition">+              listType="picture-card"</span>
<span class="hljs-addition">+              className="avatar-uploader"</span>
<span class="hljs-addition">+              showUploadList={false}</span>
<span class="hljs-addition">+              action="http://localhost:8000/user/uploadAvatar"</span>
<span class="hljs-addition">+              beforeUpload={beforeUpload}</span>
<span class="hljs-addition">+              data={{ userId: props.user.id }}</span>
<span class="hljs-addition">+              onChange={handleChange}</span>
<span class="hljs-addition">+            &gt;</span>
<span class="hljs-addition">+              {props.user.avatar ? (</span>
<span class="hljs-addition">+                &lt;img</span>
<span class="hljs-addition">+                  src={props.user.avatar}</span>
<span class="hljs-addition">+                  alt="avatar"</span>
<span class="hljs-addition">+                  style={{ width: "100%" }}</span>
<span class="hljs-addition">+                /&gt;</span>
<span class="hljs-addition">+              ) : (</span>
<span class="hljs-addition">+                uploadButton</span>
<span class="hljs-addition">+              )}</span>
<span class="hljs-addition">+            &lt;/Upload&gt;</span>
<span class="hljs-addition">+          &lt;/Descriptions.Item&gt;</span>
        &lt;/Descriptions&gt;
        &lt;Button
          type={"primary"}
          onClick={async () =&gt; {
            await props.logout();
            props.history.push("/login");
          }}
        &gt;
          退出登录
        &lt;/Button&gt;
      &lt;/div&gt;
    );
  } else {
    //如果没有登录,则显示注册和登录按钮
    content = (
      &lt;&gt;
        &lt;Alert
          type="warning"
          message="当前未登录"
          description="亲爱的用户你好，你当前尚未登录，请你选择注册或者登录"
        /&gt;
        &lt;div style={{ textAlign: "center", padding: "50px" }}&gt;
          &lt;Button type="dashed" onClick={() =&gt; props.history.push("/login")}&gt;
            登录
          &lt;/Button&gt;
          &lt;Button
            type="dashed"
            style={{ marginLeft: "50px" }}
            onClick={() =&gt; props.history.push("/register")}
          &gt;
            注册
          &lt;/Button&gt;
        &lt;/div&gt;
      &lt;/&gt;
    );
  }
  return (
    &lt;section&gt;
      &lt;NavHeader history={props.history}&gt;个人中心&lt;/NavHeader&gt;
      {content}
    &lt;/section&gt;
  );
}

<span class="hljs-addition">+export default connect(mapStateToProps, actions)(Profile);</span>
<span class="hljs-addition">+function beforeUpload(file: any) {</span>
<span class="hljs-addition">+  const isJpgOrPng = file.type === "image/jpeg" || file.type === "image/png";</span>
<span class="hljs-addition">+  if (!isJpgOrPng) {</span>
<span class="hljs-addition">+    message.error("你只能上传JPG/PNG 文件!");</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  const isLessThan2M = file.size / 1024 / 1024 &lt; 2;</span>
<span class="hljs-addition">+  if (!isLessThan2M) {</span>
<span class="hljs-addition">+    message.error("图片必须小于2MB!");</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return isJpgOrPng &amp;&amp; isLessThan2M;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t928.3 action-types.tsx">8.3 action-types.tsx <a href="#t928.3 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = "ADD";
//设置当前分类的名称
export const SET_CURRENT_CATEGORY = "SET_CURRENT_CATEGORY";
//发起验证用户是否登录的请求
export const VALIDATE = "VALIDATE";

export const LOGOUT = "LOGOUT";
<span class="hljs-addition">+//上传头像</span>
<span class="hljs-addition">+export const CHANGE_AVATAR = "CHANGE_AVATAR";</span>

</code></pre>
<h3 id="t938.4 reducers\profile.tsx">8.4 reducers\profile.tsx <a href="#t938.4 reducers\profile.tsx"> # </a></h3>
<p>src\store\reducers\profile.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from "redux";
import * as TYPES from "../action-types";
import LOGIN_TYPES from "../../typings/login-types";
export interface ProfileState {
  loginState: LOGIN_TYPES; //当前用户的登录状态
  user: any; //当前已经登录的用户信息
  error: string | null; //错误信息
}
let initialState: ProfileState = {
  //初始状态
  loginState: LOGIN_TYPES.UN_VALIDATE, //当前用户的登录状态
  user: null, //当前已经登录的用户信息
  error: null, //错误信息
};
export default function (
  state: ProfileState = initialState,
  action: AnyAction
): ProfileState {
  switch (action.type) {
    case TYPES.VALIDATE:
      if (action.payload.success) {
        //如果此用户已经登录了
        return {
          ...state,
          loginState: LOGIN_TYPES.LOGINED,
          user: action.payload.data, //设置用户名
          error: null, //没有错误
        };
      } else {
        return {
          ...state,
          loginState: LOGIN_TYPES.UNLOGIN,
          user: null, //用户名为空
          error: action.payload, //错误对象赋值
        };
      }
<span class="hljs-addition">+    case TYPES.LOGOUT:</span>
<span class="hljs-addition">+      return {</span>
<span class="hljs-addition">+        ...state,</span>
<span class="hljs-addition">+        loginState: LOGIN_TYPES.UN_VALIDATE,</span>
<span class="hljs-addition">+        user: null,</span>
<span class="hljs-addition">+        error: null,</span>
<span class="hljs-addition">+      };</span>
<span class="hljs-addition">+    case TYPES.CHANGE_AVATAR:</span>
<span class="hljs-addition">+      return { ...state, user: { ...state.user, avatar: action.payload } };</span>
    default:
      return state;
  }
}

</code></pre>
<h3 id="t948.5 actions\profile.tsx">8.5 actions\profile.tsx <a href="#t948.5 actions\profile.tsx"> # </a></h3>
<p>src\store\actions\profile.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from "redux";
import * as TYPES from "../action-types";
import { validate, register, login } from "@/api/profile";
import { push } from "connected-react-router";
import {
  RegisterPayload,
  LoginPayload,
  RegisterResult,
  LoginResult,
} from "@/typings/user";
import { message } from "antd";
export default {
  //https://github.com/redux-utilities/redux-promise/blob/master/src/index.js
  validate(): AnyAction {
    //发起判断当前用户是否登录的请求
    return {
      type: TYPES.VALIDATE,
      payload: validate(),
    };
  },
  register(values: RegisterPayload) {
    return function (dispatch: any) {
      (async function () {
        try {
          let result: RegisterResult = await register&lt;RegisterResult&gt;(values);
          if (result.success) {
            dispatch(push("/login"));
          } else {
            message.error(result.message);
          }
        } catch (error) {
          message.error("注册失败");
        }
      })();
    };
  },
  login(values: LoginPayload) {
    return function (dispatch: any) {
      (async function () {
        try {
          let result: LoginResult = await login&lt;LoginResult&gt;(values);
          if (result.success) {
            sessionStorage.setItem("access_token", result.data.token);
            dispatch(push("/profile"));
          } else {
            message.error(result.message);
          }
        } catch (error) {
          message.error("登录失败");
        }
      })();
    };
  },
  logout() {
    return function (dispatch: any) {
      sessionStorage.removeItem("access_token");
      dispatch({ type: TYPES.LOGOUT });
      dispatch(push("/login"));
    };
  },
<span class="hljs-addition">+  changeAvatar(avatar: string) {</span>
<span class="hljs-addition">+    return {</span>
<span class="hljs-addition">+      type: TYPES.CHANGE_AVATAR,</span>
<span class="hljs-addition">+      payload: avatar,</span>
<span class="hljs-addition">+    };</span>
<span class="hljs-addition">+  },</span>
};
</code></pre>
<h2 id="t95第9章 后台轮播图轮播图接口">第9章 后台轮播图轮播图接口 <a href="#t95第9章 后台轮播图轮播图接口"> # </a></h2>
<ul>
<li>本章是编写轮播图接口</li>
</ul>
<h3 id="t969.1 参考">9.1 参考 <a href="#t969.1 参考"> # </a></h3>
<h4 id="t979.1.1 本章目录">9.1.1 本章目录 <a href="#t979.1.1 本章目录"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── src
│   ├── controller
│   │   ├── slider.ts
│   │   └── user.ts
│   ├── exceptions
│   │   └── HttpException.ts
│   ├── index.ts
│   ├── middlewares
│   │   └── errorMiddleware.ts
│   ├── models
│   │   ├── index.ts
│   │   ├── slider.ts
│   │   └── user.ts
│   ├── public
│   ├── typings
│   │   ├── express.d.ts
│   │   └── jwt.ts
│   └── utils
│       └── validator.ts
└── tsconfig.json
</code></pre>
<p>本章效果
<img src="http://img.zhufengpeixun.cn/getslidersapi.png" alt="getslidersapi"></p>
<h3 id="t989.2 src\index.ts">9.2 src\index.ts <a href="#t989.2 src\index.ts"> # </a></h3>
<p>src\index.ts</p>
<pre><code class="lang-diff">import express, { Express, Request, Response, NextFunction } from 'express';
import mongoose from 'mongoose';
import HttpException from './exceptions/HttpException';
import cors from 'cors';
import morgan from 'morgan';
import helmet from 'helmet';
import errorMiddleware from './middlewares/errorMiddleware';
import *  as userController from './controller/user';
<span class="hljs-addition">+import *  as sliderController from './controller/slider';</span>
import "dotenv/config";
import multer from 'multer';
import path from 'path';
<span class="hljs-addition">+import { Slider } from './models';</span>
const storage = multer.diskStorage({
    destination: path.join(__dirname, 'public', 'uploads'),
    filename(_req: Request, file: Express.Multer.File, cb) {
        cb(null, Date.now() + path.extname(file.originalname));
    }
});
const upload = multer({ storage });
const app: Express = express();
app.use(morgan("dev"));
app.use(cors());
app.use(helmet());
app.use(express.static(path.resolve(__dirname, 'public')));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.get('/', (_req: Request, res: Response) =&gt; {
    res.json({ success: true, message: 'hello world' });
});
app.get('/user/validate', userController.validate);
app.post('/user/register', userController.register);
app.post('/user/login', userController.login);
app.post('/user/uploadAvatar', upload.single('avatar'), userController.uploadAvatar);
<span class="hljs-addition">+app.get('/slider/list', sliderController.list);</span>
app.use((_req: Request, _res: Response, next: NextFunction) =&gt; {
    const error: HttpException = new HttpException(404, 'Route not found');
    next(error);
});
app.use(errorMiddleware);
const PORT: number = (process.env.PORT &amp;&amp; parseInt(process.env.PORT)) || 8000;
(async function () {
    mongoose.set('useNewUrlParser', true);
    mongoose.set('useUnifiedTopology', true);
    await mongoose.connect(process.env.MONGODB_URL!);
<span class="hljs-addition">+    await createSliders();</span>
    app.listen(PORT, () =&gt; {
        console.log(`Running on http://localhost:${PORT}`);
    });
})();

<span class="hljs-addition">+async function createSliders() {</span>
<span class="hljs-addition">+    const sliders = await Slider.find();</span>
<span class="hljs-addition">+    if (sliders.length == 0) {</span>
<span class="hljs-addition">+        const sliders:any = [</span>
<span class="hljs-addition">+            { url: 'http://img.zhufengpeixun.cn/post_reactnative.png' },</span>
<span class="hljs-addition">+            { url: 'http://img.zhufengpeixun.cn/post_react.png' },</span>
<span class="hljs-addition">+            { url: 'http://img.zhufengpeixun.cn/post_vue.png' },</span>
<span class="hljs-addition">+            { url: 'http://img.zhufengpeixun.cn/post_wechat.png' },</span>
<span class="hljs-addition">+            { url: 'http://img.zhufengpeixun.cn/post_architect.jpg' }</span>
<span class="hljs-addition">+        ];</span>
<span class="hljs-addition">+        Slider.create(sliders);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t999.3 controller\slider.ts">9.3 controller\slider.ts <a href="#t999.3 controller\slider.ts"> # </a></h3>
<p>src\controller\slider.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Request, Response } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> { ISliderDocument, Slider } <span class="hljs-keyword">from</span> <span class="hljs-string">"../models"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> list = <span class="hljs-keyword">async</span> (_req: Request, <span class="hljs-attr">res</span>: Response) =&gt; {
  <span class="hljs-keyword">let</span> sliders: ISliderDocument[] = <span class="hljs-keyword">await</span> Slider.find();
  res.json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: sliders });
};
</code></pre>
<h3 id="t1009.4 models\slider.ts">9.4 models\slider.ts <a href="#t1009.4 models\slider.ts"> # </a></h3>
<p>src\models\slider.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> mongoose, { Schema, Document } <span class="hljs-keyword">from</span> <span class="hljs-string">"mongoose"</span>;
<span class="hljs-keyword">export</span> interface ISliderDocument extends Document {
  <span class="hljs-attr">url</span>: string;
}
<span class="hljs-keyword">const</span> SliderSchema: Schema&lt;ISliderDocument&gt; = <span class="hljs-keyword">new</span> Schema(
  {
    <span class="hljs-attr">url</span>: <span class="hljs-built_in">String</span>,
  },
  { <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span> }
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Slider =
  mongoose.model &lt; ISliderDocument &gt; (<span class="hljs-string">"Slider"</span>, SliderSchema);
</code></pre>
<h3 id="t1019.5 src\models\index.ts">9.5 src\models\index.ts <a href="#t1019.5 src\models\index.ts"> # </a></h3>
<p>src\models\index.ts</p>
<pre><code class="lang-diff">export * from './user';
<span class="hljs-addition">+export * from './slider';</span>
</code></pre>
<h2 id="t102第10章 前台轮播图">第10章 前台轮播图 <a href="#t102第10章 前台轮播图"> # </a></h2>
<ul>
<li>本章实践前台轮播图</li>
<li>本章需要实践的内容<ul>
<li>使用<code>useRef</code>取得 DOM 元素</li>
<li>使用 <code>antdesign</code> 的轮播图组件</li>
</ul>
</li>
</ul>
<h3 id="t10310.1 参考">10.1 参考 <a href="#t10310.1 参考"> # </a></h3>
<h4 id="t10410.1.1 本章目录">10.1.1 本章目录 <a href="#t10410.1.1 本章目录"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── README.md
├── src
│   ├── api
│   │   ├── home.tsx
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   ├── HomeHeader
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   └── HomeSliders
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   └── typings
│       ├── images.d.ts
│       ├── login-types.tsx
│       ├── slider.tsx
│       └── user.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t10510.1.2 本章效果">10.1.2 本章效果 <a href="#t10510.1.2 本章效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/homesliders.gif" alt="homesliders"></p>
<h3 id="t10610.2 action-types.tsx">10.2 action-types.tsx <a href="#t10610.2 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = "ADD";
//设置当前分类的名称
export const SET_CURRENT_CATEGORY = "SET_CURRENT_CATEGORY";
//发起验证用户是否登录的请求
export const VALIDATE = "VALIDATE";

export const LOGOUT = "LOGOUT";
//上传头像
export const CHANGE_AVATAR = "CHANGE_AVATAR";
<span class="hljs-addition">+export const GET_SLIDERS = "GET_SLIDERS";</span>
</code></pre>
<h3 id="t10710.3 actions\home.tsx">10.3 actions\home.tsx <a href="#t10710.3 actions\home.tsx"> # </a></h3>
<p>src\store\actions\home.tsx</p>
<pre><code class="lang-diff">import * as TYPES from "../action-types";
<span class="hljs-addition">+import { getSliders } from "@/api/home";</span>
export default {
  setCurrentCategory(currentCategory: string) {
    return { type: TYPES.SET_CURRENT_CATEGORY, payload: currentCategory };
  },
<span class="hljs-addition">+  getSliders() {</span>
<span class="hljs-addition">+    return {</span>
<span class="hljs-addition">+      type: TYPES.GET_SLIDERS,</span>
<span class="hljs-addition">+      payload: getSliders(),</span>
<span class="hljs-addition">+    };</span>
<span class="hljs-addition">+  }</span>
};

</code></pre>
<h3 id="t10810.4 typings\slider.tsx">10.4 typings\slider.tsx <a href="#t10810.4 typings\slider.tsx"> # </a></h3>
<p>src\typings\slider.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> interface Slider {
  <span class="hljs-attr">url</span>: string;
}
</code></pre>
<h3 id="t10910.5 reducers\home.tsx">10.5 reducers\home.tsx <a href="#t10910.5 reducers\home.tsx"> # </a></h3>
<p>src\store\reducers\home.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from "redux";
import * as TYPES from "../action-types";
<span class="hljs-addition">+import Slider from "@/typings/slider";</span>
export interface HomeState {
  currentCategory: string;
<span class="hljs-addition">+  sliders: Slider[];</span>
}
let initialState: HomeState = {
  currentCategory: "all", //默认当前的分类是显示全部类型的课程
<span class="hljs-addition">+  sliders: [],</span>
};
export default function (
  state: HomeState = initialState,
  action: AnyAction
): HomeState {
  switch (action.type) {
    case TYPES.SET_CURRENT_CATEGORY: //修改当前分类
      return { ...state, currentCategory: action.payload };
<span class="hljs-addition">+    case TYPES.GET_SLIDERS:</span>
<span class="hljs-addition">+      return { ...state, sliders: action.payload.data };</span>
    default:
      return state;
  }
}
</code></pre>
<h3 id="t11010.6 api\home.tsx">10.6 api\home.tsx <a href="#t11010.6 api\home.tsx"> # </a></h3>
<p>src\api\home.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"./index"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSliders</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> axios.get(<span class="hljs-string">"/slider/list"</span>);
}
</code></pre>
<h3 id="t11110.7 HomeSliders\index.tsx">10.7 HomeSliders\index.tsx <a href="#t11110.7 HomeSliders\index.tsx"> # </a></h3>
<p>src\routes\Home\components\HomeSliders\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { PropsWithChildren, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { Carousel } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-keyword">import</span> Slider <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/slider"</span>;
type Props = PropsWithChildren&lt;{
  children?: any,
  sliders?: Slider[],
  getSliders?: any,
}&gt;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">HomeSliders</span>(<span class="hljs-params">props: Props</span>) </span>{
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (props.sliders.length == <span class="hljs-number">0</span>) {
      props.getSliders();
    }
  }, []);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Carousel</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"scrollx"</span> <span class="hljs-attr">autoplay</span>&gt;</span>
      {props.sliders.map((item: Slider, index: number) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{item.url}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Carousel</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> HomeSliders;
</code></pre>
<h3 id="t11210.8 HomeSliders\index.less">10.8 HomeSliders\index.less <a href="#t11210.8 HomeSliders\index.less"> # </a></h3>
<p>src\routes\Home\components\HomeSliders\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-class">.ant-carousel</span> <span class="hljs-selector-class">.slick-slide</span> {
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">320px</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">320px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#364d79</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.ant-carousel</span> <span class="hljs-selector-class">.slick-slide</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-selector-tag">img</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">320px</span>;
  }
}
</code></pre>
<h3 id="t11310.9 routes\Home\index.tsx">10.9 routes\Home\index.tsx <a href="#t11310.9 routes\Home\index.tsx"> # </a></h3>
<p>src\routes\Home\index.tsx</p>
<pre><code class="lang-diff">import React, { PropsWithChildren, useRef } from "react";
import { connect } from "react-redux";
import { RouteComponentProps } from "react-router-dom";
import actions from "@/store/actions/home";
import HomeHeader from "./components/HomeHeader";
import { CombinedState } from "@/store/reducers";
import { HomeState } from "@/store/reducers/home";
<span class="hljs-addition">+import HomeSliders from "./components/HomeSliders";</span>
import "./index.less";
type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;
type DispatchProps = typeof actions;
interface Params {}
type Props = PropsWithChildren&lt;
  RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps
&gt;;
function Home(props: Props) {
<span class="hljs-addition">+  const homeContainerRef = useRef(null);</span>
  return (
    &lt;&gt;
      &lt;HomeHeader
        currentCategory={props.currentCategory}
        setCurrentCategory={props.setCurrentCategory}
      /&gt;
<span class="hljs-addition">+      &lt;div className="home-container" ref={homeContainerRef}&gt;</span>
<span class="hljs-addition">+        &lt;HomeSliders sliders={props.sliders} getSliders={props.getSliders} /&gt;</span>
<span class="hljs-addition">+      &lt;/div&gt;</span>
    &lt;/&gt;
  );
}
let mapStateToProps = (state: CombinedState): HomeState =&gt; state.home;
export default connect(mapStateToProps, actions)(Home);
</code></pre>
<h2 id="t114第11章 课程管理后端接口">第11章 课程管理后端接口 <a href="#t114第11章 课程管理后端接口"> # </a></h2>
<ul>
<li>本章主要编写课程管理的后台接口</li>
</ul>
<h3 id="t11511.1 参考">11.1 参考 <a href="#t11511.1 参考"> # </a></h3>
<h4 id="t11611.1.1 本章目录">11.1.1 本章目录 <a href="#t11611.1.1 本章目录"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── src
│ ├── controller
│ │ ├── lesson.ts
│ │ ├── slider.ts
│ │ └── user.ts
│ ├── exceptions
│ │ └── HttpException.ts
│ ├── index.ts
│ ├── middlewares
│ │ └── errorMiddleware.ts
│ ├── models
│ │ ├── index.ts
│ │ ├── lesson.ts
│ │ ├── slider.ts
│ │ └── user.ts
│ ├── public
│ ├── typings
│ │ ├── express.d.ts
│ │ └── jwt.ts
│ └── utils
│     └── validator.ts
└── tsconfig.json
</code></pre>
<h4 id="t11711.1.2 本章效果">11.1.2 本章效果 <a href="#t11711.1.2 本章效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/lessonlistinterface.gif" alt="lessonlistinterface"></p>
<h3 id="t11811.2 src\index.ts">11.2 src\index.ts <a href="#t11811.2 src\index.ts"> # </a></h3>
<p>src\index.ts</p>
<pre><code class="lang-diff">import express, { Express, Request, Response, NextFunction } from "express";
import mongoose from "mongoose";
import HttpException from "./exceptions/HttpException";
import cors from "cors";
import morgan from "morgan";
import helmet from "helmet";
import errorMiddleware from "./middlewares/errorMiddleware";
import * as userController from "./controller/user";
import * as sliderController from "./controller/slider";
<span class="hljs-addition">+import * as lessonController from "./controller/lesson";</span>
import "dotenv/config";
import multer from "multer";
import path from "path";
<span class="hljs-addition">+import { Slider, Lesson } from "./models";</span>
const storage = multer.diskStorage({
  destination: path.join(__dirname, "public", "uploads"),
  filename(_req: Request, file: Express.Multer.File, cb) {
    cb(null, Date.now() + path.extname(file.originalname));
  },
});
const upload = multer({ storage });
const app: Express = express();
app.use(morgan("dev"));
app.use(cors());
app.use(helmet());
app.use(express.static(path.resolve(__dirname, "public")));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.get("/", (_req: Request, res: Response) =&gt; {
  res.json({ success: true, message: "hello world" });
});
app.get("/user/validate", userController.validate);
app.post("/user/register", userController.register);
app.post("/user/login", userController.login);
app.post(
  "/user/uploadAvatar",
  upload.single("avatar"),
  userController.uploadAvatar
);
app.get("/slider/list", sliderController.list);
<span class="hljs-addition">+app.get("/lesson/list", lessonController.list);</span>
<span class="hljs-addition">+app.get("/lesson/:id", lessonController.get);</span>
app.use((_req: Request, _res: Response, next: NextFunction) =&gt; {
  const error: HttpException = new HttpException(404, "Route not found");
  next(error);
});
app.use(errorMiddleware);
const PORT: number = (process.env.PORT &amp;&amp; parseInt(process.env.PORT)) || 8000;
(async function () {
  mongoose.set("useNewUrlParser", true);
  mongoose.set("useUnifiedTopology", true);
  await mongoose.connect("mongodb://localhost/zhufengketang");
  await createSliders();
<span class="hljs-addition">+  await createLessons();</span>
  app.listen(PORT, () =&gt; {
    console.log(`Running on http://localhost:${PORT}`);
  });
})();

async function createSliders() {
  const sliders = await Slider.find();
  if (sliders.length == 0) {
    const initSliders: any = [
      { url: "http://img.zhufengpeixun.cn/post_reactnative.png" },
      { url: "http://img.zhufengpeixun.cn/post_react.png" },
      { url: "http://img.zhufengpeixun.cn/post_vue.png" },
      { url: "http://img.zhufengpeixun.cn/post_wechat.png" },
      { url: "http://img.zhufengpeixun.cn/post_architect.jpg" },
    ];
    Slider.create(initSliders);
  }
}

<span class="hljs-addition">+async function createLessons() {</span>
<span class="hljs-addition">+  const lessons = await Lesson.find();</span>
<span class="hljs-addition">+  if (lessons.length == 0) {</span>
<span class="hljs-addition">+    const lessons: any = [</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 1,</span>
<span class="hljs-addition">+        title: "1.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥100.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 2,</span>
<span class="hljs-addition">+        title: "2.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥200.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 3,</span>
<span class="hljs-addition">+        title: "3.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥300.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 4,</span>
<span class="hljs-addition">+        title: "4.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥400.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 5,</span>
<span class="hljs-addition">+        title: "5.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥500.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 6,</span>
<span class="hljs-addition">+        title: "6.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥100.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 7,</span>
<span class="hljs-addition">+        title: "7.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥200.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 8,</span>
<span class="hljs-addition">+        title: "8.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥300.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 9,</span>
<span class="hljs-addition">+        title: "9.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥400.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 10,</span>
<span class="hljs-addition">+        title: "10.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥500.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 11,</span>
<span class="hljs-addition">+        title: "11.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥600.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 12,</span>
<span class="hljs-addition">+        title: "12.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥700.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 13,</span>
<span class="hljs-addition">+        title: "13.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥800.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 14,</span>
<span class="hljs-addition">+        title: "14.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥900.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 15,</span>
<span class="hljs-addition">+        title: "15.React全栈架构",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/react_poster.jpg",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/react_url.png",</span>
<span class="hljs-addition">+        price: "¥1000.00元",</span>
<span class="hljs-addition">+        category: "react",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 16,</span>
<span class="hljs-addition">+        title: "16.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥600.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 17,</span>
<span class="hljs-addition">+        title: "17.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥700.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 18,</span>
<span class="hljs-addition">+        title: "18.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥800.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 19,</span>
<span class="hljs-addition">+        title: "19.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥900.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+      {</span>
<span class="hljs-addition">+        order: 20,</span>
<span class="hljs-addition">+        title: "20.Vue从入门到项目实战",</span>
<span class="hljs-addition">+        video: "http://img.zhufengpeixun.cn/gee2.mp4",</span>
<span class="hljs-addition">+        poster: "http://img.zhufengpeixun.cn/vue_poster.png",</span>
<span class="hljs-addition">+        url: "http://img.zhufengpeixun.cn/vue_url.png",</span>
<span class="hljs-addition">+        price: "¥1000.00元",</span>
<span class="hljs-addition">+        category: "vue",</span>
<span class="hljs-addition">+      },</span>
<span class="hljs-addition">+    ];</span>
<span class="hljs-addition">+    Lesson.create(lessons);</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t11911.3 src\models\index.ts">11.3 src\models\index.ts <a href="#t11911.3 src\models\index.ts"> # </a></h3>
<p>src\models\index.ts</p>
<pre><code class="lang-diff">export * from './user';
export * from './slider';
<span class="hljs-addition">+export * from './lesson';</span>
</code></pre>
<h3 id="t12011.4 controller\lesson.ts">11.4 controller\lesson.ts <a href="#t12011.4 controller\lesson.ts"> # </a></h3>
<p>src\controller\lesson.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Request, Response } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> { ILessonDocument, Lesson } <span class="hljs-keyword">from</span> <span class="hljs-string">"../models"</span>;
<span class="hljs-keyword">import</span> {FilterQuery} <span class="hljs-keyword">from</span> <span class="hljs-string">'mongoose'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> list = <span class="hljs-keyword">async</span> (req: Request, <span class="hljs-attr">res</span>: Response) =&gt; {
  <span class="hljs-keyword">let</span> { category } = req.query;
  <span class="hljs-keyword">let</span> offset: any = req.query.offset;
  <span class="hljs-keyword">let</span> limit: any = req.query.limit;
  offset = <span class="hljs-built_in">isNaN</span>(offset) ? <span class="hljs-number">0</span> : <span class="hljs-built_in">parseInt</span>(offset); <span class="hljs-comment">//偏移量</span>
  limit = <span class="hljs-built_in">isNaN</span>(limit) ? <span class="hljs-number">5</span> : <span class="hljs-built_in">parseInt</span>(limit); <span class="hljs-comment">//每页条数</span>
  <span class="hljs-keyword">let</span> query: FilterQuery&lt;ILessonDocument&gt; = {};
  <span class="hljs-keyword">if</span> (category &amp;&amp; category != <span class="hljs-string">"all"</span>) query.category = category <span class="hljs-keyword">as</span> string;
  <span class="hljs-keyword">let</span> total = <span class="hljs-keyword">await</span> Lesson.count(query);
  <span class="hljs-keyword">let</span> list = <span class="hljs-keyword">await</span> Lesson.find(query)
    .sort({ <span class="hljs-attr">order</span>: <span class="hljs-number">1</span> })
    .skip(offset)
    .limit(limit);
  list = list.map(<span class="hljs-function">(<span class="hljs-params">item:ILessonDocument</span>)=&gt;</span>item.toJSON());  
  setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    res.json({ <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">data</span>: { list, <span class="hljs-attr">hasMore</span>: total &gt; offset + limit } });
  }, <span class="hljs-number">1000</span>);
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">get</span> = async (req: Request, res: Response) =&gt; {
  <span class="hljs-keyword">let</span> id = req.params.id;
  <span class="hljs-keyword">let</span> lesson = <span class="hljs-keyword">await</span> Lesson.findById(id);
  res.json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: lesson });
};
</code></pre>
<h3 id="t12111.5 models\lesson.ts">11.5 models\lesson.ts <a href="#t12111.5 models\lesson.ts"> # </a></h3>
<p>src\models\lesson.ts</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> mongoose, { Schema, Document } <span class="hljs-keyword">from</span> <span class="hljs-string">"mongoose"</span>;
<span class="hljs-keyword">export</span> interface ILessonDocument extends Document {
  <span class="hljs-attr">order</span>: number; <span class="hljs-comment">//顺序</span>
  title: string; <span class="hljs-comment">//标题</span>
  video: string; <span class="hljs-comment">//视频</span>
  poster: string; <span class="hljs-comment">//海报</span>
  url: string; <span class="hljs-comment">//url地址</span>
  price: string; <span class="hljs-comment">//价格</span>
  category: string; <span class="hljs-comment">//分类</span>
}
<span class="hljs-keyword">const</span> LessonSchema: Schema&lt;ILessonDocument&gt; = <span class="hljs-keyword">new</span> Schema(
  {
    <span class="hljs-attr">order</span>: <span class="hljs-built_in">Number</span>, <span class="hljs-comment">//顺序</span>
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//标题</span>
    <span class="hljs-attr">video</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//视频</span>
    <span class="hljs-attr">poster</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//海报</span>
    <span class="hljs-attr">url</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//url地址</span>
    <span class="hljs-attr">price</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//价格</span>
    <span class="hljs-attr">category</span>: <span class="hljs-built_in">String</span>, <span class="hljs-comment">//分类</span>
  },
  { <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>,<span class="hljs-attr">toJSON</span>:{
    transform(_doc,ret){
        ret.id=ret._id;
        <span class="hljs-keyword">delete</span> ret._id;
        <span class="hljs-keyword">delete</span> ret.__v;
        <span class="hljs-keyword">delete</span> ret.password;
        <span class="hljs-keyword">return</span> ret;
    }
} }
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Lesson = mongoose.model &lt; ILessonDocument &gt; (<span class="hljs-string">"Lesson"</span>, LessonSchema);
</code></pre>
<h2 id="t122第12章 课程列表">第12章 课程列表 <a href="#t122第12章 课程列表"> # </a></h2>
<ul>
<li>本章实践的内容<ul>
<li>加载课程列表</li>
<li>上拉加载</li>
</ul>
</li>
</ul>
<h3 id="t12312.1 参考">12.1 参考 <a href="#t12312.1 参考"> # </a></h3>
<h4 id="t12412.1.1 目录结构">12.1.1 目录结构 <a href="#t12412.1.1 目录结构"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── src
│   ├── api
│   │   ├── home.tsx
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   ├── HomeHeader
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   ├── HomeSliders
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   └── LessonList
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   ├── typings
│   │   ├── images.d.ts
│   │   ├── lesson.tsx
│   │   ├── login-types.tsx
│   │   ├── slider.tsx
│   │   └── user.tsx
│   └── utils.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t12512.1.2 页面效果">12.1.2 页面效果 <a href="#t12512.1.2 页面效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/lessonlist2.gif" alt="lessonlist2"></p>
<h3 id="t12612.2 src\api\home.tsx">12.2 src\api\home.tsx <a href="#t12612.2 src\api\home.tsx"> # </a></h3>
<p>src\api\home.tsx</p>
<pre><code class="lang-diff">import axios from "./index";
export function getSliders() {
  return axios.get("/slider/list");
}
<span class="hljs-addition">+export function getLessons(</span>
<span class="hljs-addition">+  currentCategory: string = "all",</span>
<span class="hljs-addition">+  offset: number,</span>
<span class="hljs-addition">+  limit: number</span>
<span class="hljs-addition">+) {</span>
<span class="hljs-addition">+  return axios.get(</span>
<span class="hljs-addition">+    `/lesson/list?category=${currentCategory}&amp;offset=${offset}&amp;limit=${limit}`</span>
<span class="hljs-addition">+  );</span>
<span class="hljs-addition">+}</span>

</code></pre>
<h3 id="t12712.3 action-types.tsx">12.3 action-types.tsx <a href="#t12712.3 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = "ADD";
//设置当前分类的名称
export const SET_CURRENT_CATEGORY = "SET_CURRENT_CATEGORY";
//发起验证用户是否登录的请求
export const VALIDATE = "VALIDATE";

export const LOGOUT = "LOGOUT";
//上传头像
export const CHANGE_AVATAR = "CHANGE_AVATAR";
export const GET_SLIDERS = "GET_SLIDERS";

<span class="hljs-addition">+export const GET_LESSONS = "GET_LESSONS";</span>
<span class="hljs-addition">+export const SET_LESSONS_LOADING = "SET_LESSONS_LOADING";</span>
<span class="hljs-addition">+export const SET_LESSONS = "SET_LESSONS";</span>
<span class="hljs-addition">+export const REFRESH_LESSONS = "REFRESH_LESSONS";</span>
</code></pre>
<h3 id="t12812.4 typings\lesson.tsx">12.4 typings\lesson.tsx <a href="#t12812.4 typings\lesson.tsx"> # </a></h3>
<p>src\typings\lesson.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> interface Lesson {
  <span class="hljs-attr">id</span>: string;
  title: string;
  video: string;
  poster: string;
  url: string;
  price: string;
  category: string;
}

interface LessonResult {
  <span class="hljs-attr">data</span>: Lesson;
  success: boolean;
}
<span class="hljs-keyword">export</span> {
  Lesson,
  LessonResult
}
</code></pre>
<h3 id="t12912.5 reducers\home.tsx">12.5 reducers\home.tsx <a href="#t12912.5 reducers\home.tsx"> # </a></h3>
<p>src\store\reducers\home.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from "redux";
import * as TYPES from "../action-types";
import Slider from "@/typings/slider";
<span class="hljs-addition">+import Lesson from "@/typings/Lesson";</span>

<span class="hljs-addition">+export interface Lessons {</span>
<span class="hljs-addition">+  loading: boolean;</span>
<span class="hljs-addition">+  list: Lesson[];</span>
<span class="hljs-addition">+  hasMore: boolean;</span>
<span class="hljs-addition">+  offset: number;</span>
<span class="hljs-addition">+  limit: number;</span>
<span class="hljs-addition">+}</span>
export interface HomeState {
  currentCategory: string;
  sliders: Slider[];
<span class="hljs-addition">+  lessons: Lessons;</span>
}
let initialState: HomeState = {
  currentCategory: "all", //默认当前的分类是显示全部类型的课程
  sliders: [],
<span class="hljs-addition">+  lessons: {</span>
<span class="hljs-addition">+    loading: false,</span>
<span class="hljs-addition">+    list: [],</span>
<span class="hljs-addition">+    hasMore: true,</span>
<span class="hljs-addition">+    offset: 0,</span>
<span class="hljs-addition">+    limit: 5,</span>
<span class="hljs-addition">+  },</span>
};
export default function (
  state: HomeState = initialState,
  action: AnyAction
): HomeState {
  switch (action.type) {
    case TYPES.SET_CURRENT_CATEGORY: //修改当前分类
      return { ...state, currentCategory: action.payload };
    case TYPES.GET_SLIDERS:
      return { ...state, sliders: action.payload.data };
<span class="hljs-addition">+    case TYPES.SET_LESSONS_LOADING:</span>
<span class="hljs-addition">+      return {</span>
<span class="hljs-addition">+        ...state,</span>
<span class="hljs-addition">+        lessons: { ...state.lessons, loading: action.payload },</span>
<span class="hljs-addition">+      };</span>
<span class="hljs-addition">+    case TYPES.SET_LESSONS:</span>
<span class="hljs-addition">+      return {</span>
<span class="hljs-addition">+        ...state,</span>
<span class="hljs-addition">+        lessons: {</span>
<span class="hljs-addition">+          ...state.lessons,</span>
<span class="hljs-addition">+          loading: false,</span>
<span class="hljs-addition">+          hasMore: action.payload.hasMore,</span>
<span class="hljs-addition">+          list: [...state.lessons.list, ...action.payload.list],</span>
<span class="hljs-addition">+          offset: state.lessons.offset + action.payload.list.length,</span>
<span class="hljs-addition">+        },</span>
<span class="hljs-addition">+      };</span>
<span class="hljs-addition">+     case TYPES.REFRESH_LESSONS:</span>
<span class="hljs-addition">+        return {</span>
<span class="hljs-addition">+          ...state,</span>
<span class="hljs-addition">+          lessons: {</span>
<span class="hljs-addition">+            ...state.lessons,</span>
<span class="hljs-addition">+            loading: false,</span>
<span class="hljs-addition">+            hasMore: action.payload.hasMore,</span>
<span class="hljs-addition">+            list: action.payload.list,</span>
<span class="hljs-addition">+            offset: action.payload.list.length,</span>
<span class="hljs-addition">+          },</span>
<span class="hljs-addition">+       };</span>
    default:
      return state;
  }
}
</code></pre>
<h3 id="t13012.6 actions\home.tsx">12.6 actions\home.tsx <a href="#t13012.6 actions\home.tsx"> # </a></h3>
<p>src\store\actions\home.tsx</p>
<pre><code class="lang-diff">import * as TYPES from "../action-types";
<span class="hljs-addition">+import { getSliders, getLessons } from "@/api/home";</span>
export default {
  setCurrentCategory(currentCategory: string) {
    return { type: TYPES.SET_CURRENT_CATEGORY, payload: currentCategory };
  },
  getSliders() {
    return {
      type: TYPES.GET_SLIDERS,
      payload: getSliders(),
    };
  },
<span class="hljs-addition">+  getLessons() {</span>
<span class="hljs-addition">+    return (dispatch: any, getState: any) =&gt; {</span>
<span class="hljs-addition">+      (async function () {</span>
<span class="hljs-addition">+        let {</span>
<span class="hljs-addition">+          currentCategory,</span>
<span class="hljs-addition">+          lessons: { hasMore, offset, limit, loading },</span>
<span class="hljs-addition">+        } = getState().home;</span>
<span class="hljs-addition">+        if (hasMore &amp;&amp; !loading) {</span>
<span class="hljs-addition">+          dispatch({ type: TYPES.SET_LESSONS_LOADING, payload: true });</span>
<span class="hljs-addition">+          let result = await getLessons(currentCategory, offset, limit);</span>
<span class="hljs-addition">+          dispatch({ type: TYPES.SET_LESSONS, payload: result.data });</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+      })();</span>
<span class="hljs-addition">+    };</span>
<span class="hljs-addition">+  },</span>
<span class="hljs-addition">+  refreshLessons() {</span>
<span class="hljs-addition">+    return (dispatch: Function, getState: Function) =&gt; {</span>
<span class="hljs-addition">+      (async function () {</span>
<span class="hljs-addition">+        let {</span>
<span class="hljs-addition">+          currentCategory,</span>
<span class="hljs-addition">+          lessons: { limit, loading },</span>
<span class="hljs-addition">+        } = getState().home;</span>
<span class="hljs-addition">+        if (!loading) {</span>
<span class="hljs-addition">+          dispatch({ type: types.SET_LESSONS_LOADING, payload: true });</span>
<span class="hljs-addition">+          let result = await getLessons(currentCategory, 0, limit);</span>
<span class="hljs-addition">+          dispatch({ type: types.REFRESH_LESSONS, payload: result.data });</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+      })();</span>
<span class="hljs-addition">+ };</span>
};

</code></pre>
<h3 id="t13112.7 src\utils.tsx">12.7 src\utils.tsx <a href="#t13112.7 src\utils.tsx"> # </a></h3>
<p>src\utils.tsx</p>
<pre><code class="lang-js"><span class="hljs-comment">//element 要实现此功能DOM对象 callback加载更多的方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadMore</span>(<span class="hljs-params">element: HTMLElement, callback: Function</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_loadMore</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">let</span> clientHeight = element.clientHeight;
      <span class="hljs-keyword">let</span> scrollTop = element.scrollTop;
      <span class="hljs-keyword">let</span> scrollHeight = element.scrollHeight;
      <span class="hljs-keyword">if</span> (clientHeight + scrollTop + <span class="hljs-number">10</span> &gt;= scrollHeight) {
        callback();
      }
    }
    element.addEventListener(<span class="hljs-string">"scroll"</span>, debounce(_loadMore, <span class="hljs-number">300</span>));
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debounce</span>(<span class="hljs-params">fn: any, wait: number</span>) </span>{
  <span class="hljs-keyword">var</span> timeout: any = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (timeout !== <span class="hljs-literal">null</span>) clearTimeout(timeout);
    timeout = setTimeout(fn, wait);
  };
}
</code></pre>
<h3 id="t13212.8 LessonList\index.tsx">12.8 LessonList\index.tsx <a href="#t13212.8 LessonList\index.tsx"> # </a></h3>
<p>src\routes\Home\components\LessonList\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { useEffect, forwardRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-keyword">import</span> { Card, Skeleton, Button, Alert, Menu } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { Link } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> Lesson <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/lesson"</span>;
<span class="hljs-keyword">import</span> { MenuOutlined } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/icons"</span>;
interface Props {
  children?: any;
  lessons?: any;
  getLessons?: any;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LessonList</span>(<span class="hljs-params">props: Props</span>) </span>{
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (props.lessons.list.length == <span class="hljs-number">0</span>) {
      props.getLessons();
    }
  }, []);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"lesson-list"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MenuOutlined</span> /&gt;</span> 全部课程
      <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Skeleton</span>
        <span class="hljs-attr">loading</span>=<span class="hljs-string">{props.lessons.list.length</span> == <span class="hljs-string">0</span> &amp;&amp; <span class="hljs-attr">props.lessons.loading</span>}
        <span class="hljs-attr">active</span>
        <span class="hljs-attr">paragraph</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">rows:</span> <span class="hljs-attr">8</span> }}
      &gt;</span>
        {props.lessons.list.map((lesson: Lesson, index: number) =&gt;(
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{lesson.id}</span>
            <span class="hljs-attr">to</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">pathname:</span> `/<span class="hljs-attr">detail</span>/${<span class="hljs-attr">lesson.id</span>}`, <span class="hljs-attr">state:</span> <span class="hljs-attr">lesson</span> }}
            &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>
                <span class="hljs-attr">hoverable</span>=<span class="hljs-string">{true}</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%" }}
                <span class="hljs-attr">cover</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{lesson.title}</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{lesson.poster}</span> /&gt;</span>}
            &gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Card.Meta</span>
                <span class="hljs-attr">title</span>=<span class="hljs-string">{lesson.title}</span>
                <span class="hljs-attr">description</span>=<span class="hljs-string">{</span>`价格<span class="hljs-attr">:</span> ¥${<span class="hljs-attr">lesson.price</span>}元`}
                /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        ))}
        {props.lessons.hasMore ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{props.getLessons}</span>
            <span class="hljs-attr">loading</span>=<span class="hljs-string">{props.lessons.loading}</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">block</span>
          &gt;</span>
            {props.lessons.loading ? "" : "加载更多"}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">Alert</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> "<span class="hljs-attr">center</span>" }}
            <span class="hljs-attr">message</span>=<span class="hljs-string">"到底了"</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"warning"</span>
          /&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Skeleton</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span>
  );
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> LessonList;
</code></pre>
<h3 id="t13312.9 LessonList\index.less">12.9 LessonList\index.less <a href="#t13312.9 LessonList\index.less"> # </a></h3>
<p>src\routes\Home\components\LessonList\index.less</p>
<pre><code class="lang-less"><span class="hljs-selector-class">.lesson-list</span> {
  <span class="hljs-selector-tag">h2</span> {
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-selector-tag">i</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
    }
  }
  <span class="hljs-selector-class">.ant-card</span><span class="hljs-selector-class">.ant-card-bordered</span><span class="hljs-selector-class">.ant-card-hoverable</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">650px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
  }
}
</code></pre>
<h3 id="t13412.10 routes\Home\index.tsx">12.10 routes\Home\index.tsx <a href="#t13412.10 routes\Home\index.tsx"> # </a></h3>
<p>src\routes\Home\index.tsx</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import React, { PropsWithChildren, useRef, useEffect } from "react";</span>
import { connect } from "react-redux";
import { RouteComponentProps } from "react-router-dom";
import actions from "@/store/actions/home";
import HomeHeader from "./components/HomeHeader";
import { CombinedState } from "@/store/reducers";
import { HomeState } from "@/store/reducers/home";
import HomeSliders from "./components/HomeSliders";
import "./index.less";
<span class="hljs-addition">+import LessonList from "./components/LessonList";</span>
<span class="hljs-addition">+import { loadMore} from "@/utils";</span>
type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;
type DispatchProps = typeof actions;
interface Params {}
type Props = PropsWithChildren&lt;
  RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps
&gt;;
function Home(props: Props) {
  const homeContainerRef = useRef(null);
  useEffect(() =&gt; {
        loadMore(homeContainerRef.current, props.getLessons);
  }, []);
  return (
    &lt;&gt;
      &lt;HomeHeader
        currentCategory={props.currentCategory}
        setCurrentCategory={props.setCurrentCategory}
        refreshLessons={props.refreshLessons}
      /&gt;
      &lt;div className="home-container" ref={homeContainerRef}&gt;
        &lt;HomeSliders sliders={props.sliders} getSliders={props.getSliders} /&gt;
<span class="hljs-addition">+       &lt;LessonList</span>
<span class="hljs-addition">+          ref={lessonListRef}</span>
<span class="hljs-addition">+          container={homeContainerRef}</span>
<span class="hljs-addition">+          lessons={props.lessons}</span>
<span class="hljs-addition">+          getLessons={props.getLessons}</span>
<span class="hljs-addition">+       /&gt;</span>
      &lt;/div&gt;
    &lt;/&gt;
  );
}
let mapStateToProps = (state: CombinedState): HomeState =&gt; state.home;
export default connect(mapStateToProps, actions)(Home);

</code></pre>
<h3 id="t13512.11 routes\Home\index.less">12.11 routes\Home\index.less <a href="#t13512.11 routes\Home\index.less"> # </a></h3>
<p>src\routes\Home\index.less</p>
<pre><code class="lang-diff"><span class="hljs-addition">+.home-container {</span>
<span class="hljs-addition">+  position: fixed;</span>
<span class="hljs-addition">+  top: 100px;</span>
<span class="hljs-addition">+  left: 0;</span>
<span class="hljs-addition">+  width: 100%;</span>
<span class="hljs-addition">+  overflow-y: auto;</span>
<span class="hljs-addition">+  height: calc(100vh - 222px);</span>
<span class="hljs-addition">+  background-color: #FFF;</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h2 id="t136第13章 课程详情">第13章 课程详情 <a href="#t136第13章 课程详情"> # </a></h2>
<h3 id="t13713.1 参考">13.1 参考 <a href="#t13713.1 参考"> # </a></h3>
<h4 id="t13813.1.1 目录结构">13.1.1 目录结构 <a href="#t13813.1.1 目录结构"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── README.md
├── src
│   ├── api
│   │   ├── home.tsx
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Detail
│   │   │   └── index.tsx
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   ├── HomeHeader
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   ├── HomeSliders
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   └── LessonList
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   ├── typings
│   │   ├── images.d.ts
│   │   ├── lesson.tsx
│   │   ├── login-types.tsx
│   │   ├── slider.tsx
│   │   └── user.tsx
│   └── utils.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t13913.1.2 页面效果">13.1.2 页面效果 <a href="#t13913.1.2 页面效果"> # </a></h4>
<p><img src="http://img.zhufengpeixun.cn/lessondetail.gif" alt="lessondetail"></p>
<h3 id="t14013.2 src\index.tsx">13.2 src\index.tsx <a href="#t14013.2 src\index.tsx"> # </a></h3>
<p>src\index.tsx</p>
<pre><code class="lang-diff">import React from "react";
import ReactDOM from "react-dom";
import { Switch, Route, Redirect } from "react-router-dom"; //三个路由组件
import { Provider } from "react-redux"; //负责把属性中的store传递给子组件
import store from "./store"; //引入仓库
import { ConfigProvider } from "antd"; //配置
import zh_CN from "antd/lib/locale-provider/zh_CN"; //国际化中文
import "./assets/css/common.less"; //通用的样式
import Tabs from "./components/Tabs"; //引入底部的页签导航
import Home from "./routes/Home"; //首页
import Mine from "./routes/Mine"; //我的课程
import Profile from "./routes/Profile"; //个人中心
import Register from "./routes/Register";
import Login from "./routes/Login";
<span class="hljs-addition">+import Detail from "./routes/Detail";</span>
import { ConnectedRouter } from "connected-react-router"; //redux绑定路由
import history from "./store/history";
ReactDOM.render(
  &lt;Provider store={store}&gt;
    &lt;ConnectedRouter history={history}&gt;
      &lt;ConfigProvider locale={zh_CN}&gt;
        &lt;main className="main-container"&gt;
          &lt;Switch&gt;
            &lt;Route path="/" exact component={Home} /&gt;
            &lt;Route path="/mine" component={Mine} /&gt;
            &lt;Route path="/profile" component={Profile} /&gt;
            &lt;Route path="/register" component={Register} /&gt;
            &lt;Route path="/login" component={Login} /&gt;
<span class="hljs-addition">+           &lt;Route path="/detail/:id" component={Detail} /&gt;</span>
            &lt;Redirect to="/" /&gt;
          &lt;/Switch&gt;
        &lt;/main&gt;
        &lt;Tabs /&gt;
      &lt;/ConfigProvider&gt;
    &lt;/ConnectedRouter&gt;
  &lt;/Provider&gt;,
  document.getElementById("root")
);
</code></pre>
<h3 id="t14113.3 src\api\home.tsx">13.3 src\api\home.tsx <a href="#t14113.3 src\api\home.tsx"> # </a></h3>
<p>src\api\home.tsx</p>
<pre><code class="lang-diff">import axios from "./index";
export function getSliders() {
  return axios.get("/slider/list");
}
export function getLessons(
  currentCategory: string = "all",
  offset: number,
  limit: number
) {
  return axios.get(
    `/lesson/list?category=${currentCategory}&amp;offset=${offset}&amp;limit=${limit}`
  );
}
<span class="hljs-addition">+export function getLesson&lt;T&gt;(id: string) {</span>
<span class="hljs-addition">+  return axios.get&lt;T, T&gt;(`/lesson/${id}`);</span>
<span class="hljs-addition">+}</span>

</code></pre>
<h3 id="t14213.4 routes\Detail\index.tsx">13.4 routes\Detail\index.tsx <a href="#t14213.4 routes\Detail\index.tsx"> # </a></h3>
<p>src\routes\Detail\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { Card, Button } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> NavHeader <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/NavHeader"</span>;
<span class="hljs-keyword">import</span> { getLesson } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/api/home"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router"</span>;
<span class="hljs-keyword">import</span> Lesson <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/lesson"</span>;
<span class="hljs-keyword">import</span> { StaticContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router"</span>;
<span class="hljs-keyword">import</span> { LessonResult } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/lesson"</span>;
<span class="hljs-keyword">const</span> { Meta } = Card;
interface Params {
  <span class="hljs-attr">id</span>: string;
}
type RouteProps = RouteComponentProps&lt;Params, StaticContext, Lesson&gt;;
type Props = RouteProps &amp; {
  children?: any;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Detail</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">let</span> [lesson, setLesson] = useState&lt;Lesson&gt;({} <span class="hljs-keyword">as</span> Lesson);
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    (<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">let</span> lesson: Lesson = props.location.state;
      <span class="hljs-keyword">if</span> (!lesson) {
        <span class="hljs-keyword">let</span> id = props.match.params.id;
        <span class="hljs-keyword">let</span> result: LessonResult = <span class="hljs-keyword">await</span> getLesson&lt;LessonResult&gt;(id);
        <span class="hljs-keyword">if</span> (result.success) lesson = result.data;
      }
      setLesson(lesson);
    })();
  }, []);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavHeader</span> <span class="hljs-attr">history</span>=<span class="hljs-string">{props.history}</span>&gt;</span>课程详情<span class="hljs-tag">&lt;/<span class="hljs-name">NavHeader</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>
        <span class="hljs-attr">hoverable</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%" }}
        <span class="hljs-attr">cover</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{lesson.video}</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">autoPlay</span>=<span class="hljs-string">{false}</span> /&gt;</span>}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Meta</span> <span class="hljs-attr">title</span>=<span class="hljs-string">{lesson.title}</span> <span class="hljs-attr">description</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">p</span>&gt;</span>价格: {lesson.price}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect()(Detail);
</code></pre>
<h2 id="t143第14章 下拉刷新">第14章 下拉刷新 <a href="#t143第14章 下拉刷新"> # </a></h2>
<h3 id="t14414.1 参考">14.1 参考 <a href="#t14414.1 参考"> # </a></h3>
<h4 id="t14514.1.1 目录结构">14.1.1 目录结构 <a href="#t14514.1.1 目录结构"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── README.md
├── src
│   ├── api
│   │   ├── home.tsx
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Detail
│   │   │   └── index.tsx
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   ├── HomeHeader
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   ├── HomeSliders
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   └── LessonList
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   ├── typings
│   │   ├── images.d.ts
│   │   ├── lesson.tsx
│   │   ├── login-types.tsx
│   │   ├── slider.tsx
│   │   └── user.tsx
│   └── utils.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h3 id="t14614.2 src\utils.tsx">14.2 src\utils.tsx <a href="#t14614.2 src\utils.tsx"> # </a></h3>
<p>src\utils.tsx</p>
<pre><code class="lang-diff">//element 要实现此功能DOM对象 callback加载更多的方法
export function loadMore(element: HTMLElement, callback: Function) {
    function _loadMore() {
      let clientHeight = element.clientHeight;
      let scrollTop = element.scrollTop;
      let scrollHeight = element.scrollHeight;
      if (clientHeight + scrollTop + 10 &gt;= scrollHeight) {
        callback();
      }
    }
    element.addEventListener("scroll", debounce(_loadMore, 300));
}
export function debounce(fn: any, wait: number) {
  var timeout: any = null;
  return function () {
    if (timeout !== null) clearTimeout(timeout);
    timeout = setTimeout(fn, wait);
  };
}

<span class="hljs-addition">+export function downRefresh(element: HTMLDivElement, callback: Function) {</span>
<span class="hljs-addition">+  let startY: number; //变量，存储接下时候的纵坐标</span>
<span class="hljs-addition">+  let distance: number; //本次下拉的距离</span>
<span class="hljs-addition">+  let originalTop = element.offsetTop; //最初此元素距离顶部的距离 top=50</span>
<span class="hljs-addition">+  let startTop: number;</span>
<span class="hljs-addition">+  let $timer: any = null;</span>
<span class="hljs-addition">+  element.addEventListener("touchstart", function (event: TouchEvent) {</span>
<span class="hljs-addition">+    if ($timer) clearInterval($timer);</span>
<span class="hljs-addition">+    let touchMove = throttle(_touchMove, 30);</span>
<span class="hljs-addition">+    //只有当此元素处于原始位置才能下拉，如果处于回弹的过程则不能拉了.并且此元素向上卷去的高度==0</span>
<span class="hljs-addition">+    if (element.scrollTop === 0) {</span>
<span class="hljs-addition">+      startTop = element.offsetTop;</span>
<span class="hljs-addition">+      startY = event.touches[0].pageY; //记录当前点击的纵坐标</span>
<span class="hljs-addition">+      element.addEventListener("touchmove", touchMove);</span>
<span class="hljs-addition">+      element.addEventListener("touchend", touchEnd);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    function _touchMove(event: TouchEvent) {</span>
<span class="hljs-addition">+      let pageY = event.touches[0].pageY; //拿到最新的纵坐标</span>
<span class="hljs-addition">+      if (pageY &gt; startY) {</span>
<span class="hljs-addition">+        distance = pageY - startY;</span>
<span class="hljs-addition">+        element.style.top = startTop + distance + "px";</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        element.removeEventListener("touchmove", touchMove);</span>
<span class="hljs-addition">+        element.removeEventListener("touchend", touchEnd);</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    function touchEnd(_event: TouchEvent) {</span>
<span class="hljs-addition">+      element.removeEventListener("touchmove", touchMove);</span>
<span class="hljs-addition">+      element.removeEventListener("touchend", touchEnd);</span>
<span class="hljs-addition">+      if (distance &gt; 30) {</span>
<span class="hljs-addition">+        callback();</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      function _back(){;</span>
<span class="hljs-addition">+        let currentTop = element.offsetTop;</span>
<span class="hljs-addition">+        if (currentTop - originalTop &gt;= 1) {</span>
<span class="hljs-addition">+          element.style.top = currentTop - 1 + "px";</span>
<span class="hljs-addition">+          requestAnimationFrame(_back);</span>
<span class="hljs-addition">+        } else {</span>
<span class="hljs-addition">+          element.style.top = originalTop + "px";</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      requestAnimationFrame(_back);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+export function throttle(func: any, delay: number) {</span>
<span class="hljs-addition">+  var prev = Date.now();</span>
<span class="hljs-addition">+  return function () {</span>
<span class="hljs-addition">+    var context = this;</span>
<span class="hljs-addition">+    var args = arguments;</span>
<span class="hljs-addition">+    var now = Date.now();</span>
<span class="hljs-addition">+    if (now - prev &gt;= delay) {</span>
<span class="hljs-addition">+      func.apply(context, args);</span>
<span class="hljs-addition">+      prev = Date.now();</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  };</span>
<span class="hljs-addition">+}</span>
</code></pre>
<h3 id="t14714.3 action-types.tsx">14.3 action-types.tsx <a href="#t14714.3 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = "ADD";
export const SET_CURRENT_CATEGORY = 'SET_CURRENT_CATEGORY';
export const VALIDATE = 'VALIDATE';
export const LOGOUT = 'LOGOUT';
export const CHANGE_AVATAR = "CHANGE_AVATAR";
export const GET_SLIDERS = "GET_SLIDERS";
export const GET_LESSONS = "GET_LESSONS";
export const SET_LESSONS_LOADING = "SET_LESSONS_LOADING";
export const SET_LESSONS = "SET_LESSONS";
<span class="hljs-addition">+export const REFRESH_LESSONS = "REFRESH_LESSONS";</span>
</code></pre>
<h3 id="t14814.4 reducers\home.tsx">14.4 reducers\home.tsx <a href="#t14814.4 reducers\home.tsx"> # </a></h3>
<p>src\store\reducers\home.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from "redux";
import * as TYPES from "../action-types";
import Slider from "@/typings/slider";
import Lesson from "@/typings/Lesson";
export interface Lessons {
  loading: boolean;
  list: Lesson[];
  hasMore: boolean;
  offset: number;
  limit: number;
}
export interface HomeState {
  currentCategory: string;
  sliders: Slider[];
  lessons: Lessons;
}
let initialState: HomeState = {
  currentCategory: 'all',
  sliders: [],
  lessons: {
    loading: false,
    list: [],
    hasMore: true,
    offset: 0,
    limit: 5,
  },
};
export default function (state: HomeState = initialState, action: AnyAction): HomeState {
  switch (action.type) {
    case TYPES.SET_CURRENT_CATEGORY:
      return { ...state, currentCategory: action.payload };
    case TYPES.GET_SLIDERS:
      return { ...state, sliders: action.payload.data };
    case TYPES.SET_LESSONS_LOADING:
      return {
        ...state,
        lessons: { ...state.lessons, loading: action.payload },
      };
    case TYPES.SET_LESSONS:
      return {
        ...state,
        lessons: {
          ...state.lessons,
          loading: false,
          hasMore: action.payload.hasMore,
          list: [...state.lessons.list, ...action.payload.list],
          offset: state.lessons.offset + action.payload.list.length,
        },
      };
<span class="hljs-addition">+   case TYPES.REFRESH_LESSONS:</span>
<span class="hljs-addition">+       return {</span>
<span class="hljs-addition">+         ...state,</span>
<span class="hljs-addition">+         lessons: {</span>
<span class="hljs-addition">+           ...state.lessons,</span>
<span class="hljs-addition">+           loading: false,</span>
<span class="hljs-addition">+           hasMore: action.payload.hasMore,</span>
<span class="hljs-addition">+           list: action.payload.list,</span>
<span class="hljs-addition">+           offset: action.payload.list.length,</span>
<span class="hljs-addition">+         },</span>
<span class="hljs-addition">+       };</span>
    default:
      return state;
  }
}
</code></pre>
<h3 id="t14914.5 Home\index.tsx">14.5 Home\index.tsx <a href="#t14914.5 Home\index.tsx"> # </a></h3>
<p>src\routes\Home\index.tsx</p>
<pre><code class="lang-diff">import React, { PropsWithChildren, useRef, useEffect } from "react";
import { connect } from 'react-redux';
import { RouteComponentProps } from 'react-router-dom';
import actions from '@/store/actions/home';
import HomeHeader from './components/HomeHeader';
import { CombinedState } from '@/store/reducers';
import { HomeState } from '@/store/reducers/home';
import './index.less';
import HomeSliders from "./components/HomeSliders";
import LessonList from "./components/LessonList";
<span class="hljs-addition">+import { loadMore,downRefresh} from "@/utils";</span>
<span class="hljs-addition">+import {Spin} from 'antd';</span>
type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;
type DispatchProps = typeof actions;
interface Params { }
type Props = PropsWithChildren&lt;RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps&gt;;
function Home(props: Props) {
    const homeContainerRef = useRef(null);
    useEffect(() =&gt; {
        loadMore(homeContainerRef.current, props.getLessons);
<span class="hljs-addition">+       downRefresh(homeContainerRef.current, props.refreshLessons);</span>
    }, []);
    return (
        &lt;&gt;
<span class="hljs-addition">+           &lt;Spin size="large"/&gt;</span>
            &lt;HomeHeader
                currentCategory={props.currentCategory}
                setCurrentCategory={props.setCurrentCategory}
                refreshLessons={props.refreshLessons}
            /&gt;
            &lt;div className="home-container" ref={homeContainerRef}&gt;
             &lt;HomeSliders sliders={props.sliders} getSliders={props.getSliders} /&gt;
             &lt;LessonList
                  lessons={props.lessons}
                  getLessons={props.getLessons}
             /&gt;
            &lt;/div&gt;
        &lt;/&gt;
    )
}
let mapStateToProps = (state: CombinedState): HomeState =&gt; state.home;
export default connect(
    mapStateToProps,
    actions
)(Home);
</code></pre>
<h3 id="t15014.6 Home\index.less">14.6 Home\index.less <a href="#t15014.6 Home\index.less"> # </a></h3>
<p>src\routes\Home\index.less</p>
<pre><code class="lang-diff"><span class="hljs-addition">+.ant-spin-spinning{</span>
<span class="hljs-addition">+  margin-top:20px;</span>
<span class="hljs-addition">+  margin-left:359px;</span>
<span class="hljs-addition">+}</span>
.home-container {
  position: fixed;
  top: 100px;
  left: 0;
  width: 100%;
  overflow-y: auto;
  height: calc(100vh - 222px);
}
</code></pre>
<h3 id="t15114.7 HomeHeader\index.tsx">14.7 HomeHeader\index.tsx <a href="#t15114.7 HomeHeader\index.tsx"> # </a></h3>
<p>src\routes\Home\components\HomeHeader\index.tsx</p>
<pre><code class="lang-diff">interface Props {
    currentCategory: string;//当前选中的分类 此数据会放在redux仓库中
    setCurrentCategory: (currentCategory: string) =&gt; any;// 改变仓库中的分类
<span class="hljs-addition">+   refreshLessons: Function;</span>
}
function HomeHeader(props: Props) {
    let [isMenuVisible, setIsMenuVisible] = useState(false);//设定标识位表示菜单是否显示
    //设置当前分类,把当前选中的分类传递给redux仓库
    const setCurrentCategory = (event: React.MouseEvent&lt;HTMLUListElement&gt;) =&gt; {
        let target: HTMLUListElement = event.target as HTMLUListElement;
        let category = target.dataset.category;//获取用户选择的分类名称
        props.setCurrentCategory(category);//设置分类名称
<span class="hljs-addition">+       props.refreshLessons();</span>
        setIsMenuVisible(false);//关闭分类选择层
    }
}
export default HomeHeader;
</code></pre>
<h2 id="t152第15章 虚拟列表">第15章 虚拟列表 <a href="#t152第15章 虚拟列表"> # </a></h2>
<h3 id="t15315.1 参考">15.1 参考 <a href="#t15315.1 参考"> # </a></h3>
<h4 id="t15415.1.1 目录结构">15.1.1 目录结构 <a href="#t15415.1.1 目录结构"> # </a></h4>
<pre><code class="lang-js">.
├── package.json
├── public
│   └── index.html
├── README.md
├── src
│   ├── api
│   │   ├── home.tsx
│   │   ├── index.tsx
│   │   └── profile.tsx
│   ├── assets
│   │   ├── css
│   │   │   └── common.less
│   │   └── images
│   │       └── logo.png
│   ├── components
│   │   ├── NavHeader
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Tabs
│   │       ├── index.less
│   │       └── index.tsx
│   ├── index.tsx
│   ├── routes
│   │   ├── Detail
│   │   │   └── index.tsx
│   │   ├── Home
│   │   │   ├── components
│   │   │   │   ├── HomeHeader
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   ├── HomeSliders
│   │   │   │   │   ├── index.less
│   │   │   │   │   └── index.tsx
│   │   │   │   └── LessonList
│   │   │   │       ├── index.less
│   │   │   │       └── index.tsx
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Login
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   ├── Mine
│   │   │   └── index.tsx
│   │   ├── Profile
│   │   │   ├── index.less
│   │   │   └── index.tsx
│   │   └── Register
│   │       ├── index.less
│   │       └── index.tsx
│   ├── store
│   │   ├── actions
│   │   │   ├── home.tsx
│   │   │   └── profile.tsx
│   │   ├── action-types.tsx
│   │   ├── history.tsx
│   │   ├── index.tsx
│   │   └── reducers
│   │       ├── home.tsx
│   │       ├── index.tsx
│   │       ├── mine.tsx
│   │       └── profile.tsx
│   ├── typings
│   │   ├── images.d.ts
│   │   ├── lesson.tsx
│   │   ├── login-types.tsx
│   │   ├── slider.tsx
│   │   └── user.tsx
│   └── utils.tsx
├── tsconfig.json
├── webpack.config.js
</code></pre>
<h4 id="t15515.1.2 Home\index.tsx">15.1.2 Home\index.tsx <a href="#t15515.1.2 Home\index.tsx"> # </a></h4>
<p>src\routes\Home\index.tsx</p>
<pre><code class="lang-diff">import React, { PropsWithChildren, useRef, useEffect } from "react";
import { connect } from 'react-redux';
import { RouteComponentProps } from 'react-router-dom';
import actions from '@/store/actions/home';
import HomeHeader from './components/HomeHeader';
import { CombinedState } from '@/store/reducers';
import { HomeState } from '@/store/reducers/home';
import './index.less';
import HomeSliders from "./components/HomeSliders";
import LessonList from "./components/LessonList";
<span class="hljs-addition">+import { loadMore,downRefresh,debounce, throttle} from "@/utils";</span>
import {Spin} from 'antd';
type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;
type DispatchProps = typeof actions;
interface Params { }
type Props = PropsWithChildren&lt;RouteComponentProps&lt;Params&gt; &amp; StateProps &amp; DispatchProps&gt;;
function Home(props: Props) {
    const homeContainerRef = useRef(null);
<span class="hljs-addition">+   const lessonListRef = useRef(null);</span>
    useEffect(() =&gt; {
        loadMore(homeContainerRef.current, props.getLessons);
        downRefresh(homeContainerRef.current, props.refreshLessons);
<span class="hljs-addition">+       lessonListRef.current();</span>
<span class="hljs-addition">+       homeContainerRef.current.addEventListener("scroll", throttle(lessonListRef.current,13));</span>
    }, []);
    return (
        &lt;&gt;
            &lt;Spin size="large"/&gt;
            &lt;HomeHeader
                currentCategory={props.currentCategory}
                setCurrentCategory={props.setCurrentCategory}
                refreshLessons={props.refreshLessons}
            /&gt;
            &lt;div className="home-container" ref={homeContainerRef}&gt;
             &lt;HomeSliders sliders={props.sliders} getSliders={props.getSliders} /&gt;
             &lt;LessonList
                  lessons={props.lessons}
                  getLessons={props.getLessons}
<span class="hljs-addition">+                 ref={lessonListRef}</span>
<span class="hljs-addition">+                 homeContainerRef={homeContainerRef}</span>
             /&gt;
            &lt;/div&gt;
        &lt;/&gt;
    )
}
let mapStateToProps = (state: CombinedState): HomeState =&gt; state.home;
export default connect(
    mapStateToProps,
    actions
)(Home);
</code></pre>
<h4 id="t15615.1.3 LessonList\index.tsx">15.1.3 LessonList\index.tsx <a href="#t15615.1.3 LessonList\index.tsx"> # </a></h4>
<p>src\routes\Home\components\LessonList\index.tsx</p>
<pre><code class="lang-diff">import React, { useEffect, forwardRef, useState } from "react";
import "./index.less";
import { Card, Skeleton, Button, Alert, Menu } from "antd";
import { Link } from "react-router-dom";
import Lesson from "@/typings/lesson";
import { MenuOutlined } from "@ant-design/icons";
interface Props {
  children?: any;
  lessons?: any;
  getLessons?: any;
<span class="hljs-addition">+ homeContainerRef: any</span>
}
<span class="hljs-addition">+interface VisibleLesson extends Lesson {</span>
<span class="hljs-addition">+  index: number</span>
<span class="hljs-addition">+}</span>
function LessonList(props: Props, lessonListRef: any) {
<span class="hljs-addition">+  const [, forceUpdate] = React.useReducer(x =&gt; x + 1, 0);</span>
  useEffect(() =&gt; {
    if (props.lessons.list.length == 0) {
      props.getLessons();
    }
<span class="hljs-addition">+   lessonListRef.current = forceUpdate;</span>
  }, []);
<span class="hljs-addition">+  const remSize: number = parseFloat(document.documentElement.style.fontSize);</span>
<span class="hljs-addition">+  const itemSize: number = (650 / 75) * remSize;</span>
<span class="hljs-addition">+  const screenHeight = window.innerHeight - (222 / 75) * remSize;</span>
<span class="hljs-addition">+  const homeContainer = props.homeContainerRef.current;</span>
<span class="hljs-addition">+  let start = 0, end = 0;</span>
<span class="hljs-addition">+  if (homeContainer) {</span>
<span class="hljs-addition">+    const scrollTop = homeContainer.scrollTop;</span>
<span class="hljs-addition">+    start = Math.floor(scrollTop / itemSize);</span>
<span class="hljs-addition">+    end = start + Math.floor(screenHeight / itemSize);</span>
<span class="hljs-addition">+    start-=2,end+=2;</span>
<span class="hljs-addition">+    start = start &lt; 0 ? 0 : start;</span>
<span class="hljs-addition">+    end = end &gt; props.lessons.list.length ? props.lessons.list.length : end;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  const visibleList: Array&lt;VisibleLesson&gt; = props.lessons.list.map((item: Lesson, index: number) =&gt; ({ ...item, index })).slice(start, end);</span>
<span class="hljs-addition">+  const style: React.CSSProperties = { position: 'absolute', top: 0, left: 0, width: '100%', height: itemSize };</span>
<span class="hljs-addition">+  const bottomTop = (props.lessons.list.length)*itemSize;</span>
<span class="hljs-addition">+  return (</span>
<span class="hljs-addition">+    &lt;section className="lesson-list"&gt;</span>
      &lt;Skeleton
        loading={props.lessons.list.length == 0 &amp;&amp; props.lessons.loading}
        active
        paragraph={{ rows: 8 }}
      &gt;
<span class="hljs-addition">+      &lt;h2&gt;</span>
<span class="hljs-addition">+        &lt;MenuOutlined /&gt; 全部课程</span>
<span class="hljs-addition">+      &lt;/h2&gt;</span>
<span class="hljs-addition">+      &lt;div style={{position:'relative', width: '100%', height: `${props.lessons.list.length * itemSize}px`}}&gt;</span>
<span class="hljs-addition">+       {</span>
<span class="hljs-addition">+         visibleList.map((lesson: VisibleLesson) =&gt; (</span>
<span class="hljs-addition">+           &lt;Link</span>
<span class="hljs-addition">+             key={lesson.id}</span>
<span class="hljs-addition">+             style={{ ...style, top: `${itemSize * lesson.index}px` }}</span>
<span class="hljs-addition">+             to={{ pathname: `/detail/${lesson.id}`, state: lesson }}</span>
<span class="hljs-addition">+           &gt;</span>
<span class="hljs-addition">+             &lt;Card</span>
<span class="hljs-addition">+               hoverable={true}</span>
<span class="hljs-addition">+               cover={&lt;img alt={lesson.title} src={lesson.poster} /&gt;}</span>
<span class="hljs-addition">+             &gt;</span>
<span class="hljs-addition">+               &lt;Card.Meta</span>
<span class="hljs-addition">+                 title={lesson.title}</span>
<span class="hljs-addition">+                 description={`价格: ¥${lesson.price}元`}</span>
<span class="hljs-addition">+               /&gt;</span>
<span class="hljs-addition">+             &lt;/Card&gt;</span>
<span class="hljs-addition">+           &lt;/Link&gt;</span>
<span class="hljs-addition">+         ))</span>
<span class="hljs-addition">+       }</span>
       {props.lessons.hasMore ? (
         &lt;Button
<span class="hljs-addition">+          style={{ textAlign: "center" ,top: `${bottomTop}px`}}</span>
            onClick={props.getLessons}
            loading={props.lessons.loading}
            type="primary"
            block
          &gt;
            {props.lessons.loading ? "" : "加载更多"}
          &lt;/Button&gt;
        ) : (
            &lt;Alert
<span class="hljs-addition">+             style={{ textAlign: "center",top: `${bottomTop}px` }}</span>
              message="到底了"
              type="warning"
            /&gt;
          )}
      &lt;/div&gt;
      &lt;/Skeleton&gt;
    &lt;/section&gt;
  );
}
<span class="hljs-addition">+export default React.forwardRef(LessonList);</span>
</code></pre>
<h2 id="t157第16章 路由懒加载">第16章 路由懒加载 <a href="#t157第16章 路由懒加载"> # </a></h2>
<h3 id="t15816.1 src\index.tsx">16.1 src\index.tsx <a href="#t15816.1 src\index.tsx"> # </a></h3>
<pre><code class="lang-diff">import React from "react";
import ReactDOM from "react-dom";
import { Switch, Route, Redirect } from "react-router-dom";
import { Provider } from "react-redux";
import store from "./store";
import { ConfigProvider } from "antd";
import zh_CN from "antd/lib/locale-provider/zh_CN";
import "./assets/css/common.less";
import Tabs from "./components/Tabs";
import {Spin} from 'antd';
<span class="hljs-addition">+const Home = React.lazy(() =&gt; import("./routes/Home"));</span>
<span class="hljs-addition">+const Mine = React.lazy(() =&gt; import("./routes/Mine"));</span>
<span class="hljs-addition">+const Profile = React.lazy(() =&gt; import("./routes/Profile"));</span>
<span class="hljs-addition">+const Register = React.lazy(() =&gt; import("./routes/Register"));</span>
<span class="hljs-addition">+const Login = React.lazy(() =&gt; import("./routes/Login"));</span>
<span class="hljs-addition">+const Detail = React.lazy(() =&gt; import("./routes/Detail"));</span>
import { ConnectedRouter } from "connected-react-router";
import history from "./store/history";
ReactDOM.render(
  &lt;Provider store={store}&gt;
    &lt;ConnectedRouter history={history}&gt;
      &lt;ConfigProvider locale={zh_CN}&gt;
<span class="hljs-addition">+      &lt;React.Suspense fallback={&lt;Spin /&gt;}&gt;</span>
        &lt;main className="main-container"&gt;
          &lt;Switch&gt;
            &lt;Route path="/" exact component={Home} /&gt;
            &lt;Route path="/Mine" component={Mine} /&gt;
            &lt;Route path="/profile" component={Profile} /&gt;
            &lt;Route path="/register" component={Register} /&gt;
            &lt;Route path="/login" component={Login} /&gt;
            &lt;Route path="/detail/:id" component={Detail} /&gt;
            &lt;Redirect to="/" /&gt;
          &lt;/Switch&gt;
        &lt;/main&gt;
        &lt;Tabs /&gt;
<span class="hljs-addition">+       &lt;/React.Suspense&gt;</span>
      &lt;/ConfigProvider&gt;
    &lt;/ConnectedRouter&gt;
  &lt;/Provider&gt;,
  document.getElementById("root")
);
</code></pre>
<h2 id="t159第17章 购物车">第17章 购物车 <a href="#t159第17章 购物车"> # </a></h2>
<ul>
<li>redux-immer</li>
<li>redux-persist</li>
</ul>
<h3 id="t16017.1   src\index.tsx">17.1   src\index.tsx <a href="#t16017.1   src\index.tsx"> # </a></h3>
<p>src\index.tsx</p>
<pre><code class="lang-diff">import React from "react";
import ReactDOM from "react-dom";
import { Switch, Route, Redirect } from "react-router-dom";
import { Provider } from "react-redux";
<span class="hljs-addition">+import {store,persistor} from "./store";</span>
import "./assets/css/common.less";
import Tabs from "./components/Tabs";
import {Spin} from 'antd';
const Home = React.lazy(() =&gt; import("./routes/Home"));
const Profile = React.lazy(() =&gt; import("./routes/Profile"));
const Register = React.lazy(() =&gt; import("./routes/Register"));
const Login = React.lazy(() =&gt; import("./routes/Login"));
const Detail = React.lazy(() =&gt; import("./routes/Detail"));
<span class="hljs-addition">+const Cart = React.lazy(() =&gt; import("./routes/Cart"));</span>
<span class="hljs-addition">+import { PersistGate } from 'redux-persist/integration/react'</span>
import { ConnectedRouter } from "connected-react-router";

import history from "./store/history";
ReactDOM.render(
  &lt;Provider store={store}&gt;
<span class="hljs-addition">+   &lt;PersistGate loading={&lt;Spin /&gt;} persistor={persistor}&gt;</span>
    &lt;ConnectedRouter history={history}&gt;
       &lt;React.Suspense fallback={&lt;Spin /&gt;}&gt;
        &lt;main className="main-container"&gt;
          &lt;Switch&gt;
            &lt;Route path="/" exact component={Home} /&gt;
<span class="hljs-addition">+           &lt;Route path="/cart" component={Cart} /&gt;</span>
            &lt;Route path="/profile" component={Profile} /&gt;
            &lt;Route path="/register" component={Register} /&gt;
            &lt;Route path="/login" component={Login} /&gt;
            &lt;Route path="/detail/:id" component={Detail} /&gt;
            &lt;Redirect to="/" /&gt;
          &lt;/Switch&gt;
        &lt;/main&gt;
        &lt;Tabs /&gt;
        &lt;/React.Suspense&gt;
    &lt;/ConnectedRouter&gt;
<span class="hljs-addition">+   &lt;/PersistGate&gt;</span>
  &lt;/Provider&gt;,
  document.getElementById("root")
);
</code></pre>
<h3 id="t16117.2 Detail\index.tsx">17.2 Detail\index.tsx <a href="#t16117.2 Detail\index.tsx"> # </a></h3>
<p>src\routes\Detail\index.tsx</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import React, { useState, useEffect,PropsWithChildren } from "react";</span>
import { connect } from "react-redux";
import { Card, Button } from "antd";
import NavHeader from "@/components/NavHeader";
import { getLesson } from "@/api/home";
import { RouteComponentProps } from "react-router";
import Lesson from "@/typings/lesson";
import { StaticContext } from "react-router";
import { LessonResult } from "@/typings/lesson";
<span class="hljs-addition">+import { CombinedState } from '@/store/reducers';</span>
<span class="hljs-addition">+import actions from '@/store/actions/cart';</span>
const { Meta } = Card;
interface Params {
  id: string;
}
<span class="hljs-addition">+type RouteProps = RouteComponentProps&lt;Params, StaticContext, Lesson&gt;;</span>
<span class="hljs-addition">+type StateProps = ReturnType&lt;typeof mapStateToProps&gt;;</span>
<span class="hljs-addition">+type DispatchProps = typeof actions;</span>
<span class="hljs-addition">+type Props = PropsWithChildren&lt;RouteProps &amp; StateProps &amp; DispatchProps&gt;;</span>

function Detail(props: Props) {
  let [lesson, setLesson] = useState&lt;Lesson&gt;({} as Lesson);
  useEffect(() =&gt; {
    (async () =&gt; {
      let lesson: Lesson = props.location.state;
      if (!lesson) {
        let id = props.match.params.id;
        let result: LessonResult = await getLesson&lt;LessonResult&gt;(id);
        if (result.success) lesson = result.data;
      }
      setLesson(lesson);
    })();
  }, []);
<span class="hljs-addition">+ const addCartItem = (lesson: Lesson) =&gt; {</span>
<span class="hljs-addition">+  //https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect</span>
<span class="hljs-addition">+  let video: HTMLVideoElement = document.querySelector('#lesson-video');</span>
<span class="hljs-addition">+  let cart: HTMLSpanElement = document.querySelector('.anticon.anticon-shopping-cart');</span>
<span class="hljs-addition">+  let clonedVideo: HTMLVideoElement = video.cloneNode(true) as HTMLVideoElement;</span>
<span class="hljs-addition">+  let videoWith = video.offsetWidth;</span>
<span class="hljs-addition">+  let videoHeight = video.offsetHeight;</span>
<span class="hljs-addition">+  let cartWith = cart.offsetWidth;</span>
<span class="hljs-addition">+  let cartHeight = cart.offsetHeight;</span>
<span class="hljs-addition">+  let videoLeft = video.getBoundingClientRect().left;</span>
<span class="hljs-addition">+  let videoTop = video.getBoundingClientRect().top;</span>
<span class="hljs-addition">+  let cartRight = cart.getBoundingClientRect().right;</span>
<span class="hljs-addition">+  let cartBottom = cart.getBoundingClientRect().bottom;</span>
<span class="hljs-addition">+  clonedVideo.style.cssText = `</span>
<span class="hljs-addition">+    z-index: 1000;</span>
<span class="hljs-addition">+    opacity:0.8;</span>
<span class="hljs-addition">+    position:fixed;</span>
<span class="hljs-addition">+    width:${videoWith}px;</span>
<span class="hljs-addition">+    height:${videoHeight}px;</span>
<span class="hljs-addition">+    top:${videoTop}px;</span>
<span class="hljs-addition">+    left:${videoLeft}px;</span>
<span class="hljs-addition">+    transition: all 2s ease-in-out;</span>
<span class="hljs-addition">+  `;</span>
<span class="hljs-addition">+  document.body.appendChild(clonedVideo);</span>
<span class="hljs-addition">+  setTimeout(function () {</span>
<span class="hljs-addition">+      clonedVideo.style.left = (cartRight - (cartWith / 2)) + 'px';</span>
<span class="hljs-addition">+      clonedVideo.style.top = (cartBottom - (cartHeight / 2)) + 'px';</span>
<span class="hljs-addition">+      clonedVideo.style.width = `0px`;</span>
<span class="hljs-addition">+      clonedVideo.style.height = `0px`;</span>
<span class="hljs-addition">+      clonedVideo.style.opacity = '50';</span>
<span class="hljs-addition">+  }, 0);</span>
<span class="hljs-addition">+  props.addCartItem(lesson);</span>
<span class="hljs-addition">+ }</span>
  return (
    &lt;&gt;
      &lt;NavHeader history={props.history}&gt;课程详情&lt;/NavHeader&gt;
      &lt;Card
        hoverable
        style={{ width: "100%" }}
<span class="hljs-addition">+       cover={&lt;video src={lesson.video} id="lesson-video" controls autoPlay={false} /&gt;}</span>
      &gt;
        &lt;Meta title={lesson.title} description={
<span class="hljs-addition">+         &lt;&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;价格: {lesson.price}&lt;/p&gt;</span>
<span class="hljs-addition">+           &lt;p&gt;</span>
<span class="hljs-addition">+             &lt;Button </span>
<span class="hljs-addition">+               className="add-cart"</span>
<span class="hljs-addition">+               onClick={() =&gt; addCartItem(lesson)}</span>
<span class="hljs-addition">+             &gt;加入购物车&lt;/Button&gt;&lt;/p&gt;</span>
<span class="hljs-addition">+         &lt;/&gt;</span>
<span class="hljs-addition">+       } /&gt;</span>
<span class="hljs-addition">+     &lt;/Card&gt;</span>
<span class="hljs-addition">+   &lt;/&gt;</span>
  );
}
<span class="hljs-addition">+let mapStateToProps = (state: CombinedState): CombinedState =&gt; state;</span>
export default connect(
<span class="hljs-addition">+  mapStateToProps,</span>
<span class="hljs-addition">+  actions</span>
)(Detail);
</code></pre>
<h3 id="t16217.3 action-types.tsx">17.3 action-types.tsx <a href="#t16217.3 action-types.tsx"> # </a></h3>
<p>src\store\action-types.tsx</p>
<pre><code class="lang-diff">export const ADD = "ADD";

export const SET_CURRENT_CATEGORY = 'SET_CURRENT_CATEGORY';

export const VALIDATE = 'VALIDATE';

export const LOGOUT = 'LOGOUT';

export const CHANGE_AVATAR = "CHANGE_AVATAR";

export const GET_SLIDERS = "GET_SLIDERS";


export const GET_LESSONS = "GET_LESSONS";
export const SET_LESSONS_LOADING = "SET_LESSONS_LOADING";
export const SET_LESSONS = "SET_LESSONS";
export const REFRESH_LESSONS = "REFRESH_LESSONS";


<span class="hljs-addition">+export const ADD_CART_ITEM = 'ADD_CART_ITEM';//向购物车中增一个商品</span>
<span class="hljs-addition">+export const REMOVE_CART_ITEM = 'REMOVE_CART_ITEM';//从购物车中删除一个商品</span>
<span class="hljs-addition">+export const CLEAR_CART_ITEMS = 'CLEAR_CART_ITEMS';//清空购物车</span>
<span class="hljs-addition">+export const CHANGE_CART_ITEM_COUNT = 'CHANGE_CART_ITEM_COUNT';//直接修改购物车商品的数量减1</span>
<span class="hljs-addition">+export const CHANGE_CHECKED_CART_ITEMS = 'CHANGE_CHECKED_CART_ITEMS';//选中商品</span>
<span class="hljs-addition">+export const SETTLE = 'SETTLE';//结算</span>
</code></pre>
<h3 id="t16317.4 typings\cart.tsx">17.4 typings\cart.tsx <a href="#t16317.4 typings\cart.tsx"> # </a></h3>
<p>src\typings\cart.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { Lesson } <span class="hljs-keyword">from</span> <span class="hljs-string">"./lesson"</span>;
<span class="hljs-keyword">export</span> interface CartItem {
  <span class="hljs-attr">lesson</span>: Lesson;
  count: number;
  checked: boolean;
}
<span class="hljs-keyword">export</span> type CartState = CartItem[];
</code></pre>
<h3 id="t16417.5 cart.tsx">17.5 cart.tsx <a href="#t16417.5 cart.tsx"> # </a></h3>
<p>src\store\reducers\cart.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { AnyAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"redux"</span>;
<span class="hljs-keyword">import</span> { CartState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/cart"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> actionTypes <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/action-types"</span>;
<span class="hljs-keyword">let</span> initialState: CartState = [];
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  state: CartState = initialState,
  action: AnyAction
</span>): <span class="hljs-title">CartState</span> </span>{
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> actionTypes.ADD_CART_ITEM:<span class="hljs-comment">//增加条目</span>
      <span class="hljs-keyword">let</span> oldIndex = state.findIndex(
        <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.lesson.id === action.payload.id
      );
      <span class="hljs-keyword">if</span> (oldIndex == <span class="hljs-number">-1</span>) {
        state.push({
          <span class="hljs-attr">checked</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">lesson</span>: action.payload,
        });
      } <span class="hljs-keyword">else</span> {
        state[oldIndex].count +=<span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> actionTypes.REMOVE_CART_ITEM:
      <span class="hljs-keyword">let</span> removeIndex = state.findIndex(
        <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.lesson.id === action.payload
      );
      state.splice(removeIndex,<span class="hljs-number">1</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> actionTypes.CLEAR_CART_ITEMS:
      state.length = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> actionTypes.CHANGE_CART_ITEM_COUNT:
      <span class="hljs-keyword">let</span> index = state.findIndex(
        <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.lesson.id === action.payload.id
      );
      state[index].count=action.payload.count;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> actionTypes.CHANGE_CHECKED_CART_ITEMS:
      <span class="hljs-keyword">let</span> checkedIds = action.payload;
      state.forEach(<span class="hljs-function">(<span class="hljs-params">item:any</span>)=&gt;</span>{
        <span class="hljs-keyword">if</span>(checkedIds.includes(item.lesson.id)){
          item.checked =<span class="hljs-literal">true</span>;
        }
      });
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> actionTypes.SETTLE:
      state = state.filter(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> !item.checked);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;
  }
    <span class="hljs-keyword">return</span> state;
}
</code></pre>
<h3 id="t16517.6 reducers\home.tsx">17.6 reducers\home.tsx <a href="#t16517.6 reducers\home.tsx"> # </a></h3>
<p>src\store\reducers\home.tsx</p>
<pre><code class="lang-diff">import { AnyAction } from "redux";
import * as TYPES from "../action-types";
import Slider from "@/typings/slider";
import Lesson from "@/typings/Lesson";
export interface Lessons {
  loading: boolean;
  list: Lesson[];
  hasMore: boolean;
  offset: number;
  limit: number;
}
export interface HomeState {
  currentCategory: string;
  sliders: Slider[];
  lessons: Lessons;
}
let initialState: HomeState = {
  currentCategory: 'all',
  sliders: [],
  lessons: {
    loading: false,
    list: [],
    hasMore: true,
    offset: 0,
    limit: 5,
  },
};
export default function (state: HomeState = initialState, action: AnyAction): HomeState {
<span class="hljs-addition">+ switch (action.type) {</span>
<span class="hljs-addition">+   case TYPES.SET_CURRENT_CATEGORY:</span>
<span class="hljs-addition">+     state.currentCategory=action.payload;</span>
<span class="hljs-addition">+     break;</span>
<span class="hljs-addition">+   case TYPES.GET_SLIDERS:</span>
<span class="hljs-addition">+     state.sliders = action.payload.data;</span>
<span class="hljs-addition">+     break;</span>
<span class="hljs-addition">+   case TYPES.SET_LESSONS_LOADING:</span>
<span class="hljs-addition">+     state.lessons.loading = action.payload;</span>
<span class="hljs-addition">+     break;</span>
<span class="hljs-addition">+   case TYPES.SET_LESSONS:</span>
<span class="hljs-addition">+     state.lessons.loading = false;</span>
<span class="hljs-addition">+     state.lessons.hasMore =  action.payload.hasMore;</span>
<span class="hljs-addition">+     state.lessons.list=[...state.lessons.list,...action.payload.list];</span>
<span class="hljs-addition">+     state.lessons.offset += action.payload.list.length;</span>
<span class="hljs-addition">+     break;</span>
<span class="hljs-addition">+   case TYPES.REFRESH_LESSONS:</span>
<span class="hljs-addition">+     state.lessons.loading = false;</span>
<span class="hljs-addition">+     state.lessons.hasMore =  action.payload.hasMore;</span>
<span class="hljs-addition">+     state.lessons.list=action.payload.list;</span>
<span class="hljs-addition">+     state.lessons.offset = action.payload.list.length;</span>
<span class="hljs-addition">+     break;</span>
<span class="hljs-addition">+   default:</span>
<span class="hljs-addition">+     break;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+   return state;</span>
}
</code></pre>
<h3 id="t16617.7 reducers\index.tsx">17.7 reducers\index.tsx <a href="#t16617.7 reducers\index.tsx"> # </a></h3>
<p>src\store\reducers\index.tsx</p>
<pre><code class="lang-diff">import { ReducersMapObject, Reducer } from 'redux';
import { connectRouter } from 'connected-react-router';
import history from '../history';
import home from './home';
import mine from './mine';
import profile from './profile';
<span class="hljs-addition">+import cart from './cart';</span>
<span class="hljs-addition">+import { combineReducers } from 'redux-immer';</span>
<span class="hljs-addition">+import produce from 'immer';</span>
let reducers: ReducersMapObject = {
    router: connectRouter(history),
    home,
    mine,
    profile,
<span class="hljs-addition">+   cart</span>
};
type CombinedState = {
    [key in keyof typeof reducers]: ReturnType&lt;typeof reducers[key]&gt;
}
<span class="hljs-addition">+let reducer: Reducer&lt;CombinedState&gt; = combineReducers(produce,reducers);</span>

export { CombinedState }
export default reducer;
</code></pre>
<h3 id="t16717.8 store\index.tsx">17.8 store\index.tsx <a href="#t16717.8 store\index.tsx"> # </a></h3>
<p>src\store\index.tsx</p>
<pre><code class="lang-diff">import { createStore, applyMiddleware} from 'redux';
import reducers from './reducers';
import logger from 'redux-logger';
import thunk from 'redux-thunk';
import promise from 'redux-promise';
import { routerMiddleware } from 'connected-react-router';
<span class="hljs-addition">+import { persistStore, persistReducer } from 'redux-persist';</span>
<span class="hljs-addition">+import storage from 'redux-persist/lib/storage';</span>
import history from './history';
<span class="hljs-addition">+const persistConfig = {</span>
<span class="hljs-addition">+  key: 'root',</span>
<span class="hljs-addition">+  storage,</span>
<span class="hljs-addition">+  whitelist: ['cart']</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+const persistedReducer = persistReducer(persistConfig, reducers)</span>

<span class="hljs-addition">+let store = applyMiddleware(thunk, routerMiddleware(history), promise, logger)(createStore)(persistedReducer);</span>
<span class="hljs-addition">+let persistor = persistStore(store);</span>
<span class="hljs-addition">+export  { store, persistor };</span>
</code></pre>
<h3 id="t16817.9 actions\cart.tsx">17.9 actions\cart.tsx <a href="#t16817.9 actions\cart.tsx"> # </a></h3>
<p>src\store\actions\cart.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> actionTypes <span class="hljs-keyword">from</span> <span class="hljs-string">"../action-types"</span>;
<span class="hljs-keyword">import</span> { Lesson } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/lesson"</span>;
<span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { push } <span class="hljs-keyword">from</span> <span class="hljs-string">"connected-react-router"</span>;
<span class="hljs-keyword">import</span> { StoreGetState, StoreDispatch } <span class="hljs-keyword">from</span> <span class="hljs-string">"../index"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  addCartItem(lesson: Lesson) {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dispatch: StoreDispatch</span>) </span>{
      dispatch({
        <span class="hljs-attr">type</span>: actionTypes.ADD_CART_ITEM,
        <span class="hljs-attr">payload</span>: lesson,
      });
      message.info(<span class="hljs-string">"添加课程成功"</span>);
    };
  },
  removeCartItem(id: string) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">type</span>: actionTypes.REMOVE_CART_ITEM,
      <span class="hljs-attr">payload</span>: id,
    };
  },
  clearCartItems() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">type</span>: actionTypes.CLEAR_CART_ITEMS,
    };
  },
  changeCartItemCount(id: string, <span class="hljs-attr">count</span>: number) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">type</span>: actionTypes.CHANGE_CART_ITEM_COUNT,
      <span class="hljs-attr">payload</span>: {
        id,
        count,
      },
    };
  },
  changeCheckedCartItems(checkedIds: string[]) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">type</span>: actionTypes.CHANGE_CHECKED_CART_ITEMS,
      <span class="hljs-attr">payload</span>: checkedIds,
    };
  },
  settle() {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dispatch: StoreDispatch, getState: StoreGetState</span>) </span>{
      dispatch({
        <span class="hljs-attr">type</span>: actionTypes.SETTLE,
      });
      dispatch(push(<span class="hljs-string">"/"</span>));
    };
  },
};
</code></pre>
<h3 id="t16917.10 Cart\index.tsx">17.10 Cart\index.tsx <a href="#t16917.10 Cart\index.tsx"> # </a></h3>
<p>src\routes\Cart\index.tsx</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { PropsWithChildren, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { RouteComponentProps } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> {
  Table,
  Button,
  InputNumber,
  Popconfirm,
  Icon,
  Row,
  Col,
  Badge,
  Modal,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { CombinedState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/reducers"</span>;
<span class="hljs-keyword">import</span> NavHeader <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/NavHeader"</span>;
<span class="hljs-keyword">import</span> { Lesson } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/lesson"</span>;
<span class="hljs-keyword">import</span> { StaticContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router"</span>;
<span class="hljs-keyword">import</span> actions <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/actions/cart"</span>;
<span class="hljs-keyword">import</span> { CartItem } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/typings/cart"</span>;
interface Params {
  <span class="hljs-attr">id</span>: string;
}
type RouteProps = RouteComponentProps&lt;Params, StaticContext, Lesson&gt;;
interface Params {
  <span class="hljs-attr">id</span>: string;
}
type StateProps = ReturnType&lt;<span class="hljs-keyword">typeof</span> mapStateToProps&gt;;
type DispatchProps = <span class="hljs-keyword">typeof</span> actions;
type Props = PropsWithChildren&lt;RouteProps &amp; StateProps &amp; DispatchProps&gt;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cart</span>(<span class="hljs-params">props: Props</span>) </span>{
  <span class="hljs-keyword">let</span> [settleVisible, setSettleVisible] = useState(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> confirmSettle = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    setSettleVisible(<span class="hljs-literal">true</span>);
  };
  <span class="hljs-keyword">const</span> handleOk = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    setSettleVisible(<span class="hljs-literal">false</span>);
    props.settle();
  };
  <span class="hljs-keyword">const</span> handleCancel = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    setSettleVisible(<span class="hljs-literal">false</span>);
  };
  <span class="hljs-keyword">const</span> columns = [
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"商品"</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">"lesson"</span>,
      <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">val: Lesson, row: CartItem</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{val.title}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>单价:{val.price}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
      ),
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"数量"</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">"count"</span>,
      <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">val: number, row: CartItem</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">InputNumber</span>
          <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>
          <span class="hljs-attr">min</span>=<span class="hljs-string">{1}</span>
          <span class="hljs-attr">max</span>=<span class="hljs-string">{10}</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{val}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(value:any)</span> =&gt;</span> props.changeCartItemCount(row.lesson.id, value)}
        /&gt;</span>
      ),
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"操作"</span>,
      <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">val: any, row: CartItem</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Popconfirm</span>
          <span class="hljs-attr">title</span>=<span class="hljs-string">"是否要删除商品?"</span>
          <span class="hljs-attr">onConfirm</span>=<span class="hljs-string">{()</span> =&gt;</span> props.removeCartItem(row.lesson.id)}
          okText="是"
          cancelText="否"
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span>&gt;</span>
            删除
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Popconfirm</span>&gt;</span></span>
      ),
    },
  ];
  <span class="hljs-keyword">const</span> rowSelection = {
    <span class="hljs-attr">selectedRowKeys</span>: props.cart
      .filter(<span class="hljs-function">(<span class="hljs-params">item: CartItem</span>) =&gt;</span> item.checked)
      .map(<span class="hljs-function">(<span class="hljs-params">item: CartItem</span>) =&gt;</span> item.lesson.id),
    <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">selectedRowKeys: string[]</span>) =&gt;</span> {
      props.changeCheckedCartItems(selectedRowKeys);
    },
  };
  <span class="hljs-keyword">let</span> totalCount: number = props.cart
    .filter(<span class="hljs-function">(<span class="hljs-params">item: CartItem</span>) =&gt;</span> item.checked)
    .reduce(<span class="hljs-function">(<span class="hljs-params">total: number, item: CartItem</span>) =&gt;</span> total + item.count, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">let</span> totalPrice = props.cart
    .filter(<span class="hljs-function">(<span class="hljs-params">item: CartItem</span>) =&gt;</span> item.checked)
    .reduce(
      <span class="hljs-function">(<span class="hljs-params">total: number, item: CartItem</span>) =&gt;</span>
        total + <span class="hljs-built_in">parseFloat</span>(item.lesson.price.replace(<span class="hljs-regexp">/[^0-9\.]/g</span>,<span class="hljs-string">''</span>)) * item.count,
      <span class="hljs-number">0</span>
    );
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">NavHeader</span> <span class="hljs-attr">history</span>=<span class="hljs-string">{props.history}</span>&gt;</span>购物车<span class="hljs-tag">&lt;/<span class="hljs-name">NavHeader</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Table</span>
        <span class="hljs-attr">rowKey</span>=<span class="hljs-string">{(row:any)</span> =&gt;</span> row.lesson.id}
        rowSelection={rowSelection}
        columns={columns}
        dataSource={props.cart}
        pagination={false}
        size="small"
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">Row</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">5px</span>" }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{4}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{props.clearCartItems}</span>&gt;</span>
            清空
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{9}</span>&gt;</span>
          已经选择{totalCount &gt; 0 ? <span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{totalCount}</span> /&gt;</span> : 0}件商品
        <span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{7}</span>&gt;</span>总价: ¥{totalPrice}元<span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{4}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{confirmSettle}</span>&gt;</span>
            去结算
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Row</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Modal</span>
        <span class="hljs-attr">title</span>=<span class="hljs-string">"去结算"</span>
        <span class="hljs-attr">visible</span>=<span class="hljs-string">{settleVisible}</span>
        <span class="hljs-attr">onOk</span>=<span class="hljs-string">{handleOk}</span>
        <span class="hljs-attr">onCancel</span>=<span class="hljs-string">{handleCancel}</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>请问你是否要结算?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
<span class="hljs-keyword">let</span> mapStateToProps = (state: CombinedState): <span class="hljs-function"><span class="hljs-params">CombinedState</span> =&gt;</span> state;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(mapStateToProps, actions)(Cart);
</code></pre>
<p><a href="https://gitee.com/zhufengpeixun/zhufengketang-client/">https://gitee.com/zhufengpeixun/zhufengketang-client/</a></p>

    